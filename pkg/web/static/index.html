<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>k13d - kube-ai-dashboard</title>
    <!-- IBM Plex fonts for professional, formal appearance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- xterm.js for terminal (local for air-gapped environments) -->
    <link rel="stylesheet" href="vendor/xterm.css" />
    <script src="vendor/xterm.min.js"></script>
    <script src="vendor/xterm-addon-fit.min.js"></script>
    <!-- Chart.js for metrics -->
    <script src="vendor/chart.umd.min.js"></script>
    <!-- ansi_up for log coloring -->
    <script src="vendor/ansi_up.min.js"></script>
    <!-- marked for markdown rendering -->
    <script src="vendor/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Typography */
            --font-sans: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-mono: 'IBM Plex Mono', 'SF Mono', 'Monaco', 'Consolas', monospace;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            /* Colors */
            --bg-primary: #1a1b26;
            --bg-secondary: #24283b;
            --bg-tertiary: #414868;
            --text-primary: #c0caf5;
            --text-secondary: #a9b1d6;
            --accent-blue: #7aa2f7;
            --accent-green: #9ece6a;
            --accent-red: #f7768e;
            --accent-yellow: #e0af68;
            --accent-purple: #bb9af7;
            --accent-cyan: #7dcfff;
            --border-color: #414868;
        }

        body {
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
            font-weight: 400;
            letter-spacing: 0.01em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Monospace font for code/terminal elements */
        code, pre, .terminal, .log-content, .yaml-content, .json-content {
            font-family: 'IBM Plex Mono', 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        /* Login Page - Beautiful animated design */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0d1117 0%, #161b22 50%, #0d1117 100%);
            position: relative;
            overflow: hidden;
        }

        /* Animated background particles */
        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(circle at 20% 80%, rgba(122, 162, 247, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(187, 154, 247, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(125, 211, 252, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 60% 60%, rgba(52, 211, 153, 0.05) 0%, transparent 40%);
            animation: loginBgPulse 8s ease-in-out infinite;
        }

        @keyframes loginBgPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        /* Floating Kubernetes icons */
        .login-container::after {
            content: 'âŽˆ';
            position: absolute;
            font-size: 300px;
            color: rgba(50, 108, 229, 0.03);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: floatIcon 20s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes floatIcon {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            50% { transform: translate(-50%, -50%) rotate(180deg); }
        }

        .login-box {
            background: rgba(22, 27, 34, 0.9);
            backdrop-filter: blur(20px);
            padding: 48px 40px;
            border-radius: 20px;
            border: 1px solid rgba(122, 162, 247, 0.2);
            width: 100%;
            max-width: 440px;
            position: relative;
            z-index: 1;
            box-shadow:
                0 0 60px rgba(122, 162, 247, 0.1),
                0 25px 50px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            animation: loginBoxAppear 0.6s ease-out;
        }

        @keyframes loginBoxAppear {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* ASCII Art Logo */
        .login-ascii-logo {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            line-height: 1.1;
            color: var(--accent-blue);
            text-align: center;
            margin-bottom: 8px;
            white-space: pre;
            text-shadow: 0 0 20px rgba(122, 162, 247, 0.5);
            animation: logoGlow 3s ease-in-out infinite;
        }

        @keyframes logoGlow {
            0%, 100% { text-shadow: 0 0 20px rgba(122, 162, 247, 0.5); }
            50% { text-shadow: 0 0 30px rgba(122, 162, 247, 0.8), 0 0 60px rgba(122, 162, 247, 0.3); }
        }

        .login-subtitle {
            text-align: center;
            margin-bottom: 32px;
            color: var(--text-secondary);
            font-size: 14px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .login-subtitle span {
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }

        .login-box h1 {
            display: none; /* Hidden, using ASCII art instead */
        }

        .login-box input {
            width: 100%;
            padding: 14px 16px;
            margin-bottom: 16px;
            background: rgba(13, 17, 23, 0.8);
            border: 1px solid rgba(122, 162, 247, 0.2);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .login-box input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(122, 162, 247, 0.15), 0 0 20px rgba(122, 162, 247, 0.1);
            background: rgba(13, 17, 23, 1);
        }

        .login-box input::placeholder {
            color: var(--text-muted);
        }

        .login-box button.login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            color: #ffffff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .login-box button.login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .login-box button.login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(122, 162, 247, 0.3);
        }

        .login-box button.login-btn:hover::before {
            left: 100%;
        }

        .login-box button.login-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(122, 162, 247, 0.3), 0 10px 30px rgba(122, 162, 247, 0.3);
        }

        .login-box button.login-btn:active {
            transform: translateY(0);
        }

        .login-error {
            color: var(--accent-red);
            text-align: center;
            margin-bottom: 16px;
            font-size: 13px;
            padding: 10px;
            background: rgba(247, 118, 142, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(247, 118, 142, 0.2);
        }

        .login-error:empty {
            display: none;
        }

        /* Login tabs styling */
        .login-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .login-tab {
            flex: 1;
            padding: 10px;
            background: rgba(13, 17, 23, 0.5);
            border: 1px solid rgba(122, 162, 247, 0.1);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .login-tab:hover {
            background: rgba(122, 162, 247, 0.1);
            border-color: rgba(122, 162, 247, 0.2);
        }

        .login-tab.active {
            background: rgba(122, 162, 247, 0.15);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        /* Team Branding */
        .team-branding {
            text-align: center;
            margin-bottom: 16px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .team-cloud {
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .team-divider {
            color: var(--text-muted);
            opacity: 0.5;
        }

        .team-kubeai {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        /* Auth Mode Indicator */
        .auth-mode-indicator {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 12px;
            display: none;
        }

        .auth-mode-indicator.token-mode {
            display: block;
            background: rgba(158, 206, 106, 0.1);
            border: 1px solid rgba(158, 206, 106, 0.2);
            color: var(--accent-green);
        }

        .auth-mode-indicator.local-mode {
            display: block;
            background: rgba(122, 162, 247, 0.1);
            border: 1px solid rgba(122, 162, 247, 0.2);
            color: var(--accent-blue);
        }

        /* Token Help Box - Collapsible */
        .token-help-box {
            background: rgba(13, 17, 23, 0.6);
            border: 1px solid rgba(122, 162, 247, 0.15);
            border-radius: 10px;
            margin-top: 12px;
            text-align: left;
            overflow: hidden;
        }

        .token-help-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .token-help-toggle:hover {
            background: rgba(122, 162, 247, 0.1);
        }

        .token-help-toggle-text {
            font-weight: 600;
            color: var(--accent-cyan);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .token-help-toggle-icon {
            font-size: 10px;
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }

        .token-help-box.expanded .token-help-toggle-icon {
            transform: rotate(180deg);
        }

        .token-help-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0 14px;
        }

        .token-help-box.expanded .token-help-content {
            max-height: 400px;
            padding: 0 14px 14px 14px;
        }

        .token-help-title {
            font-weight: 600;
            color: var(--accent-cyan);
            margin-bottom: 12px;
            font-size: 12px;
        }

        .token-help-step {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            font-size: 11px;
            line-height: 1.5;
        }

        .token-help-step .step-num {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .token-help-step code {
            display: block;
            background: rgba(0, 0, 0, 0.3);
            padding: 6px 10px;
            border-radius: 6px;
            margin-top: 4px;
            font-size: 10px;
            color: var(--accent-green);
            word-break: break-all;
        }

        .token-help-note {
            background: rgba(224, 175, 104, 0.1);
            border: 1px solid rgba(224, 175, 104, 0.2);
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 11px;
            color: var(--accent-yellow);
            margin-top: 8px;
        }

        /* Local Login Hint */
        .local-login-hint {
            text-align: center;
            margin-bottom: 16px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* Login Footer */
        .login-footer {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(122, 162, 247, 0.1);
        }

        /* Kubernetes badge */
        .login-k8s-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--text-muted);
            font-size: 11px;
        }

        .login-k8s-badge svg {
            width: 16px;
            height: 16px;
            opacity: 0.5;
        }

        .login-version {
            text-align: center;
            margin-top: 12px;
            font-size: 10px;
            color: var(--text-muted);
        }

        .login-version strong {
            color: var(--accent-cyan);
        }

        /* Main App Container */
        .app-container {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: linear-gradient(180deg, var(--bg-primary) 0%, #12131a 100%);
        }

        .app-container.active {
            display: flex;
            animation: appFadeIn 0.5s ease-out;
        }

        @keyframes appFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Top Bar - Premium gradient design */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(36, 40, 59, 0.95) 0%, rgba(26, 27, 38, 0.98) 100%);
            border-bottom: 1px solid rgba(122, 162, 247, 0.15);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 100;
        }

        .top-bar::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(122, 162, 247, 0.3), rgba(187, 154, 247, 0.3), transparent);
        }

        .logo {
            font-family: var(--font-mono);
            font-size: 20px;
            font-weight: var(--font-weight-bold);
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-cyan) 50%, var(--accent-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.02em;
            text-transform: lowercase;
            text-shadow: 0 0 30px rgba(122, 162, 247, 0.3);
        }

        .logo::before {
            content: 'âŽˆ';
            -webkit-text-fill-color: var(--accent-blue);
            font-size: 24px;
            animation: logoSpin 20s linear infinite;
        }

        @keyframes logoSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-badge {
            background: linear-gradient(135deg, rgba(122, 162, 247, 0.15) 0%, rgba(187, 154, 247, 0.15) 100%);
            border: 1px solid rgba(122, 162, 247, 0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: var(--font-weight-medium);
            letter-spacing: 0.02em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .user-badge::before {
            content: 'ðŸ‘¤';
            font-size: 12px;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid rgba(247, 118, 142, 0.3);
            color: var(--accent-red);
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: rgba(247, 118, 142, 0.1);
            border-color: var(--accent-red);
            transform: translateY(-1px);
        }

        /* Header Team Badge */
        .header-team-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 16px;
            padding: 4px 12px;
            background: rgba(125, 211, 252, 0.1);
            border: 1px solid rgba(125, 211, 252, 0.2);
            border-radius: 20px;
            font-size: 11px;
        }

        .header-team-cloud {
            font-size: 12px;
        }

        .header-team-text {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }

        /* Main Content */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar - Premium glass design */
        .sidebar {
            width: 240px;
            min-width: 200px;
            background: linear-gradient(180deg, rgba(36, 40, 59, 0.8) 0%, rgba(26, 27, 38, 0.9) 100%);
            border-right: 1px solid rgba(122, 162, 247, 0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }

        /* Scrollbar styling */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(122, 162, 247, 0.3);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(122, 162, 247, 0.5);
        }

        .nav-section {
            padding: 16px 12px;
        }

        .nav-title {
            font-size: 10px;
            font-weight: var(--font-weight-bold);
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 10px;
            letter-spacing: 0.15em;
            padding-left: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-title::before {
            content: '';
            width: 3px;
            height: 12px;
            background: linear-gradient(180deg, var(--accent-blue), var(--accent-purple));
            border-radius: 2px;
        }

        .nav-item {
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            margin-bottom: 4px;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: linear-gradient(90deg, rgba(122, 162, 247, 0.2), transparent);
            transition: width 0.3s ease;
        }

        .nav-item:hover {
            background: rgba(65, 72, 104, 0.5);
            border-color: rgba(122, 162, 247, 0.1);
            transform: translateX(4px);
        }

        .nav-item:hover::before {
            width: 100%;
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(122, 162, 247, 0.2) 0%, rgba(187, 154, 247, 0.15) 100%);
            border-color: rgba(122, 162, 247, 0.3);
            color: var(--accent-blue);
            box-shadow: 0 4px 15px rgba(122, 162, 247, 0.1);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            right: 10px;
            width: 6px;
            height: 6px;
            background: var(--accent-blue);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--accent-blue);
        }

        .nav-item .count {
            background: rgba(65, 72, 104, 0.8);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            min-width: 28px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .nav-item:hover .count {
            background: rgba(122, 162, 247, 0.2);
            color: var(--accent-blue);
        }

        .nav-item.active .count {
            background: rgba(122, 162, 247, 0.3);
            color: var(--accent-blue);
        }

        /* Resizable Panels */
        .content-wrapper {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .main-panel {
            flex: 1;
            min-width: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: linear-gradient(180deg, rgba(26, 27, 38, 0.5) 0%, rgba(18, 19, 26, 0.8) 100%);
        }

        .resize-handle {
            width: 4px;
            background: linear-gradient(180deg, rgba(122, 162, 247, 0.1), rgba(187, 154, 247, 0.1));
            cursor: col-resize;
            transition: all 0.3s ease;
            position: relative;
        }

        .resize-handle::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 40px;
            background: rgba(122, 162, 247, 0.3);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .resize-handle:hover {
            background: linear-gradient(180deg, rgba(122, 162, 247, 0.2), rgba(187, 154, 247, 0.2));
        }

        .resize-handle:hover::before {
            background: var(--accent-blue);
            box-shadow: 0 0 10px var(--accent-blue);
            height: 60px;
        }

        .ai-panel {
            width: 400px;
            min-width: 300px;
            max-width: 600px;
            background: linear-gradient(180deg, rgba(36, 40, 59, 0.95) 0%, rgba(26, 27, 38, 0.98) 100%);
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(187, 154, 247, 0.1);
            position: relative;
        }

        .ai-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 1px;
            background: linear-gradient(180deg, rgba(187, 154, 247, 0.3), transparent, rgba(122, 162, 247, 0.3));
        }

        /* Main Panel Header - Enhanced */
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            border-bottom: 1px solid rgba(122, 162, 247, 0.1);
            background: linear-gradient(90deg, rgba(36, 40, 59, 0.8) 0%, rgba(26, 27, 38, 0.9) 100%);
            backdrop-filter: blur(10px);
        }

        .panel-title {
            font-size: 15px;
            font-weight: var(--font-weight-semibold);
            letter-spacing: 0.02em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .resource-summary {
            display: inline-flex;
            gap: 8px;
            margin-left: 12px;
            font-size: 12px;
            font-weight: 400;
            color: var(--text-secondary);
        }

        .resource-summary .summary-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: rgba(26, 27, 38, 0.6);
            border-radius: 4px;
        }

        .resource-summary .summary-count {
            font-weight: 600;
            color: var(--text-primary);
        }

        .resource-summary .status-running { color: var(--accent-green); }
        .resource-summary .status-pending { color: var(--accent-yellow); }
        .resource-summary .status-failed { color: var(--accent-red); }
        .resource-summary .status-succeeded { color: var(--accent-cyan); }
        .resource-summary .status-unknown { color: var(--text-secondary); }

        .panel-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .namespace-select {
            background: rgba(26, 27, 38, 0.8);
            border: 1px solid rgba(122, 162, 247, 0.2);
            border-radius: 8px;
            padding: 8px 14px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .namespace-select:hover {
            border-color: rgba(122, 162, 247, 0.4);
            background: rgba(26, 27, 38, 1);
        }

        .namespace-select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(122, 162, 247, 0.1);
        }

        .refresh-btn {
            background: linear-gradient(135deg, rgba(122, 162, 247, 0.1) 0%, rgba(125, 207, 255, 0.1) 100%);
            border: 1px solid rgba(122, 162, 247, 0.2);
            padding: 8px 14px;
            border-radius: 8px;
            color: var(--accent-cyan);
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .refresh-btn:hover {
            background: linear-gradient(135deg, rgba(122, 162, 247, 0.2) 0%, rgba(125, 207, 255, 0.2) 100%);
            border-color: var(--accent-cyan);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(125, 207, 255, 0.2);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        /* Table - Modern glass design */
        .table-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: rgba(26, 27, 38, 0.5);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: rgba(122, 162, 247, 0.3);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: rgba(122, 162, 247, 0.5);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 13px;
            font-feature-settings: 'tnum' 1;
            background: rgba(36, 40, 59, 0.4);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        th {
            background: linear-gradient(180deg, rgba(65, 72, 104, 0.6) 0%, rgba(36, 40, 59, 0.8) 100%);
            padding: 14px 16px;
            text-align: left;
            font-weight: var(--font-weight-bold);
            color: var(--text-secondary);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(122, 162, 247, 0.1);
        }

        th:hover {
            background: linear-gradient(180deg, rgba(122, 162, 247, 0.2) 0%, rgba(36, 40, 59, 0.9) 100%);
            color: var(--accent-blue);
        }

        th .sort-icon {
            margin-left: 6px;
            opacity: 0.5;
            font-size: 10px;
            transition: opacity 0.2s ease;
        }

        th:hover .sort-icon {
            opacity: 0.8;
        }

        th.sort-asc .sort-icon::after { content: 'â–²'; opacity: 1; color: var(--accent-blue); }
        th.sort-desc .sort-icon::after { content: 'â–¼'; opacity: 1; color: var(--accent-blue); }
        th:not(.sort-asc):not(.sort-desc) .sort-icon::after { content: 'â‡…'; }

        /* Pagination - Modern design */
        .pagination-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: linear-gradient(90deg, rgba(36, 40, 59, 0.8) 0%, rgba(26, 27, 38, 0.9) 100%);
            border-top: 1px solid rgba(122, 162, 247, 0.1);
            font-size: 12px;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-btn {
            padding: 6px 14px;
            background: rgba(65, 72, 104, 0.5);
            border: 1px solid rgba(122, 162, 247, 0.2);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-cyan) 100%);
            border-color: transparent;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(122, 162, 247, 0.3);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .page-size-select {
            padding: 6px 12px;
            background: rgba(26, 27, 38, 0.8);
            border: 1px solid rgba(122, 162, 247, 0.2);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .page-size-select:hover {
            border-color: rgba(122, 162, 247, 0.4);
        }

        .page-size-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(65, 72, 104, 0.3);
            transition: all 0.15s ease;
        }

        tr {
            transition: all 0.2s ease;
        }

        tr:hover {
            background: linear-gradient(90deg, rgba(122, 162, 247, 0.08) 0%, rgba(187, 154, 247, 0.05) 100%);
        }

        tr:hover td {
            border-bottom-color: rgba(122, 162, 247, 0.2);
        }

        /* Status badges with glow effects */
        .status-running, .status-active, .status-ready {
            color: var(--accent-green);
            text-shadow: 0 0 10px rgba(158, 206, 106, 0.5);
        }
        .status-pending {
            color: var(--accent-yellow);
            text-shadow: 0 0 10px rgba(224, 175, 104, 0.5);
        }
        .status-failed, .status-error {
            color: var(--accent-red);
            text-shadow: 0 0 10px rgba(247, 118, 142, 0.5);
        }

        /* Row selection animation */
        tr.selected {
            background: linear-gradient(90deg, rgba(122, 162, 247, 0.15) 0%, rgba(187, 154, 247, 0.1) 100%);
            box-shadow: inset 3px 0 0 var(--accent-blue);
        }

        /* AI Panel - Premium design */
        .ai-header {
            padding: 14px 18px;
            border-bottom: 1px solid rgba(187, 154, 247, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(90deg, rgba(187, 154, 247, 0.08) 0%, rgba(122, 162, 247, 0.05) 100%);
        }

        .ai-header-title {
            font-size: 14px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .ai-badge {
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-blue) 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: bold;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(187, 154, 247, 0.3);
        }

        .ai-status-dot {
            font-size: 12px;
            margin-left: 4px;
            animation: pulse 2s infinite;
        }

        .ai-status-dot.connected {
            color: var(--accent-green);
            animation: none;
            text-shadow: 0 0 8px var(--accent-green);
        }

        .ai-status-dot.disconnected {
            color: var(--accent-red);
            animation: none;
            text-shadow: 0 0 8px var(--accent-red);
        }

        .ai-status-dot.checking {
            color: var(--accent-yellow);
            text-shadow: 0 0 8px var(--accent-yellow);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .ai-messages {
            flex: 1;
            overflow-y: auto;
            padding: 18px;
            background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.1) 100%);
        }

        .ai-messages::-webkit-scrollbar {
            width: 6px;
        }

        .ai-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .ai-messages::-webkit-scrollbar-thumb {
            background: rgba(187, 154, 247, 0.3);
            border-radius: 3px;
        }

        .message {
            margin-bottom: 18px;
            animation: messageAppear 0.3s ease-out;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            text-align: right;
        }

        .message-content {
            display: inline-block;
            padding: 12px 16px;
            border-radius: 16px;
            max-width: 90%;
            font-size: 13px;
            line-height: 1.6;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-cyan) 100%);
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 15px rgba(122, 162, 247, 0.3);
        }

        .message.assistant .message-content {
            background: rgba(65, 72, 104, 0.6);
            border: 1px solid rgba(187, 154, 247, 0.1);
            border-bottom-left-radius: 4px;
            backdrop-filter: blur(5px);
        }

        .message-content pre {
            background: rgba(26, 27, 38, 0.8);
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            overflow-x: auto;
            font-size: 12px;
            border: 1px solid rgba(122, 162, 247, 0.1);
        }

        .message-content .resource-link {
            color: var(--accent-cyan);
            text-decoration: none;
            background: rgba(125, 211, 252, 0.1);
            padding: 1px 4px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .message-content .resource-link:hover {
            background: rgba(125, 211, 252, 0.25);
            text-decoration: underline;
        }

        .ai-input-container {
            padding: 18px;
            border-top: 1px solid rgba(187, 154, 247, 0.15);
            background: linear-gradient(180deg, rgba(36, 40, 59, 0.5) 0%, rgba(26, 27, 38, 0.8) 100%);
        }

        .ai-input {
            width: 100%;
            background: rgba(26, 27, 38, 0.8);
            border: 1px solid rgba(187, 154, 247, 0.2);
            border-radius: 12px;
            padding: 14px 16px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            resize: none;
            transition: all 0.2s ease;
        }

        .ai-input:focus {
            outline: none;
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 3px rgba(187, 154, 247, 0.1), 0 0 20px rgba(187, 154, 247, 0.1);
            background: rgba(26, 27, 38, 1);
        }

        .ai-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .ai-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
        }

        .ai-hint {
            font-size: 11px;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        .send-btn {
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-blue) 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(187, 154, 247, 0.3);
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(187, 154, 247, 0.4);
        }

        .send-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Tabs - Modern pill design */
        .tabs {
            display: flex;
            gap: 6px;
            padding: 12px 20px;
            background: linear-gradient(90deg, rgba(36, 40, 59, 0.6) 0%, rgba(26, 27, 38, 0.8) 100%);
            border-bottom: 1px solid rgba(122, 162, 247, 0.1);
        }

        .tab {
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .tab:hover {
            background: rgba(122, 162, 247, 0.1);
            color: var(--text-primary);
        }

        .tab.active {
            background: linear-gradient(135deg, rgba(122, 162, 247, 0.15) 0%, rgba(125, 207, 255, 0.1) 100%);
            color: var(--accent-blue);
            border-color: rgba(122, 162, 247, 0.3);
            box-shadow: 0 2px 10px rgba(122, 162, 247, 0.1);
        }

        /* Settings Modal - Premium glass design */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
            animation: modalOverlayAppear 0.2s ease-out;
        }

        @keyframes modalOverlayAppear {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: linear-gradient(180deg, rgba(36, 40, 59, 0.95) 0%, rgba(26, 27, 38, 0.98) 100%);
            border-radius: 16px;
            border: 1px solid rgba(122, 162, 247, 0.2);
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 60px rgba(122, 162, 247, 0.1);
            animation: modalAppear 0.3s ease-out;
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(122, 162, 247, 0.15);
            background: linear-gradient(90deg, rgba(122, 162, 247, 0.05) 0%, transparent 100%);
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-close {
            background: rgba(247, 118, 142, 0.1);
            border: 1px solid rgba(247, 118, 142, 0.2);
            color: var(--accent-red);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(247, 118, 142, 0.2);
            transform: scale(1.05);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 14px;
            background: rgba(26, 27, 38, 0.8);
            border: 1px solid rgba(122, 162, 247, 0.2);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(122, 162, 247, 0.1);
            background: rgba(26, 27, 38, 1);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px 24px;
            border-top: 1px solid rgba(122, 162, 247, 0.15);
            background: linear-gradient(90deg, transparent 0%, rgba(122, 162, 247, 0.03) 100%);
        }

        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-cyan) 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(122, 162, 247, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(122, 162, 247, 0.4);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid rgba(122, 162, 247, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(122, 162, 247, 0.1);
            border-color: var(--accent-blue);
        }

        /* Add button with + icon */
        .btn-add {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px dashed var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            transition: all 0.2s;
        }

        .btn-add:hover {
            background: var(--accent-blue);
            color: var(--bg-primary);
            border-style: solid;
            border-color: var(--accent-blue);
        }

        .btn-add .plus-icon {
            font-size: 16px;
            font-weight: bold;
            line-height: 1;
        }

        /* Loading */
        .loading-dots {
            display: flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 6px;
            height: 6px;
            background: var(--accent-blue);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Health Indicator - With glow effects */
        .health-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 500;
        }

        .health-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            position: relative;
        }

        .health-dot::after {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border-radius: 50%;
            animation: healthPulse 2s ease-in-out infinite;
        }

        @keyframes healthPulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 0.2; transform: scale(1.3); }
        }

        .health-dot.ok {
            background: var(--accent-green);
            box-shadow: 0 0 10px var(--accent-green);
        }
        .health-dot.ok::after {
            background: var(--accent-green);
        }

        .health-dot.warning {
            background: var(--accent-yellow);
            box-shadow: 0 0 10px var(--accent-yellow);
        }
        .health-dot.warning::after {
            background: var(--accent-yellow);
        }

        .health-dot.error {
            background: var(--accent-red);
            box-shadow: 0 0 10px var(--accent-red);
        }
        .health-dot.error::after {
            background: var(--accent-red);
        }

        /* Decision Required Modal */
        .approval-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .approval-box {
            background: var(--bg-secondary);
            border: 2px solid var(--accent-yellow);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            animation: slideIn 0.2s ease-out;
        }

        .approval-box.dangerous {
            border-color: var(--accent-red);
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .approval-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .approval-icon {
            font-size: 32px;
        }

        .approval-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--accent-yellow);
        }

        .approval-box.dangerous .approval-title {
            color: var(--accent-red);
        }

        .approval-command {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            font-family: monospace;
            font-size: 13px;
            margin: 16px 0;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .approval-category {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .approval-category.write {
            background: var(--accent-yellow);
            color: var(--bg-primary);
        }

        .approval-category.dangerous {
            background: var(--accent-red);
            color: white;
        }

        .approval-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .approval-buttons button {
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-approve {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .btn-approve:hover {
            filter: brightness(1.1);
        }

        .btn-reject {
            background: var(--accent-red);
            color: white;
        }

        .btn-reject:hover {
            filter: brightness(1.1);
        }

        /* Tool Execution Indicator */
        .tool-execution {
            background: var(--bg-tertiary);
            border-left: 3px solid var(--accent-cyan);
            padding: 12px;
            margin: 8px 0;
            border-radius: 0 4px 4px 0;
            font-size: 13px;
        }

        .tool-execution .tool-name {
            color: var(--accent-cyan);
            font-weight: bold;
            font-size: 12px;
        }

        .tool-execution .tool-command {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            color: var(--accent-green);
            margin-top: 4px;
        }

        .tool-execution .tool-result-preview,
        .tool-execution .tool-result-full {
            border: 1px solid var(--bg-tertiary);
        }

        .tool-execution button:hover {
            background: var(--accent-blue) !important;
            color: white !important;
        }

        /* Global Search */
        .search-container {
            position: relative;
            margin-right: 16px;
        }

        .global-search {
            width: 300px;
            padding: 8px 12px 8px 36px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
        }

        .global-search:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 14px;
        }

        .search-shortcut {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Global Search Results Dropdown */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .search-results:empty {
            display: none;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            gap: 12px;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: var(--bg-tertiary);
        }

        .search-result-kind {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--accent-blue);
            color: white;
            min-width: 70px;
            text-align: center;
        }

        .search-result-kind.pod { background: var(--accent-green); }
        .search-result-kind.deployment { background: var(--accent-blue); }
        .search-result-kind.service { background: var(--accent-purple); }
        .search-result-kind.configmap { background: var(--accent-yellow); color: #1a1b26; }
        .search-result-kind.secret { background: var(--accent-red); }
        .search-result-kind.node { background: var(--accent-cyan); color: #1a1b26; }
        .search-result-kind.namespace { background: var(--text-secondary); }
        .search-result-kind.statefulset { background: #f7768e; }
        .search-result-kind.daemonset { background: #ff9e64; color: #1a1b26; }
        .search-result-kind.ingress { background: #9ece6a; color: #1a1b26; }

        .search-result-info {
            flex: 1;
            min-width: 0;
        }

        .search-result-name {
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-namespace {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .search-result-status {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-primary);
        }

        .search-result-status.running, .search-result-status.ready, .search-result-status.active {
            color: var(--accent-green);
        }

        .search-result-status.pending, .search-result-status.updating {
            color: var(--accent-yellow);
        }

        .search-result-status.failed, .search-result-status.notready {
            color: var(--accent-red);
        }

        .search-no-results {
            padding: 16px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .search-loading {
            padding: 16px;
            text-align: center;
            color: var(--text-secondary);
        }

        /* Resource Filter */
        .filter-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .filter-input {
            flex: 1;
            max-width: 300px;
            padding: 6px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 12px;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--accent-blue);
            color: var(--bg-primary);
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
        }

        .filter-chip .remove {
            opacity: 0.7;
            font-size: 14px;
        }

        .filter-chip .remove:hover {
            opacity: 1;
        }

        /* Column Filter Row */
        .column-filter-row {
            display: none;
        }

        .column-filter-row.active {
            display: table-row;
        }

        .column-filter-row th {
            padding: 4px 8px;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--accent-blue);
        }

        .column-filter-input {
            width: 100%;
            padding: 4px 6px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 11px;
        }

        .column-filter-input:focus {
            border-color: var(--accent-blue);
            outline: none;
        }

        .column-filter-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        /* Column filter toggle button */
        .filter-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-toggle-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .filter-toggle-btn.active {
            background: var(--accent-blue);
            color: var(--bg-primary);
            border-color: var(--accent-blue);
        }

        /* Active column filters display */
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-left: 8px;
        }

        .column-filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--accent-purple);
            color: white;
            border-radius: 10px;
            font-size: 10px;
        }

        .column-filter-chip .col-name {
            opacity: 0.8;
        }

        .column-filter-chip .remove-col-filter {
            cursor: pointer;
            opacity: 0.7;
            font-size: 12px;
        }

        .column-filter-chip .remove-col-filter:hover {
            opacity: 1;
        }

        /* Resource Detail Modal */
        .detail-modal {
            max-width: 900px;
            max-height: 90vh;
        }

        .detail-tabs {
            display: flex;
            gap: 4px;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-tab {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            border: none;
            background: transparent;
        }

        .detail-tab:hover {
            background: var(--bg-tertiary);
        }

        .detail-tab.active {
            background: var(--accent-blue);
            color: var(--bg-primary);
        }

        .detail-content {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .yaml-viewer {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            font-size: 12px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre;
        }

        .property-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 8px;
        }

        .property-label {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .property-value {
            font-size: 12px;
        }

        /* Resource Overview Styles */
        .resource-overview-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .overview-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .overview-status-badge .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .overview-roles {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .role-badge {
            padding: 3px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .overview-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .overview-cards {
                grid-template-columns: 1fr;
            }
        }

        .overview-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 14px;
        }

        .overview-card-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .overview-card-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .overview-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .overview-stat .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .overview-stat .stat-value {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .overview-progress {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .overview-progress .progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .image-tag {
            font-family: monospace;
            font-size: 11px;
            padding: 6px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            word-break: break-all;
            color: var(--accent-blue);
        }

        .ports-list {
            font-family: monospace;
            font-size: 12px;
            padding: 6px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            color: var(--text-primary);
        }

        .overview-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        /* Keyboard shortcuts modal */
        .shortcuts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
        }

        .shortcut-key {
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Table row clickable */
        tbody tr {
            cursor: pointer;
        }

        tbody tr:hover {
            background: var(--bg-tertiary);
        }

        /* Context switcher */
        .context-switcher {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 12px;
        }

        .context-icon {
            color: var(--accent-green);
        }

        /* Action buttons */
        .action-btn {
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 11px;
        }

        .action-btn:hover {
            background: var(--accent-blue);
            color: var(--bg-primary);
        }

        .action-btn.danger:hover {
            background: var(--accent-red);
        }

        /* Hamburger menu button */
        .hamburger-btn {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            width: 24px;
            height: 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-right: 12px;
        }

        .hamburger-btn span {
            display: block;
            width: 100%;
            height: 2px;
            background: var(--text-primary);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .hamburger-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }

        /* Sidebar collapsed state */
        .sidebar.collapsed {
            width: 0;
            min-width: 0;
            padding: 0;
            overflow: hidden;
        }

        .sidebar-transition {
            transition: width 0.3s ease, min-width 0.3s ease, padding 0.3s ease;
        }

        /* Token login styles */
        .login-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .login-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.2s;
            outline: none;
        }

        .login-tab.active {
            color: var(--accent-blue);
            border-bottom: 2px solid var(--accent-blue);
            background: transparent;
        }

        .login-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .login-tab:focus {
            background: var(--bg-tertiary);
            color: var(--accent-blue);
            box-shadow: inset 0 0 0 2px var(--accent-blue);
        }

        .login-tab.active:focus {
            background: rgba(122, 162, 247, 0.1);
            color: var(--accent-blue);
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .login-form input[type="text"],
        .login-form input[type="password"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            background: var(--bg-primary) !important;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary) !important;
            font-size: 14px;
            -webkit-text-fill-color: var(--text-primary) !important;
        }

        .login-form input[type="text"]:focus,
        .login-form input[type="password"]:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: var(--bg-primary) !important;
            color: var(--text-primary) !important;
            -webkit-text-fill-color: var(--text-primary) !important;
        }

        /* Override browser autofill styles */
        .login-form input:-webkit-autofill,
        .login-form input:-webkit-autofill:hover,
        .login-form input:-webkit-autofill:focus,
        .login-form input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px var(--bg-primary) inset !important;
            -webkit-text-fill-color: var(--text-primary) !important;
            background-color: var(--bg-primary) !important;
            color: var(--text-primary) !important;
            caret-color: var(--text-primary) !important;
        }

        .login-form input::placeholder {
            color: var(--text-secondary);
        }

        .token-input {
            width: 100%;
            height: 120px;
            padding: 12px;
            margin-bottom: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'SF Mono', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .token-hint {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .token-hint code {
            display: block;
            margin-top: 8px;
            padding: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            font-size: 11px;
            word-break: break-all;
        }

        /* Add to context button */
        .add-context-btn {
            padding: 2px 5px;
            background: var(--accent-purple);
            border: none;
            border-radius: 3px;
            color: var(--bg-primary);
            cursor: pointer;
            font-size: 9px;
            margin-left: 2px;
            vertical-align: middle;
        }

        .add-context-btn:hover {
            opacity: 0.9;
        }

        /* Context chips in AI panel */
        .context-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-color);
            min-height: 40px;
        }

        .context-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--accent-purple);
            color: var(--bg-primary);
            border-radius: 12px;
            font-size: 11px;
        }

        .context-chip .remove {
            cursor: pointer;
            opacity: 0.7;
        }

        .context-chip .remove:hover {
            opacity: 1;
        }

        /* Debug panel styles */
        .debug-panel {
            display: none;
            border-top: 1px solid var(--border-color);
            background: var(--bg-primary);
            max-height: 200px;
            overflow-y: auto;
        }

        .debug-panel.active {
            display: block;
        }

        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            font-size: 11px;
            font-weight: bold;
        }

        .debug-toggle {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
        }

        .debug-content {
            padding: 8px 12px;
            font-size: 11px;
            font-family: 'SF Mono', monospace;
        }

        .debug-entry {
            margin-bottom: 8px;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            border-left: 3px solid var(--accent-blue);
        }

        .debug-entry.request {
            border-left-color: var(--accent-yellow);
        }

        .debug-entry.response {
            border-left-color: var(--accent-green);
        }

        .debug-entry.error {
            border-left-color: var(--accent-red);
        }

        .debug-entry-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            color: var(--text-secondary);
        }

        .debug-entry-body {
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
        }

        /* SSE Streaming styles */
        .message.streaming .message-content {
            border-left: 2px solid var(--accent-blue);
            padding-left: 12px;
        }

        .message.streaming .cursor {
            display: inline-block;
            animation: blink 0.7s infinite;
            color: var(--accent-blue);
            font-weight: bold;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Auto-refresh indicator */
        .auto-refresh-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 16px;
            padding: 4px 12px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 12px;
        }

        .auto-refresh-toggle {
            position: relative;
            width: 36px;
            height: 20px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .auto-refresh-toggle.active {
            background: var(--accent-green);
            border-color: var(--accent-green);
        }

        .auto-refresh-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            background: var(--text-primary);
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .auto-refresh-toggle.active::after {
            left: 18px;
            background: white;
        }

        .refresh-interval-select {
            padding: 2px 6px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 11px;
            cursor: pointer;
        }

        .last-refresh-time {
            color: var(--text-secondary);
            font-size: 11px;
        }

        .refresh-btn {
            padding: 4px 8px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .refresh-btn.spinning svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Settings panel styles */
        .settings-section {
            margin-bottom: 20px;
        }

        .settings-section h4 {
            margin-bottom: 12px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label {
            color: var(--text-primary);
            font-size: 13px;
        }

        .settings-description {
            color: var(--text-secondary);
            font-size: 11px;
            margin-top: 2px;
        }

        /* About page styles */
        .about-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .about-logo {
            font-size: 48px;
            color: var(--accent-blue);
            text-shadow: 0 0 20px rgba(122, 162, 247, 0.4);
        }

        .about-title h2 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .about-tagline {
            margin: 4px 0 0 0;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .about-version-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .about-version-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .about-version-row:last-child {
            border-bottom: none;
        }

        .about-label {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .about-value {
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
        }

        .about-mono {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px;
            color: var(--accent-blue);
        }

        .about-description {
            margin-bottom: 20px;
            line-height: 1.6;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .about-description strong {
            color: var(--text-primary);
        }

        .about-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .about-feature {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .about-feature-icon {
            font-size: 20px;
        }

        .about-feature strong {
            display: block;
            color: var(--text-primary);
            font-size: 12px;
            margin-bottom: 2px;
        }

        .about-feature p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 11px;
        }

        .about-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .about-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .about-link:hover {
            border-color: var(--accent-blue);
            background: rgba(122, 162, 247, 0.1);
        }

        .about-footer {
            text-align: center;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .about-footer p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .about-license {
            margin-top: 4px !important;
            font-size: 11px !important;
            color: var(--text-muted) !important;
        }

        /* Settings select boxes - dark theme */
        .settings-row select,
        .settings-section select {
            background: rgba(26, 27, 38, 0.9);
            border: 1px solid rgba(122, 162, 247, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 140px;
        }

        .settings-row select:hover,
        .settings-section select:hover {
            border-color: rgba(122, 162, 247, 0.4);
            background: rgba(26, 27, 38, 1);
        }

        .settings-row select:focus,
        .settings-section select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(122, 162, 247, 0.1);
        }

        /* Style select options for dark theme */
        .settings-row select option,
        .settings-section select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 8px;
        }

        /* ==========================================
         * Terminal Modal Styles
         * ========================================== */
        .terminal-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            z-index: 2000;
            padding: 20px;
        }

        .terminal-modal.active {
            display: flex;
            flex-direction: column;
        }

        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px 8px 0 0;
            border: 1px solid var(--border-color);
            border-bottom: none;
        }

        .terminal-title {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terminal-title .pod-name {
            color: var(--accent-green);
        }

        .terminal-title .container-name {
            color: var(--accent-cyan);
            font-size: 12px;
        }

        .terminal-close {
            background: var(--accent-red);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .terminal-body {
            flex: 1;
            background: #1a1b26;
            border: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
            overflow: hidden;
            min-height: 400px;
        }

        .terminal-body .xterm {
            padding: 8px;
            height: 100%;
        }

        /* ==========================================
         * Log Viewer Styles
         * ========================================== */
        .log-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            z-index: 2000;
            padding: 20px;
        }

        .log-viewer-modal.active {
            display: flex;
            flex-direction: column;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px 8px 0 0;
            border: 1px solid var(--border-color);
            border-bottom: none;
        }

        .log-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .log-controls select,
        .log-controls input {
            padding: 4px 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 12px;
        }

        .log-controls button {
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .log-controls button.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .log-body {
            flex: 1;
            background: #0d1117;
            border: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
            overflow: auto;
            font-family: 'IBM Plex Mono', 'SF Mono', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.6;
            padding: 0;
            min-height: 400px;
            counter-reset: log-line-number;
        }

        .log-line {
            display: flex;
            padding: 4px 12px 4px 0;
            border-bottom: 1px solid rgba(65, 72, 104, 0.3);
            transition: background 0.15s ease;
            counter-increment: log-line-number;
        }

        .log-line:hover {
            background: rgba(122, 162, 247, 0.08);
        }

        .log-line:nth-child(even) {
            background: rgba(36, 40, 59, 0.3);
        }

        .log-line:nth-child(even):hover {
            background: rgba(122, 162, 247, 0.12);
        }

        .log-line::before {
            content: counter(log-line-number);
            min-width: 50px;
            padding: 0 12px;
            text-align: right;
            color: rgba(169, 177, 214, 0.4);
            font-size: 11px;
            border-right: 1px solid rgba(65, 72, 104, 0.4);
            margin-right: 12px;
            user-select: none;
            flex-shrink: 0;
        }

        .log-line-content {
            white-space: pre-wrap;
            word-break: break-all;
            flex: 1;
        }

        .log-line .timestamp {
            color: var(--accent-cyan);
            margin-right: 8px;
            opacity: 0.8;
        }

        .log-line.error {
            background: rgba(247, 118, 142, 0.1);
            border-left: 3px solid var(--accent-red);
        }

        .log-line.error:hover {
            background: rgba(247, 118, 142, 0.18);
        }

        .log-line.error .log-line-content {
            color: var(--accent-red);
        }

        .log-line.warn {
            background: rgba(224, 175, 104, 0.08);
            border-left: 3px solid var(--accent-yellow);
        }

        .log-line.warn:hover {
            background: rgba(224, 175, 104, 0.15);
        }

        .log-line.warn .log-line-content {
            color: var(--accent-yellow);
        }

        /* Multi-pod log colors (k9s style) */
        .log-pod-tag {
            font-size: 10px;
            font-weight: 600;
            padding: 1px 6px;
            border-radius: 3px;
            margin-right: 8px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .log-pod-0 .log-pod-tag { background: rgba(122, 162, 247, 0.3); color: #7aa2f7; }
        .log-pod-1 .log-pod-tag { background: rgba(158, 206, 106, 0.3); color: #9ece6a; }
        .log-pod-2 .log-pod-tag { background: rgba(224, 175, 104, 0.3); color: #e0af68; }
        .log-pod-3 .log-pod-tag { background: rgba(187, 154, 247, 0.3); color: #bb9af7; }
        .log-pod-4 .log-pod-tag { background: rgba(125, 207, 255, 0.3); color: #7dcfff; }
        .log-pod-5 .log-pod-tag { background: rgba(247, 118, 142, 0.3); color: #f7768e; }
        .log-pod-6 .log-pod-tag { background: rgba(115, 218, 202, 0.3); color: #73daca; }
        .log-pod-7 .log-pod-tag { background: rgba(255, 158, 100, 0.3); color: #ff9e64; }

        .log-pod-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }

        .log-pod-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: opacity 0.2s;
        }

        .log-pod-legend-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .log-pod-legend-item.hidden {
            opacity: 0.4;
        }

        .log-pod-legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .log-pod-0 .log-pod-legend-dot, .legend-pod-0 { background: #7aa2f7; }
        .log-pod-1 .log-pod-legend-dot, .legend-pod-1 { background: #9ece6a; }
        .log-pod-2 .log-pod-legend-dot, .legend-pod-2 { background: #e0af68; }
        .log-pod-3 .log-pod-legend-dot, .legend-pod-3 { background: #bb9af7; }
        .log-pod-4 .log-pod-legend-dot, .legend-pod-4 { background: #7dcfff; }
        .log-pod-5 .log-pod-legend-dot, .legend-pod-5 { background: #f7768e; }
        .log-pod-6 .log-pod-legend-dot, .legend-pod-6 { background: #73daca; }
        .log-pod-7 .log-pod-legend-dot, .legend-pod-7 { background: #ff9e64; }

        .log-search {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .log-search input {
            flex: 1;
            padding: 6px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 12px;
        }

        .log-search .match-count {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* ==========================================
         * Metrics Modal Styles
         * ========================================== */
        .metrics-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            z-index: 2000;
            padding: 20px;
        }

        .metrics-modal.active {
            display: flex;
            flex-direction: column;
        }

        .metrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px 8px 0 0;
            border: 1px solid var(--border-color);
            border-bottom: none;
        }

        .metrics-body {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
            overflow: auto;
            padding: 20px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .metric-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
        }

        .metric-card h4 {
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--accent-blue);
        }

        .metric-unit {
            font-size: 14px;
            color: var(--text-secondary);
            margin-left: 4px;
        }

        .metric-chart {
            height: 200px;
            margin-top: 12px;
        }

        .metrics-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .summary-card .label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
        }

        .summary-card .value.cpu { color: var(--accent-cyan); }
        .summary-card .value.memory { color: var(--accent-purple); }
        .summary-card .value.pods { color: var(--accent-green); }
        .summary-card .value.llm { color: var(--accent-yellow); }

        /* Time Range Selector */
        .time-range-selector {
            display: flex;
            gap: 4px;
            margin-right: 12px;
        }

        .time-range-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            transition: all 0.2s;
        }

        .time-range-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-blue);
        }

        .time-range-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: #ffffff;
        }

        /* LLM Usage Widget */
        .llm-usage-widget {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
        }

        .llm-usage-widget h4 {
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .llm-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .llm-stat {
            text-align: center;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .llm-stat .label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .llm-stat .value {
            font-size: 18px;
            font-weight: bold;
            color: var(--accent-yellow);
        }

        .llm-stat .value.tokens { color: var(--accent-green); }
        .llm-stat .value.cost { color: var(--accent-red); }

        /* ==========================================
         * Port Forward Modal Styles
         * ========================================== */
        .portforward-modal {
            max-width: 600px;
        }

        .portforward-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .portforward-form .full-width {
            grid-column: 1 / -1;
        }

        .portforward-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .portforward-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .portforward-item .info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .portforward-item .ports {
            font-size: 14px;
            font-weight: 500;
        }

        .portforward-item .target {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .portforward-item .status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .portforward-item .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .portforward-item .status-dot.active {
            background: var(--accent-green);
        }

        .portforward-item .status-dot.stopped {
            background: var(--accent-red);
        }

        .portforward-item button {
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            border: none;
            background: var(--accent-red);
            color: white;
        }

        /* ==========================================
         * Resource Action Buttons
         * ========================================== */
        .resource-actions {
            display: flex;
            gap: 4px;
        }

        .resource-action-btn {
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            white-space: nowrap;
        }

        .resource-action-btn:hover {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .resource-action-btn.terminal { border-color: var(--accent-green); }
        .resource-action-btn.terminal:hover { background: var(--accent-green); }

        .resource-action-btn.logs { border-color: var(--accent-cyan); }
        .resource-action-btn.logs:hover { background: var(--accent-cyan); }

        .resource-action-btn.portforward { border-color: var(--accent-purple); }
        .resource-action-btn.portforward:hover { background: var(--accent-purple); }

        /* ==========================================
         * AI Action Highlight
         * ========================================== */
        .ai-highlight {
            animation: aiHighlight 2s ease-out;
        }

        @keyframes aiHighlight {
            0% { background: var(--accent-purple); }
            100% { background: transparent; }
        }

        .ai-action-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent-purple);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 3000;
            animation: slideInUp 0.3s ease-out;
        }

        @keyframes slideInUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            15% { opacity: 1; transform: translateX(-50%) translateY(0); }
            85% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }

        /* Command Bar (TUI-style : command mode) */
        .command-bar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5000;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 20vh;
        }

        .command-bar-overlay.active {
            display: flex;
        }

        .command-bar {
            background: var(--bg-secondary);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            width: 500px;
            max-width: 90vw;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            overflow: hidden;
        }

        .command-input-wrapper {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .command-prefix {
            color: var(--accent-blue);
            font-family: var(--font-mono);
            font-size: 16px;
            font-weight: 600;
            margin-right: 4px;
        }

        .command-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 16px;
            outline: none;
        }

        .command-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.5;
        }

        .command-suggestions {
            max-height: 300px;
            overflow-y: auto;
        }

        .command-suggestion {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .command-suggestion:hover,
        .command-suggestion.selected {
            background: var(--bg-tertiary);
        }

        .command-suggestion.selected {
            border-left: 2px solid var(--accent-blue);
        }

        .command-suggestion-name {
            font-family: var(--font-mono);
            color: var(--text-primary);
            font-size: 14px;
        }

        .command-suggestion-desc {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .command-suggestion-shortcut {
            background: var(--bg-primary);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--text-secondary);
        }

        .command-hint {
            padding: 8px 16px;
            font-size: 11px;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 16px;
        }

        .command-hint kbd {
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: var(--font-mono);
            font-size: 10px;
        }

        /* Namespace quick switcher */
        .namespace-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            border: 1px solid var(--accent-purple);
            border-radius: 8px;
            padding: 12px 20px;
            display: none;
            align-items: center;
            gap: 16px;
            z-index: 4000;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .namespace-indicator.active {
            display: flex;
            animation: slideInUp 0.2s ease-out;
        }

        .namespace-key {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.15s ease;
        }

        .namespace-key:hover {
            background: var(--bg-tertiary);
        }

        .namespace-key.current {
            background: var(--accent-purple);
            color: white;
        }

        .namespace-key-num {
            font-family: var(--font-mono);
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-purple);
        }

        .namespace-key.current .namespace-key-num {
            color: white;
        }

        .namespace-key-name {
            font-size: 10px;
            color: var(--text-secondary);
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .namespace-key.current .namespace-key-name {
            color: rgba(255, 255, 255, 0.8);
        }

        /* YAML Editor Modal */
        .yaml-editor-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .yaml-editor-modal.active {
            display: flex;
        }

        .yaml-editor-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            width: 90vw;
            max-width: 1200px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 16px 64px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .yaml-editor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .yaml-editor-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .yaml-editor-title h3 {
            margin: 0;
            font-size: 16px;
            color: var(--text-primary);
        }

        .yaml-editor-badge {
            background: var(--accent-blue);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .yaml-editor-actions {
            display: flex;
            gap: 8px;
        }

        .yaml-editor-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .yaml-editor-btn.primary {
            background: var(--accent-green);
            color: white;
        }

        .yaml-editor-btn.primary:hover {
            background: #8bc65a;
        }

        .yaml-editor-btn.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .yaml-editor-btn.secondary:hover {
            background: var(--border-color);
        }

        .yaml-editor-btn.danger {
            background: var(--accent-red);
            color: white;
        }

        .yaml-editor-btn.danger:hover {
            background: #e5677a;
        }

        .yaml-editor-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .yaml-editor-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .yaml-editor-toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .yaml-editor-toolbar select,
        .yaml-editor-toolbar input {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 10px;
            color: var(--text-primary);
            font-size: 12px;
        }

        .yaml-editor-toolbar label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .yaml-textarea {
            flex: 1;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 13px;
            line-height: 1.6;
            padding: 16px;
            border: none;
            resize: none;
            outline: none;
            tab-size: 2;
        }

        .yaml-textarea::placeholder {
            color: var(--text-secondary);
            opacity: 0.5;
        }

        .yaml-editor-sidebar {
            width: 280px;
            background: var(--bg-primary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .yaml-editor-sidebar-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .yaml-template-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .yaml-template-item {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s ease;
            margin-bottom: 4px;
        }

        .yaml-template-item:hover {
            background: var(--bg-secondary);
        }

        .yaml-template-item-title {
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .yaml-template-item-desc {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .yaml-editor-footer {
            padding: 12px 20px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .yaml-editor-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .yaml-editor-status .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .yaml-editor-status.valid .status-dot {
            background: var(--accent-green);
        }

        .yaml-editor-status.invalid .status-dot {
            background: var(--accent-red);
        }

        .yaml-editor-hints {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .yaml-editor-hints kbd {
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: var(--font-mono);
        }

        /* Chat History Sidebar */
        .chat-history-sidebar {
            position: absolute;
            top: 0;
            right: -280px;
            width: 280px;
            height: 100%;
            background: var(--bg-primary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease;
            z-index: 100;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
        }

        .chat-history-sidebar.open {
            right: 0;
        }

        /* Remove padding approach - use overlay instead */
        .ai-panel.history-open {
            /* No padding needed - sidebar overlays the content */
        }

        .chat-history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .chat-history-header h4 {
            margin: 0;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chat-history-actions {
            display: flex;
            gap: 4px;
        }

        .chat-history-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .chat-history-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .chat-history-btn.primary {
            background: var(--accent-blue);
            color: white;
        }

        .chat-history-btn.primary:hover {
            background: var(--accent-cyan);
        }

        .chat-history-search {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .chat-history-search input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
        }

        .chat-history-search input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .chat-history-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .chat-history-item {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 4px;
            transition: background 0.15s ease;
            position: relative;
        }

        .chat-history-item:hover {
            background: var(--bg-secondary);
        }

        .chat-history-item.active {
            background: var(--accent-blue);
            color: white;
        }

        .chat-history-item.active:hover {
            background: var(--accent-blue);
        }

        .chat-history-title {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-history-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .chat-history-item.active .chat-history-meta {
            color: rgba(255, 255, 255, 0.7);
        }

        .chat-history-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .chat-history-item:hover .chat-history-delete {
            opacity: 1;
        }

        .chat-history-delete:hover {
            background: var(--accent-red);
            color: white;
        }

        .chat-history-item.active .chat-history-delete {
            color: rgba(255, 255, 255, 0.7);
        }

        .chat-history-item.active .chat-history-delete:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .chat-history-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .chat-history-empty-icon {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .chat-history-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .chat-history-toggle:hover {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        /* Chat history item edit button */
        .chat-history-edit {
            position: absolute;
            right: 28px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 11px;
            padding: 2px 4px;
        }

        .chat-history-item:hover .chat-history-edit {
            opacity: 1;
        }

        .chat-history-edit:hover {
            color: var(--accent-blue);
        }

        /* Rename input style */
        .chat-history-rename-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid var(--accent-blue);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 12px;
            outline: none;
        }

        .ai-panel {
            position: relative;
        }

        /* Guardrails Status Indicator */
        .guardrails-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            font-size: 11px;
        }

        .guardrails-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .guardrails-indicator .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .guardrails-indicator.safe .dot {
            background: var(--accent-green);
        }

        .guardrails-indicator.warning .dot {
            background: var(--accent-yellow);
        }

        .guardrails-indicator.danger .dot {
            background: var(--accent-red);
        }

        .guardrails-limit {
            margin-left: auto;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-container" id="login-page">
        <div class="login-box">
            <!-- Team Branding -->
            <div class="team-branding">
                <span class="team-cloud">â˜ï¸ Cloud Bro</span>
                <span class="team-divider">Ã—</span>
                <span class="team-kubeai">KubeAI Team</span>
            </div>

            <!-- ASCII Art Logo -->
            <div class="login-ascii-logo">
 â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â•šâ–ˆâ–ˆâ•‘ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
 â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘ â•šâ•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
 â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
 â•šâ•â•  â•šâ•â• â•šâ•â•â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•</div>
            <h1>k13d</h1>
            <div class="login-subtitle"><span>kube-ai-dashboard</span></div>

            <!-- Auth Mode Indicator -->
            <div id="auth-mode-indicator" class="auth-mode-indicator"></div>

            <div class="login-error" id="login-error"></div>

            <!-- Token Login Form (for token mode) -->
            <div id="token-login-form" class="login-form">
                <div class="token-hint" id="token-hint">
                    <div style="margin-bottom: 12px;">ðŸ” Kubernetes ServiceAccount í† í°ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”</div>
                    <div class="token-help-box" id="token-help-box">
                        <div class="token-help-toggle" onclick="toggleTokenHelp()">
                            <span class="token-help-toggle-text">ðŸ“‹ í† í° ìƒì„± ë°©ë²• ë³´ê¸°</span>
                            <span class="token-help-toggle-icon">â–¼</span>
                        </div>
                        <div class="token-help-content">
                            <div class="token-help-step">
                                <span class="step-num">1</span>
                                <div>
                                    <div>ServiceAccount ìƒì„± (ì„ íƒì‚¬í•­):</div>
                                    <code>kubectl create sa my-user -n default</code>
                                </div>
                            </div>
                            <div class="token-help-step">
                                <span class="step-num">2</span>
                                <div>
                                    <div>ê¶Œí•œ ë¶€ì—¬:</div>
                                    <code>kubectl create clusterrolebinding my-user-binding \<br/>  --clusterrole=cluster-admin \<br/>  --serviceaccount=default:my-user</code>
                                </div>
                            </div>
                            <div class="token-help-step">
                                <span class="step-num">3</span>
                                <div>
                                    <div>í† í° ìƒì„±:</div>
                                    <code>kubectl create token my-user -n default --duration=8760h</code>
                                </div>
                            </div>
                            <div class="token-help-note">
                                ðŸ’¡ <strong>Tip:</strong> ìœ„ í† í°ì„ ì•„ëž˜ì— ë¶™ì—¬ë„£ê³  Enterë¥¼ ëˆ„ë¥´ì„¸ìš”!
                            </div>
                        </div>
                    </div>
                </div>
                <textarea id="login-token" class="token-input" placeholder="eyJhbGciOiJSUzI1NiIs..." onkeydown="handleTokenKeydown(event)"></textarea>
                <button class="login-btn" onclick="loginWithToken()">ðŸš€ Sign In with Token</button>
            </div>

            <!-- Password Login Form (for local mode) -->
            <div id="password-login-form" class="login-form" style="display: none;">
                <div class="local-login-hint">
                    <div style="margin-bottom: 8px;">ðŸ‘¤ ë¡œì»¬ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”</div>
                    <div style="font-size: 11px; color: var(--text-muted);">ê´€ë¦¬ìžì—ê²Œ ê³„ì • ì •ë³´ë¥¼ ë¬¸ì˜í•˜ì„¸ìš”</div>
                </div>
                <input type="text" id="login-username" placeholder="Username" onkeydown="handlePasswordKeydown(event)">
                <input type="password" id="login-password" placeholder="Password" onkeydown="handlePasswordKeydown(event)">
                <button class="login-btn" onclick="login()">ðŸš€ Sign In</button>
            </div>

            <!-- Footer with branding -->
            <div class="login-footer">
                <div class="login-k8s-badge">
                    <svg viewBox="0 0 32 32" fill="currentColor">
                        <path d="M16 0C7.2 0 0 7.2 0 16s7.2 16 16 16 16-7.2 16-16S24.8 0 16 0zm0 2c7.7 0 14 6.3 14 14s-6.3 14-14 14S2 23.7 2 16 8.3 2 16 2z"/>
                        <circle cx="16" cy="16" r="4"/>
                        <circle cx="16" cy="6" r="2"/>
                        <circle cx="24.5" cy="11" r="2"/>
                        <circle cx="24.5" cy="21" r="2"/>
                        <circle cx="16" cy="26" r="2"/>
                        <circle cx="7.5" cy="21" r="2"/>
                        <circle cx="7.5" cy="11" r="2"/>
                    </svg>
                    Powered by Kubernetes
                </div>
                <div class="login-version">
                    Made with ðŸ’™ by <strong>Cloud Bro KubeAI Team</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="app">
        <!-- Top Bar -->
        <div class="top-bar">
            <div style="display: flex; align-items: center;">
                <button class="hamburger-btn" id="hamburger-btn" onclick="toggleSidebar()" title="Toggle Sidebar (B)">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <div class="logo">k13d</div>
                <div class="header-team-badge">
                    <span class="header-team-cloud">â˜ï¸</span>
                    <span class="header-team-text">Cloud Bro Ã— KubeAI</span>
                </div>
            </div>
            <div class="search-container">
                <span class="search-icon">ðŸ”</span>
                <input type="text" class="global-search" id="global-search" placeholder="Search all resources..." oninput="handleGlobalSearchInput(event)" onkeydown="handleGlobalSearchKeydown(event)" onfocus="showSearchResults()" autocomplete="off">
                <span class="search-shortcut">âŒ˜K</span>
                <div class="search-results" id="search-results"></div>
            </div>
            <div class="health-indicator">
                <span class="health-dot ok" id="health-dot"></span>
                <span id="health-status">Connected</span>
            </div>
            <div class="auto-refresh-container">
                <button class="refresh-btn" onclick="manualRefresh()" title="Refresh now">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6"/>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                </button>
                <span style="color: var(--text-secondary);">Auto:</span>
                <div class="auto-refresh-toggle" id="auto-refresh-toggle" onclick="toggleAutoRefresh()" title="Toggle auto-refresh"></div>
                <select class="refresh-interval-select" id="refresh-interval" onchange="setAutoRefreshInterval(this.value)" title="Refresh interval">
                    <option value="10">10s</option>
                    <option value="30" selected>30s</option>
                    <option value="60">1m</option>
                    <option value="120">2m</option>
                    <option value="300">5m</option>
                </select>
                <span class="last-refresh-time" id="last-refresh-time">--:--:--</span>
            </div>
            <div class="user-info">
                <span class="user-badge" id="user-badge">admin</span>
                <button class="logout-btn" onclick="showShortcuts()">?</button>
                <button class="logout-btn" onclick="showSettings()">Settings</button>
                <button class="logout-btn" id="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-container">
            <!-- Sidebar -->
            <div class="sidebar sidebar-transition" id="sidebar">
                <div class="nav-section">
                    <div class="nav-title">Workloads</div>
                    <div class="nav-item active" data-resource="pods" onclick="switchResource('pods')">
                        <span>Pods</span>
                        <span class="count" id="pods-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="deployments" onclick="switchResource('deployments')">
                        <span>Deployments</span>
                        <span class="count" id="deployments-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="daemonsets" onclick="switchResource('daemonsets')">
                        <span>DaemonSets</span>
                        <span class="count" id="daemonsets-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="statefulsets" onclick="switchResource('statefulsets')">
                        <span>StatefulSets</span>
                        <span class="count" id="statefulsets-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="replicasets" onclick="switchResource('replicasets')">
                        <span>ReplicaSets</span>
                        <span class="count" id="replicasets-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="jobs" onclick="switchResource('jobs')">
                        <span>Jobs</span>
                        <span class="count" id="jobs-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="cronjobs" onclick="switchResource('cronjobs')">
                        <span>CronJobs</span>
                        <span class="count" id="cronjobs-count">0</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Network</div>
                    <div class="nav-item" data-resource="services" onclick="switchResource('services')">
                        <span>Services</span>
                        <span class="count" id="services-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="ingresses" onclick="switchResource('ingresses')">
                        <span>Ingresses</span>
                        <span class="count" id="ingresses-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="networkpolicies" onclick="switchResource('networkpolicies')">
                        <span>NetworkPolicies</span>
                        <span class="count" id="networkpolicies-count">0</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Config</div>
                    <div class="nav-item" data-resource="configmaps" onclick="switchResource('configmaps')">
                        <span>ConfigMaps</span>
                        <span class="count" id="configmaps-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="secrets" onclick="switchResource('secrets')">
                        <span>Secrets</span>
                        <span class="count" id="secrets-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="serviceaccounts" onclick="switchResource('serviceaccounts')">
                        <span>ServiceAccounts</span>
                        <span class="count" id="serviceaccounts-count">0</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Storage</div>
                    <div class="nav-item" data-resource="persistentvolumes" onclick="switchResource('persistentvolumes')">
                        <span>PersistentVolumes</span>
                        <span class="count" id="persistentvolumes-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="persistentvolumeclaims" onclick="switchResource('persistentvolumeclaims')">
                        <span>PVCs</span>
                        <span class="count" id="persistentvolumeclaims-count">0</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Cluster</div>
                    <div class="nav-item" data-resource="nodes" onclick="switchResource('nodes')">
                        <span>Nodes</span>
                        <span class="count" id="nodes-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="namespaces" onclick="switchResource('namespaces')">
                        <span>Namespaces</span>
                        <span class="count" id="namespaces-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="events" onclick="switchResource('events')">
                        <span>Events</span>
                        <span class="count" id="events-count">0</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">RBAC</div>
                    <div class="nav-item" data-resource="roles" onclick="switchResource('roles')">
                        <span>Roles</span>
                        <span class="count" id="roles-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="rolebindings" onclick="switchResource('rolebindings')">
                        <span>RoleBindings</span>
                        <span class="count" id="rolebindings-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="clusterroles" onclick="switchResource('clusterroles')">
                        <span>ClusterRoles</span>
                        <span class="count" id="clusterroles-count">0</span>
                    </div>
                    <div class="nav-item" data-resource="clusterrolebindings" onclick="switchResource('clusterrolebindings')">
                        <span>ClusterRoleBindings</span>
                        <span class="count" id="clusterrolebindings-count">0</span>
                    </div>
                </div>

                <div class="nav-section" id="crd-nav-section">
                    <div class="nav-title" style="display: flex; justify-content: space-between; align-items: center;">
                        Custom Resources
                        <span class="count" id="crd-count" style="font-size: 10px;">0</span>
                    </div>
                    <div id="crd-nav-items">
                        <!-- CRD items will be dynamically loaded here -->
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Monitoring</div>
                    <div class="nav-item" onclick="showAuditLogs()">
                        <span>Audit Logs</span>
                    </div>
                    <div class="nav-item" onclick="showReports()">
                        <span>Reports</span>
                    </div>
                </div>
            </div>

            <!-- Content Wrapper -->
            <div class="content-wrapper">
                <!-- Main Panel -->
                <div class="main-panel">
                    <div class="panel-header">
                        <h2 class="panel-title" id="panel-title">Pods</h2>
                        <span class="resource-summary" id="resource-summary"></span>
                        <div class="panel-actions">
                            <select class="namespace-select" id="namespace-select" onchange="onNamespaceChange()">
                                <option value="">All Namespaces</option>
                            </select>
                            <button class="refresh-btn" onclick="refreshData()">â†» Refresh</button>
                        </div>
                    </div>
                    <div class="filter-bar">
                        <span style="font-size: 12px; color: var(--text-secondary);">Filter:</span>
                        <input type="text" class="filter-input" id="filter-input" placeholder="Type to filter..." onkeyup="handleFilter(event)">
                        <button class="filter-toggle-btn" id="column-filter-toggle" onclick="toggleColumnFilters()" title="Toggle column filters (Ctrl+F)">
                            <span>âŠž</span> Columns
                        </button>
                        <div id="filter-chips"></div>
                        <div class="active-filters" id="active-column-filters"></div>
                        <span style="font-size: 11px; color: var(--text-secondary); margin-left: auto;">/ filter | Ctrl+F columns</span>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead id="table-header"></thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                    <!-- Pagination -->
                    <div class="pagination-container" id="pagination-container">
                        <div class="pagination-info" id="pagination-info">
                            Showing 0 items
                        </div>
                        <div class="pagination-controls">
                            <select class="page-size-select" id="page-size-select" onchange="onPageSizeChange()">
                                <option value="25">25 / page</option>
                                <option value="50" selected>50 / page</option>
                                <option value="100">100 / page</option>
                                <option value="200">200 / page</option>
                                <option value="-1">All</option>
                            </select>
                            <button class="pagination-btn" id="prev-page-btn" onclick="goToPrevPage()" disabled>â† Prev</button>
                            <span id="page-indicator">1 / 1</span>
                            <button class="pagination-btn" id="next-page-btn" onclick="goToNextPage()" disabled>Next â†’</button>
                        </div>
                    </div>
                </div>

                <!-- Resize Handle -->
                <div class="resize-handle" id="resize-handle"></div>

                <!-- AI Panel -->
                <div class="ai-panel" id="ai-panel">
                    <!-- Chat History Sidebar -->
                    <div class="chat-history-sidebar" id="chat-history-sidebar">
                        <div class="chat-history-header">
                            <h4>ðŸ’¬ Chat History</h4>
                            <div class="chat-history-actions">
                                <button class="chat-history-btn primary" onclick="createNewChat()" title="New Chat">+</button>
                                <button class="chat-history-btn" onclick="toggleChatHistory()" title="Close">âœ•</button>
                            </div>
                        </div>
                        <div class="chat-history-search">
                            <input type="text" id="chat-history-search" placeholder="Search chats..." oninput="filterChatHistory(this.value)">
                        </div>
                        <div class="chat-history-list" id="chat-history-list">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <div class="ai-header">
                        <button class="chat-history-toggle" id="chat-history-toggle" onclick="toggleChatHistory()" title="Chat History">ðŸ“‹</button>
                        <span>AI Assistant</span>
                        <span class="ai-status-dot" id="ai-status-dot" title="Checking connection...">â—</span>
                        <span class="ai-badge" id="ai-model-badge">Loading...</span>
                        <button class="debug-toggle" id="debug-toggle" onclick="toggleDebugMode()" style="margin-left: auto;" title="Toggle Debug Mode">ðŸ› Debug</button>
                    </div>
                    <!-- Guardrails Status -->
                    <div class="guardrails-status" id="guardrails-status">
                        <div class="guardrails-indicator safe" id="guardrails-indicator">
                            <span class="dot"></span>
                            <span>Safe Mode</span>
                        </div>
                        <span class="guardrails-limit" id="guardrails-limit">Requests: 0/50</span>
                    </div>
                    <!-- Context chips for selected resources -->
                    <div class="context-chips" id="context-chips">
                        <span style="font-size: 11px; color: var(--text-secondary);">Context: Click resources to add</span>
                    </div>
                    <div class="ai-messages" id="ai-messages">
                        <div class="message assistant">
                            <div class="message-content">
                                Welcome to k13d! I can help you manage your Kubernetes cluster.
                                <br><br>
                                Try asking:
                                <br>- "Show me all pods"
                                <br>- "Create an nginx pod"
                                <br>- "Scale deployment to 3 replicas"
                                <br><br>
                                <strong>Tip:</strong> Click any resource row to add it as context for AI analysis!
                            </div>
                        </div>
                    </div>
                    <!-- Debug panel for MCP Tool Calling -->
                    <div class="debug-panel" id="debug-panel">
                        <div class="debug-header">
                            <span>ðŸ”§ MCP Tool Calling Debug</span>
                            <button class="debug-toggle" onclick="clearDebugLogs()">Clear</button>
                        </div>
                        <div class="debug-content" id="debug-content">
                            <div style="color: var(--text-secondary); text-align: center; padding: 20px;">
                                Debug mode active. Tool calls will appear here.
                            </div>
                        </div>
                    </div>
                    <div class="ai-input-container">
                        <textarea class="ai-input" id="ai-input" placeholder="Ask me anything about Kubernetes..." rows="2"></textarea>
                        <div class="ai-actions">
                            <span class="ai-hint">Press Enter to send</span>
                            <button class="send-btn" id="send-btn" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" onclick="switchSettingsTab('general')">General</div>
                    <div class="tab" onclick="switchSettingsTab('ai')">AI</div>
                    <div class="tab" onclick="switchSettingsTab('mcp')">MCP</div>
                    <div class="tab" id="admin-tab" onclick="switchSettingsTab('admin')" style="display:none;">Admin</div>
                    <div class="tab" onclick="switchSettingsTab('about')">About</div>
                </div>

                <div id="settings-general" class="settings-content">
                    <div class="settings-section">
                        <h4>Display</h4>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Language</div>
                            </div>
                            <select id="setting-language">
                                <option value="en">English</option>
                                <option value="ko">í•œêµ­ì–´ (Korean)</option>
                                <option value="zh">ä¸­æ–‡ (Chinese)</option>
                                <option value="ja">æ—¥æœ¬èªž (Japanese)</option>
                            </select>
                        </div>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Log Level</div>
                            </div>
                            <select id="setting-log-level">
                                <option value="debug">Debug</option>
                                <option value="info">Info</option>
                                <option value="warn">Warning</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h4>AI Chat</h4>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Enable Streaming</div>
                                <div class="settings-description">Show AI responses as they're generated</div>
                            </div>
                            <div class="auto-refresh-toggle" id="setting-streaming" onclick="toggleStreamingSetting()"></div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h4>Auto Refresh</h4>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Enable Auto Refresh</div>
                                <div class="settings-description">Automatically refresh resource data</div>
                            </div>
                            <div class="auto-refresh-toggle" id="setting-auto-refresh" onclick="toggleAutoRefreshSetting()"></div>
                        </div>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Refresh Interval</div>
                                <div class="settings-description">How often to refresh data</div>
                            </div>
                            <select id="setting-refresh-interval" onchange="setAutoRefreshIntervalSetting(this.value)">
                                <option value="10">10 seconds</option>
                                <option value="30">30 seconds</option>
                                <option value="60">1 minute</option>
                                <option value="120">2 minutes</option>
                                <option value="300">5 minutes</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- AI Tab (merged Models + LLM) -->
                <div id="settings-ai" class="settings-content" style="display:none;">
                    <!-- LLM Connection Status -->
                    <div class="settings-section" style="margin-bottom:16px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg-primary);border-radius:8px;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <div id="llm-status-indicator" style="width:16px;height:16px;border-radius:50%;background:#888;box-shadow:0 0 8px rgba(136,136,136,0.5);transition:all 0.3s;"></div>
                                <div>
                                    <div id="llm-status-text" style="font-weight:500;">Connection Status: Unknown</div>
                                    <div id="llm-status-detail" style="font-size:12px;color:var(--text-secondary);">Click 'Test Connection' to verify</div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" id="llm-test-btn" onclick="testLLMConnection()" style="min-width:130px;">
                                <span id="llm-test-btn-text">Test Connection</span>
                            </button>
                        </div>
                    </div>

                    <!-- Current LLM Configuration -->
                    <div class="settings-section">
                        <h4>LLM Configuration</h4>
                        <div class="form-group">
                            <label>Provider</label>
                            <select id="setting-llm-provider" onchange="updateEndpointPlaceholder()">
                                <option value="solar">Upstage Solar</option>
                                <option value="openai">OpenAI</option>
                                <option value="ollama">Ollama</option>
                                <option value="gemini">Google Gemini</option>
                                <option value="anthropic">Anthropic Claude</option>
                                <option value="bedrock">AWS Bedrock</option>
                                <option value="azopenai">Azure OpenAI</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Model</label>
                            <input type="text" id="setting-llm-model" placeholder="solar-pro2">
                        </div>
                        <div class="form-group">
                            <label>Endpoint <span id="endpoint-hint" style="font-size:11px;color:var(--text-secondary);"></span></label>
                            <input type="text" id="setting-llm-endpoint" placeholder="https://api.upstage.ai/v1">
                        </div>
                        <div class="form-group">
                            <label>API Key <a href="https://console.upstage.ai/api-keys" target="_blank" style="font-size:11px;color:var(--accent-blue);margin-left:8px;">Get API Key â†’</a></label>
                            <input type="password" id="setting-llm-apikey" placeholder="up_...">
                        </div>
                    </div>

                    <!-- Reasoning Effort (Solar Pro2) -->
                    <div class="settings-section" id="reasoning-effort-section" style="margin-top:16px;padding:12px;background:var(--bg-primary);border-radius:8px;">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                            <span style="font-size:20px;">ðŸ§ </span>
                            <div>
                                <h4 style="margin:0;color:var(--accent-purple);">Reasoning Effort (Solar Pro2)</h4>
                                <p style="font-size:12px;color:var(--text-secondary);margin:4px 0 0 0;">Control reasoning depth for complex tasks</p>
                            </div>
                        </div>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Enable High Reasoning</div>
                                <div class="settings-description">Use deeper reasoning for complex tasks (may increase token usage)</div>
                            </div>
                            <div class="auto-refresh-toggle" id="reasoning-effort-toggle" onclick="toggleReasoningEffort()"></div>
                        </div>
                        <div style="margin-top:8px;font-size:12px;color:var(--text-secondary);">
                            <span id="reasoning-effort-status">Current: minimal (default)</span>
                        </div>
                    </div>

                    <!-- Model Profiles -->
                    <div class="settings-section" style="margin-top:20px;">
                        <h4>Saved Model Profiles</h4>
                        <p class="settings-description" style="margin-bottom:12px;">Manage multiple LLM configurations and switch between them easily.</p>

                        <div id="models-list" style="margin-bottom:16px;">
                            <!-- Populated by JavaScript -->
                        </div>

                        <button class="btn-add" onclick="showAddModelForm()" style="margin-top:8px;"><span class="plus-icon">+</span> Add Model Profile</button>
                    </div>

                    <div id="add-model-form" class="settings-section" style="display:none;margin-top:16px;background:var(--bg-primary);padding:16px;border-radius:8px;">
                        <h4>Add New Model Profile</h4>
                        <div class="form-group">
                            <label>Profile Name</label>
                            <input type="text" id="new-model-name" placeholder="e.g., gpt-4-turbo">
                        </div>
                        <div class="form-group">
                            <label>Provider</label>
                            <select id="new-model-provider">
                                <option value="solar">Upstage Solar</option>
                                <option value="openai">OpenAI</option>
                                <option value="ollama">Ollama</option>
                                <option value="gemini">Google Gemini</option>
                                <option value="bedrock">AWS Bedrock</option>
                                <option value="azopenai">Azure OpenAI</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Model</label>
                            <input type="text" id="new-model-model" placeholder="e.g., solar-pro2">
                        </div>
                        <div class="form-group">
                            <label>Endpoint (optional)</label>
                            <input type="text" id="new-model-endpoint" placeholder="https://api.openai.com/v1">
                        </div>
                        <div class="form-group">
                            <label>API Key (optional)</label>
                            <input type="password" id="new-model-apikey" placeholder="sk-...">
                        </div>
                        <div class="form-group">
                            <label>Description (optional)</label>
                            <input type="text" id="new-model-description" placeholder="Fast model for quick tasks">
                        </div>
                        <div style="display:flex;gap:8px;margin-top:12px;">
                            <button class="btn btn-primary" onclick="addModelProfile()">Add Profile</button>
                            <button class="btn btn-secondary" onclick="hideAddModelForm()">Cancel</button>
                        </div>
                    </div>

                    <!-- Ollama Quick Setup Section -->
                    <div class="settings-section" id="ollama-setup-section" style="margin-top:20px;padding:16px;background:linear-gradient(135deg, rgba(122,162,247,0.1), rgba(187,154,247,0.1));border-radius:12px;border:1px solid rgba(122,162,247,0.2);">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                            <span style="font-size:24px;">ðŸ¦™</span>
                            <div>
                                <h4 style="margin:0;color:var(--accent-blue);">Ollama - Local AI (Offline Mode)</h4>
                                <p style="font-size:12px;color:var(--text-secondary);margin:4px 0 0 0;">Run AI models locally without API keys or internet</p>
                            </div>
                        </div>

                        <div id="ollama-status-panel" style="margin-bottom:12px;padding:12px;background:var(--bg-primary);border-radius:8px;">
                            <div style="display:flex;align-items:center;justify-content:space-between;">
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <div id="ollama-status-dot" style="width:10px;height:10px;border-radius:50%;background:#888;"></div>
                                    <span id="ollama-status-text">Checking Ollama status...</span>
                                </div>
                                <button class="btn btn-secondary" onclick="checkOllamaStatus()" style="padding:4px 12px;font-size:12px;">Refresh</button>
                            </div>
                        </div>

                        <div id="ollama-not-installed" style="display:none;">
                            <p style="font-size:13px;margin-bottom:12px;">Ollama is not detected on your system. Install it to use AI without API keys:</p>
                            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                                <button class="btn btn-primary" onclick="showOllamaInstallInstructions('macos')" style="display:flex;align-items:center;gap:6px;">
                                    <span>ðŸŽ</span> macOS
                                </button>
                                <button class="btn btn-secondary" onclick="showOllamaInstallInstructions('linux')" style="display:flex;align-items:center;gap:6px;">
                                    <span>ðŸ§</span> Linux
                                </button>
                                <button class="btn btn-secondary" onclick="showOllamaInstallInstructions('windows')" style="display:flex;align-items:center;gap:6px;">
                                    <span>ðŸªŸ</span> Windows
                                </button>
                            </div>
                            <div id="ollama-install-instructions" style="display:none;margin-top:12px;padding:12px;background:var(--bg-primary);border-radius:8px;font-family:var(--font-mono);font-size:12px;"></div>
                        </div>

                        <div id="ollama-installed" style="display:none;">
                            <div style="margin-bottom:12px;">
                                <label style="font-size:12px;color:var(--text-secondary);">Available Models</label>
                                <div id="ollama-models-list" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;">
                                    <span style="color:var(--text-secondary);font-size:12px;">Loading models...</span>
                                </div>
                            </div>

                            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                                <button class="btn btn-primary" onclick="useOllamaModel()" id="use-ollama-btn" disabled>Use Selected Model</button>
                                <button class="btn btn-secondary" onclick="showOllamaPullDialog()">Pull New Model</button>
                            </div>

                            <div id="ollama-pull-dialog" style="display:none;margin-top:12px;padding:12px;background:var(--bg-primary);border-radius:8px;">
                                <label style="font-size:12px;color:var(--text-secondary);">Recommended models for Kubernetes tasks:</label>
                                <div style="display:flex;flex-wrap:wrap;gap:6px;margin:8px 0;">
                                    <button class="btn btn-secondary" onclick="pullOllamaModel('llama3.2:3b')" style="font-size:11px;padding:4px 10px;">llama3.2:3b (2GB)</button>
                                    <button class="btn btn-secondary" onclick="pullOllamaModel('qwen2.5:7b')" style="font-size:11px;padding:4px 10px;">qwen2.5:7b (4GB)</button>
                                    <button class="btn btn-secondary" onclick="pullOllamaModel('mistral:7b')" style="font-size:11px;padding:4px 10px;">mistral:7b (4GB)</button>
                                    <button class="btn btn-secondary" onclick="pullOllamaModel('codellama:7b')" style="font-size:11px;padding:4px 10px;">codellama:7b (4GB)</button>
                                </div>
                                <div style="display:flex;gap:8px;align-items:center;">
                                    <input type="text" id="ollama-custom-model" placeholder="Or enter model name..." style="flex:1;padding:8px;font-size:12px;">
                                    <button class="btn btn-primary" onclick="pullOllamaModel()" style="font-size:12px;">Pull</button>
                                </div>
                                <div id="ollama-pull-status" style="display:none;margin-top:8px;font-size:12px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- K8s Safety Guardrails Configuration -->
                    <div class="settings-section" style="margin-top:20px;">
                        <h4>ðŸ›¡ï¸ K8s Safety Guardrails</h4>
                        <p class="settings-description" style="margin-bottom:12px;">Protect your cluster from dangerous AI-proposed operations</p>

                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Enable Safety Analysis</div>
                                <div class="settings-description">Analyze K8s commands for potential risks before execution</div>
                            </div>
                            <div class="auto-refresh-toggle active" id="guardrails-toggle" onclick="toggleGuardrailsSetting()"></div>
                        </div>

                        <div class="settings-row" style="margin-top:12px;">
                            <div>
                                <div class="settings-label">Strict Mode</div>
                                <div class="settings-description">Block all dangerous/critical operations (not just warn)</div>
                            </div>
                            <div class="auto-refresh-toggle" id="guardrails-strict-toggle" onclick="toggleStrictMode()"></div>
                        </div>

                        <div class="settings-row" style="margin-top:12px;">
                            <div>
                                <div class="settings-label">Auto-Analyze AI Responses</div>
                                <div class="settings-description">Automatically analyze kubectl commands in AI responses</div>
                            </div>
                            <div class="auto-refresh-toggle active" id="guardrails-auto-analyze" onclick="toggleAutoAnalyze()"></div>
                        </div>

                        <!-- Risk Level Descriptions -->
                        <div style="margin-top:16px; padding:12px; background:var(--bg-tertiary); border-radius:8px;">
                            <div style="font-weight:600; margin-bottom:8px;">Risk Level Descriptions:</div>
                            <div style="display:grid; gap:6px; font-size:13px;">
                                <div><span style="color:var(--accent-green);">â— Safe</span> - Read-only operations (get, describe, logs)</div>
                                <div><span style="color:var(--accent-yellow);">â— Warning</span> - Modifications that need review (apply, scale)</div>
                                <div><span style="color:var(--accent-red);">â— Dangerous</span> - Deletions and destructive changes</div>
                                <div><span style="color:#ff4757;">â— Critical</span> - Cluster-wide impact (drain, delete namespace)</div>
                            </div>
                        </div>

                        <!-- Recent Safety Analysis -->
                        <div style="margin-top:16px;">
                            <div style="font-weight:600; margin-bottom:8px;">Recent Safety Checks:</div>
                            <div id="guardrails-history" style="max-height:150px; overflow-y:auto; background:var(--bg-primary); border-radius:8px; padding:8px;">
                                <div style="color:var(--text-secondary); font-size:13px;">No recent checks</div>
                            </div>
                        </div>

                        <button class="btn btn-secondary" onclick="clearGuardrailsHistory()" style="margin-top:12px;">Clear History</button>
                    </div>
                </div>

                <!-- MCP Tab -->
                <div id="settings-mcp" class="settings-content" style="display:none;">
                    <div class="settings-section">
                        <h4>MCP Servers</h4>
                        <p class="settings-description" style="margin-bottom:12px;">Connect to Model Context Protocol servers to extend AI capabilities with additional tools.</p>

                        <div id="mcp-servers-list" style="margin-bottom:16px;">
                            <!-- Populated by JavaScript -->
                        </div>

                        <button class="btn-add" onclick="showAddMCPForm()" style="margin-top:8px;"><span class="plus-icon">+</span> Add MCP Server</button>
                    </div>

                    <div id="add-mcp-form" class="settings-section" style="display:none;margin-top:16px;background:var(--bg-primary);padding:16px;border-radius:8px;">
                        <h4>Add MCP Server</h4>
                        <div class="form-group">
                            <label>Server Name</label>
                            <input type="text" id="new-mcp-name" placeholder="e.g., kubernetes-mcp">
                        </div>
                        <div class="form-group">
                            <label>Command</label>
                            <input type="text" id="new-mcp-command" placeholder="e.g., npx, docker">
                        </div>
                        <div class="form-group">
                            <label>Arguments (comma-separated)</label>
                            <input type="text" id="new-mcp-args" placeholder="e.g., -y, @anthropic/mcp-server">
                        </div>
                        <div class="form-group">
                            <label>Description (optional)</label>
                            <input type="text" id="new-mcp-description" placeholder="Kubernetes management tools">
                        </div>
                        <div class="settings-row" style="margin-top:8px;">
                            <div>
                                <div class="settings-label">Enable on Add</div>
                            </div>
                            <input type="checkbox" id="new-mcp-enabled" checked>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:12px;">
                            <button class="btn btn-primary" onclick="addMCPServer()">Add Server</button>
                            <button class="btn btn-secondary" onclick="hideAddMCPForm()">Cancel</button>
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top:16px;">
                        <h4>Available Tools</h4>
                        <div id="mcp-tools-list">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top:16px;background:var(--bg-primary);padding:12px;border-radius:8px;">
                        <h4>Example: Kubernetes MCP Server</h4>
                        <p class="settings-description" style="font-size:12px;">
                            To add the <a href="https://github.com/containers/kubernetes-mcp-server" target="_blank" style="color:var(--accent-blue);">kubernetes-mcp-server</a>:<br><br>
                            <strong>Name:</strong> kubernetes<br>
                            <strong>Command:</strong> npx<br>
                            <strong>Args:</strong> -y, @anthropic/mcp-server-kubernetes<br>
                        </p>
                    </div>
                </div>

                <div id="settings-about" class="settings-content" style="display:none;">
                    <div class="about-header">
                        <div class="about-logo">âŽˆ</div>
                        <div class="about-title">
                            <h2>k13d</h2>
                            <p class="about-tagline">AI-Powered Kubernetes Dashboard</p>
                        </div>
                    </div>

                    <div class="about-version-card">
                        <div class="about-version-row">
                            <span class="about-label">Version</span>
                            <span class="about-value" id="about-version">Loading...</span>
                        </div>
                        <div class="about-version-row">
                            <span class="about-label">Build Time</span>
                            <span class="about-value" id="about-build-time">-</span>
                        </div>
                        <div class="about-version-row">
                            <span class="about-label">Git Commit</span>
                            <span class="about-value about-mono" id="about-git-commit">-</span>
                        </div>
                    </div>

                    <div class="about-description">
                        <p>A modern Kubernetes dashboard combining the power of <strong>k9s-style TUI</strong> with an AI assistant. Manage clusters efficiently with natural language commands and intelligent analysis.</p>
                    </div>

                    <div class="about-features">
                        <div class="about-feature">
                            <span class="about-feature-icon">ðŸ¤–</span>
                            <div>
                                <strong>AI Assistant</strong>
                                <p>Natural language cluster management</p>
                            </div>
                        </div>
                        <div class="about-feature">
                            <span class="about-feature-icon">âš¡</span>
                            <div>
                                <strong>Real-time Monitoring</strong>
                                <p>Live resource status and metrics</p>
                            </div>
                        </div>
                        <div class="about-feature">
                            <span class="about-feature-icon">ðŸ”’</span>
                            <div>
                                <strong>Safety First</strong>
                                <p>Guardrails for dangerous operations</p>
                            </div>
                        </div>
                        <div class="about-feature">
                            <span class="about-feature-icon">ðŸŒ</span>
                            <div>
                                <strong>Multi-language</strong>
                                <p>English, í•œêµ­ì–´, ä¸­æ–‡, æ—¥æœ¬èªž</p>
                            </div>
                        </div>
                    </div>

                    <div class="about-links">
                        <a href="https://github.com/kube-ai-dashbaord/kube-ai-dashboard-cli" target="_blank" class="about-link">
                            <span>ðŸ“¦</span> GitHub Repository
                        </a>
                        <a href="https://github.com/kube-ai-dashbaord/kube-ai-dashboard-cli/issues" target="_blank" class="about-link">
                            <span>ðŸ›</span> Report Issue
                        </a>
                        <a href="https://github.com/kube-ai-dashbaord/kube-ai-dashboard-cli/blob/main/docs/USER_GUIDE.md" target="_blank" class="about-link">
                            <span>ðŸ“–</span> Documentation
                        </a>
                    </div>

                    <div class="about-footer">
                        <p>Made with â¤ï¸ for the Kubernetes Community</p>
                        <p class="about-license">MIT License</p>
                    </div>
                </div>

                <!-- Admin Tab (visible only to admins) -->
                <div id="settings-admin" class="settings-content" style="display:none;">
                    <div class="settings-section">
                        <h4>User Management</h4>
                        <p class="settings-description" style="margin-bottom:12px;">Manage user accounts and permissions.</p>

                        <div id="admin-users-list" style="margin-bottom:16px;">
                            <!-- Populated by JavaScript -->
                        </div>

                        <button class="btn-add" onclick="showAddUserForm()" style="margin-top:8px;"><span class="plus-icon">+</span> Add User</button>
                    </div>

                    <div id="add-user-form" class="settings-section" style="display:none;margin-top:16px;background:var(--bg-primary);padding:16px;border-radius:8px;">
                        <h4>Add New User</h4>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="new-user-username" placeholder="username">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="new-user-password" placeholder="password">
                        </div>
                        <div class="form-group">
                            <label>Email (optional)</label>
                            <input type="email" id="new-user-email" placeholder="user@example.com">
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <select id="new-user-role">
                                <option value="viewer">Viewer (read-only)</option>
                                <option value="user">User (standard)</option>
                                <option value="admin">Admin (full access)</option>
                            </select>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:12px;">
                            <button class="btn btn-secondary" onclick="hideAddUserForm()">Cancel</button>
                            <button class="btn btn-primary" onclick="addUser()">Add User</button>
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top:16px;">
                        <h4>Authentication Settings</h4>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Authentication Mode</div>
                                <div class="settings-description">Select authentication method</div>
                            </div>
                            <select id="auth-mode" onchange="onAuthModeChange(this.value)">
                                <option value="local">Local (Username/Password)</option>
                                <option value="token">Kubernetes Token</option>
                                <option value="oidc">OIDC/OAuth SSO</option>
                                <option value="ldap">LDAP/Active Directory</option>
                            </select>
                        </div>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Allow Password Login</div>
                                <div class="settings-description">Enable local password login alongside SSO</div>
                            </div>
                            <div class="auto-refresh-toggle" id="allow-password-login" onclick="toggleAllowPasswordLogin()"></div>
                        </div>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Enable Self-Registration</div>
                                <div class="settings-description">Allow new users to create accounts</div>
                            </div>
                            <div class="auto-refresh-toggle" id="enable-signup" onclick="toggleEnableSignup()"></div>
                        </div>
                    </div>

                    <!-- OIDC/OAuth Settings -->
                    <div class="settings-section" id="oidc-settings" style="margin-top:16px;display:none;">
                        <h4>OIDC/OAuth Configuration</h4>
                        <p class="settings-description" style="margin-bottom:12px;">
                            Configure Single Sign-On with any OIDC-compliant provider (Google, Microsoft, Okta, Keycloak, etc.)
                        </p>
                        <div class="form-group">
                            <label>Provider Name</label>
                            <input type="text" id="oidc-provider-name" placeholder="e.g., Google, Okta, Keycloak">
                        </div>
                        <div class="form-group">
                            <label>Discovery URL (Well-Known)</label>
                            <input type="text" id="oidc-provider-url" placeholder="https://accounts.google.com/.well-known/openid-configuration">
                        </div>
                        <div class="form-group">
                            <label>Client ID</label>
                            <input type="text" id="oidc-client-id" placeholder="your-client-id">
                        </div>
                        <div class="form-group">
                            <label>Client Secret</label>
                            <input type="password" id="oidc-client-secret" placeholder="your-client-secret">
                        </div>
                        <div class="form-group">
                            <label>Scopes</label>
                            <input type="text" id="oidc-scopes" placeholder="openid email profile" value="openid email profile">
                        </div>
                        <div class="form-group">
                            <label>Redirect URI</label>
                            <input type="text" id="oidc-redirect-uri" placeholder="Auto-generated" readonly style="background:var(--bg-tertiary);">
                        </div>

                        <div class="settings-row" style="margin-top:12px;">
                            <div>
                                <div class="settings-label">Allow OAuth Signup</div>
                                <div class="settings-description">Create accounts for new OAuth users</div>
                            </div>
                            <div class="auto-refresh-toggle active" id="oauth-signup"></div>
                        </div>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Merge Accounts by Email</div>
                                <div class="settings-description">Link OAuth logins to existing accounts (use with caution)</div>
                            </div>
                            <div class="auto-refresh-toggle" id="oauth-merge-email"></div>
                        </div>

                        <!-- Role Management -->
                        <h4 style="margin-top:16px;">Role Management</h4>
                        <div class="settings-row">
                            <div>
                                <div class="settings-label">Enable OAuth Role Management</div>
                                <div class="settings-description">Sync user roles from OAuth provider</div>
                            </div>
                            <div class="auto-refresh-toggle" id="oauth-role-mgmt"></div>
                        </div>
                        <div class="form-group">
                            <label>Roles Claim</label>
                            <input type="text" id="oauth-roles-claim" placeholder="roles" value="roles">
                        </div>
                        <div class="form-group">
                            <label>Admin Roles (comma-separated)</label>
                            <input type="text" id="oauth-admin-roles" placeholder="admin, k13d-admin">
                        </div>
                        <div class="form-group">
                            <label>Allowed Roles (comma-separated, empty = all)</label>
                            <input type="text" id="oauth-allowed-roles" placeholder="users, developers, admins">
                        </div>
                    </div>

                    <!-- LDAP Settings -->
                    <div class="settings-section" id="ldap-settings" style="margin-top:16px;display:none;">
                        <h4>LDAP/Active Directory Configuration</h4>
                        <p class="settings-description" style="margin-bottom:12px;">
                            Connect to your organization's LDAP or Active Directory server.
                        </p>
                        <div class="form-group">
                            <label>LDAP Server URL</label>
                            <input type="text" id="ldap-server-url" placeholder="ldap://ldap.example.com:389 or ldaps://...">
                        </div>
                        <div class="form-group">
                            <label>Bind DN</label>
                            <input type="text" id="ldap-bind-dn" placeholder="cn=admin,dc=example,dc=com">
                        </div>
                        <div class="form-group">
                            <label>Bind Password</label>
                            <input type="password" id="ldap-bind-password" placeholder="password">
                        </div>
                        <div class="form-group">
                            <label>User Search Base</label>
                            <input type="text" id="ldap-user-search-base" placeholder="ou=users,dc=example,dc=com">
                        </div>
                        <div class="form-group">
                            <label>User Search Filter</label>
                            <input type="text" id="ldap-user-search-filter" placeholder="(uid={{username}})" value="(uid={{username}})">
                        </div>
                        <div class="form-group">
                            <label>Group Search Base (optional)</label>
                            <input type="text" id="ldap-group-search-base" placeholder="ou=groups,dc=example,dc=com">
                        </div>
                        <div class="form-group">
                            <label>Group Search Filter (optional)</label>
                            <input type="text" id="ldap-group-search-filter" placeholder="(member={{userDN}})">
                        </div>
                        <div class="form-group">
                            <label>Admin Group DN (optional)</label>
                            <input type="text" id="ldap-admin-group" placeholder="cn=k13d-admins,ou=groups,dc=example,dc=com">
                        </div>
                        <div style="margin-top:12px;display:flex;gap:10px;">
                            <button class="btn btn-secondary" onclick="testLDAPConnection()">Test Connection</button>
                        </div>
                    </div>

                    <div class="settings-section" style="margin-top:16px;">
                        <h4>Authentication Status</h4>
                        <div id="auth-status" style="background:var(--bg-primary);padding:12px;border-radius:8px;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                                <span style="color:var(--status-running);">â—</span>
                                <span>Current Mode: <strong id="current-auth-mode">Local</strong></span>
                            </div>
                            <div style="color:var(--text-secondary);font-size:12px;">
                                Changes to authentication settings require a server restart.
                            </div>
                        </div>
                        <div style="margin-top:16px;">
                            <button class="btn btn-primary" onclick="saveAuthSettings()" style="width:100%;">
                                Save Authentication Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <!-- Resource Detail Modal -->
    <div class="modal-overlay" id="detail-modal">
        <div class="modal detail-modal">
            <div class="modal-header">
                <h2 id="detail-title">Resource Details</h2>
                <button class="modal-close" onclick="closeDetail()">&times;</button>
            </div>
            <div class="detail-tabs">
                <button class="detail-tab active" onclick="switchDetailTab('overview')">Overview</button>
                <button class="detail-tab" onclick="switchDetailTab('yaml')">YAML</button>
                <button class="detail-tab" onclick="switchDetailTab('events')">Events</button>
                <button class="detail-tab" id="detail-pods-tab" onclick="switchDetailTab('pods')" style="display:none;">Related Pods</button>
            </div>
            <div class="detail-content" id="detail-content">
                <div id="detail-overview"></div>
                <div id="detail-yaml" style="display:none;"></div>
                <div id="detail-events" style="display:none;"></div>
                <div id="detail-pods" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDetail()">Close</button>
                <button class="btn btn-primary" onclick="analyzeWithAI()">ðŸ¤– Analyze with AI</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="modal-overlay" id="shortcuts-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Keyboard Shortcuts</h2>
                <button class="modal-close" onclick="closeShortcuts()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="shortcuts-grid">
                    <div class="shortcut-item" style="grid-column: 1 / -1; background: var(--bg-tertiary); border-radius: 4px; padding: 8px; margin-bottom: 8px;">
                        <span style="font-weight: 600; color: var(--accent-blue);">Navigation (TUI-style)</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Command Mode</span>
                        <span class="shortcut-key">:</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Filter Resources</span>
                        <span class="shortcut-key">/</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Global Search</span>
                        <span class="shortcut-key">âŒ˜K / Ctrl+K</span>
                    </div>
                    <div class="shortcut-item">
                        <span>YAML Editor</span>
                        <span class="shortcut-key">E</span>
                    </div>
                    <div class="shortcut-item" style="grid-column: 1 / -1; background: var(--bg-tertiary); border-radius: 4px; padding: 8px; margin: 8px 0;">
                        <span style="font-weight: 600; color: var(--accent-purple);">Namespace Switching</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Switch Namespace</span>
                        <span class="shortcut-key">N</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Recent Namespace 1-9</span>
                        <span class="shortcut-key">Alt+1~9</span>
                    </div>
                    <div class="shortcut-item">
                        <span>All Namespaces</span>
                        <span class="shortcut-key">Alt+0</span>
                    </div>
                    <div class="shortcut-item" style="grid-column: 1 / -1; background: var(--bg-tertiary); border-radius: 4px; padding: 8px; margin: 8px 0;">
                        <span style="font-weight: 600; color: var(--accent-green);">Resource Views</span>
                    </div>
                    <div class="shortcut-item">
                        <span>View Pods</span>
                        <span class="shortcut-key">1</span>
                    </div>
                    <div class="shortcut-item">
                        <span>View Deployments</span>
                        <span class="shortcut-key">2</span>
                    </div>
                    <div class="shortcut-item">
                        <span>View Services</span>
                        <span class="shortcut-key">3</span>
                    </div>
                    <div class="shortcut-item">
                        <span>View Nodes</span>
                        <span class="shortcut-key">4</span>
                    </div>
                    <div class="shortcut-item" style="grid-column: 1 / -1; background: var(--bg-tertiary); border-radius: 4px; padding: 8px; margin: 8px 0;">
                        <span style="font-weight: 600; color: var(--accent-yellow);">Panels & Actions</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Refresh Data</span>
                        <span class="shortcut-key">R</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Toggle AI Panel</span>
                        <span class="shortcut-key">A</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Toggle Sidebar</span>
                        <span class="shortcut-key">B</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Toggle Debug Mode</span>
                        <span class="shortcut-key">D</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Show Settings</span>
                        <span class="shortcut-key">S</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Toggle Theme</span>
                        <span class="shortcut-key">T</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Show Help</span>
                        <span class="shortcut-key">?</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Close Modal</span>
                        <span class="shortcut-key">Esc</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Add to AI Context</span>
                        <span class="shortcut-key">Right-click row</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeShortcuts()">Got it!</button>
            </div>
        </div>
    </div>

    <!-- Command Bar (TUI-style : command mode) -->
    <div class="command-bar-overlay" id="command-bar-overlay">
        <div class="command-bar">
            <div class="command-input-wrapper">
                <span class="command-prefix">:</span>
                <input type="text" class="command-input" id="command-input" placeholder="Type a command..." autocomplete="off">
            </div>
            <div class="command-suggestions" id="command-suggestions"></div>
            <div class="command-hint">
                <span><kbd>â†‘â†“</kbd> Navigate</span>
                <span><kbd>Enter</kbd> Execute</span>
                <span><kbd>Esc</kbd> Close</span>
                <span><kbd>Tab</kbd> Autocomplete</span>
            </div>
        </div>
    </div>

    <!-- Namespace Quick Switcher -->
    <div class="namespace-indicator" id="namespace-indicator"></div>

    <!-- YAML Editor Modal -->
    <div class="yaml-editor-modal" id="yaml-editor-modal">
        <div class="yaml-editor-container">
            <div class="yaml-editor-header">
                <div class="yaml-editor-title">
                    <h3>YAML Editor</h3>
                    <span class="yaml-editor-badge" id="yaml-editor-mode">Create</span>
                </div>
                <div class="yaml-editor-actions">
                    <button class="yaml-editor-btn secondary" onclick="validateYaml()">Validate</button>
                    <button class="yaml-editor-btn secondary" onclick="formatYaml()">Format</button>
                    <button class="yaml-editor-btn primary" onclick="applyYaml()">Apply</button>
                    <button class="yaml-editor-btn secondary" onclick="closeYamlEditor()">Cancel</button>
                </div>
            </div>
            <div class="yaml-editor-body">
                <div class="yaml-editor-main">
                    <div class="yaml-editor-toolbar">
                        <label>Namespace:</label>
                        <select id="yaml-editor-namespace"></select>
                        <label style="margin-left: 16px;">Dry Run:</label>
                        <input type="checkbox" id="yaml-dry-run" checked>
                    </div>
                    <textarea class="yaml-textarea" id="yaml-editor-content" placeholder="# Paste or type your Kubernetes YAML here...
# Example:
apiVersion: v1
kind: Pod
metadata:
  name: my-pod
  namespace: default
spec:
  containers:
  - name: nginx
    image: nginx:latest"></textarea>
                </div>
                <div class="yaml-editor-sidebar">
                    <div class="yaml-editor-sidebar-header">Templates</div>
                    <div class="yaml-template-list" id="yaml-template-list"></div>
                </div>
            </div>
            <div class="yaml-editor-footer">
                <div class="yaml-editor-status" id="yaml-editor-status">
                    <span class="status-dot"></span>
                    <span class="status-text">Ready</span>
                </div>
                <div class="yaml-editor-hints">
                    <kbd>Ctrl+Enter</kbd> Apply &nbsp; <kbd>Ctrl+Shift+F</kbd> Format &nbsp; <kbd>Esc</kbd> Close
                </div>
            </div>
        </div>
    </div>

    <!-- Terminal Modal -->
    <div class="terminal-modal" id="terminal-modal">
        <div class="terminal-header">
            <div class="terminal-title">
                <span>Terminal:</span>
                <span class="pod-name" id="terminal-pod-name">-</span>
                <span class="container-name" id="terminal-container-name">-</span>
            </div>
            <button class="terminal-close" onclick="closeTerminal()">&times;</button>
        </div>
        <div class="terminal-body" id="terminal-container"></div>
    </div>

    <!-- Log Viewer Modal -->
    <div class="log-viewer-modal" id="log-viewer-modal">
        <div class="log-header">
            <div class="terminal-title">
                <span>Logs:</span>
                <span class="pod-name" id="log-pod-name">-</span>
                <span class="container-name" id="log-container-name">-</span>
            </div>
            <div class="log-controls">
                <select id="log-container-select" onchange="switchLogContainer()">
                    <option value="">Select container</option>
                </select>
                <select id="log-lines-select" onchange="reloadLogs()">
                    <option value="100">100 lines</option>
                    <option value="500">500 lines</option>
                    <option value="1000" selected>1000 lines</option>
                    <option value="5000">5000 lines</option>
                </select>
                <button id="log-follow-btn" onclick="toggleLogFollow()">Follow</button>
                <button onclick="downloadLogs()">Download</button>
                <button class="terminal-close" onclick="closeLogViewer()">&times;</button>
            </div>
        </div>
        <div class="log-pod-legend" id="log-pod-legend" style="display: none;"></div>
        <div class="log-search">
            <input type="text" id="log-search-input" placeholder="Search logs..." onkeyup="filterLogs()">
            <span class="match-count" id="log-match-count"></span>
        </div>
        <div class="log-body" id="log-content"></div>
    </div>

    <!-- Metrics Modal -->
    <div class="metrics-modal" id="metrics-modal">
        <div class="metrics-header">
            <div class="terminal-title">
                <span>Cluster Metrics</span>
            </div>
            <div class="log-controls">
                <div class="time-range-selector">
                    <button class="time-range-btn active" data-minutes="5" onclick="setMetricsTimeRangeMinutes(5)">5m</button>
                    <button class="time-range-btn" data-minutes="15" onclick="setMetricsTimeRangeMinutes(15)">15m</button>
                    <button class="time-range-btn" data-minutes="30" onclick="setMetricsTimeRangeMinutes(30)">30m</button>
                    <button class="time-range-btn" data-hours="1" onclick="setMetricsTimeRange(1)">1h</button>
                    <button class="time-range-btn" data-hours="6" onclick="setMetricsTimeRange(6)">6h</button>
                    <button class="time-range-btn" data-hours="24" onclick="setMetricsTimeRange(24)">24h</button>
                </div>
                <select id="metrics-namespace-select" onchange="loadMetrics()">
                    <option value="">All Namespaces</option>
                </select>
                <button onclick="loadMetrics()">Refresh</button>
                <button class="terminal-close" onclick="closeMetrics()">&times;</button>
            </div>
        </div>
        <div class="metrics-body">
            <div class="metrics-summary">
                <div class="summary-card">
                    <div class="label">Total CPU Usage</div>
                    <div class="value cpu" id="metrics-total-cpu">-</div>
                </div>
                <div class="summary-card">
                    <div class="label">Total Memory Usage</div>
                    <div class="value memory" id="metrics-total-memory">-</div>
                </div>
                <div class="summary-card">
                    <div class="label">Running Pods</div>
                    <div class="value pods" id="metrics-total-pods">-</div>
                </div>
            </div>
            <div class="metrics-grid">
                <div class="metric-card">
                    <h4>CPU Usage Over Time</h4>
                    <div class="metric-chart">
                        <canvas id="cpu-chart"></canvas>
                    </div>
                </div>
                <div class="metric-card">
                    <h4>Memory Usage Over Time</h4>
                    <div class="metric-chart">
                        <canvas id="memory-chart"></canvas>
                    </div>
                </div>
                <div class="metric-card">
                    <h4>Top CPU Consumers</h4>
                    <div id="top-cpu-list" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
                <div class="metric-card">
                    <h4>Top Memory Consumers</h4>
                    <div id="top-memory-list" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
                <div class="metric-card llm-usage-widget">
                    <h4>LLM Token Usage</h4>
                    <div class="llm-stats-grid">
                        <div class="llm-stat">
                            <div class="label">Total Requests</div>
                            <div class="value" id="llm-total-requests">-</div>
                        </div>
                        <div class="llm-stat">
                            <div class="label">Total Tokens</div>
                            <div class="value tokens" id="llm-total-tokens">-</div>
                        </div>
                        <div class="llm-stat">
                            <div class="label">Prompt Tokens</div>
                            <div class="value" id="llm-prompt-tokens">-</div>
                        </div>
                        <div class="llm-stat">
                            <div class="label">Completion Tokens</div>
                            <div class="value" id="llm-completion-tokens">-</div>
                        </div>
                    </div>
                    <div class="metric-chart">
                        <canvas id="llm-usage-chart"></canvas>
                    </div>
                </div>
                <div class="metric-card">
                    <h4>LLM Usage by Model</h4>
                    <div id="llm-model-list" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Port Forward Modal -->
    <div class="modal-overlay" id="portforward-modal">
        <div class="modal portforward-modal">
            <div class="modal-header">
                <h2>Port Forwarding</h2>
                <button class="modal-close" onclick="closePortForward()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="portforward-form">
                    <div class="form-group">
                        <label>Local Port</label>
                        <input type="number" id="pf-local-port" placeholder="8080">
                    </div>
                    <div class="form-group">
                        <label>Remote Port</label>
                        <input type="number" id="pf-remote-port" placeholder="80">
                    </div>
                    <div class="form-group full-width">
                        <label>Target</label>
                        <input type="text" id="pf-target" readonly>
                    </div>
                    <div class="full-width" style="text-align: right;">
                        <button class="btn btn-primary" onclick="startPortForward()">Start Port Forward</button>
                    </div>
                </div>
                <h4 style="margin-bottom: 12px;">Active Port Forwards</h4>
                <div class="portforward-list" id="portforward-list">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">No active port forwards</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentResource = 'pods';
        let currentNamespace = '';
        let isLoading = false;
        let authToken = localStorage.getItem('k13d_token');
        let currentUser = null;
        let sidebarCollapsed = localStorage.getItem('k13d_sidebar_collapsed') === 'true';
        let debugMode = localStorage.getItem('k13d_debug_mode') === 'true';
        let aiContextItems = []; // Resources added as context for AI
        let currentLanguage = 'ko'; // Default language (Korean)
        let currentLLMModel = ''; // Current LLM model name
        let llmConnected = false; // LLM connection status

        // i18n Translations
        const translations = {
            en: {
                // Navigation
                nav_pods: 'Pods',
                nav_deployments: 'Deployments',
                nav_daemonsets: 'DaemonSets',
                nav_statefulsets: 'StatefulSets',
                nav_replicasets: 'ReplicaSets',
                nav_jobs: 'Jobs',
                nav_cronjobs: 'CronJobs',
                nav_services: 'Services',
                nav_ingresses: 'Ingresses',
                nav_configmaps: 'ConfigMaps',
                nav_secrets: 'Secrets',
                nav_namespaces: 'Namespaces',
                nav_nodes: 'Nodes',
                nav_events: 'Events',
                nav_pvcs: 'PVCs',
                nav_pvs: 'PVs',

                // Buttons
                btn_logs: 'Logs',
                btn_terminal: 'Terminal',
                btn_forward: 'Forward',
                btn_yaml: 'YAML',
                btn_describe: 'Describe',
                btn_analyze: 'Analyze',
                btn_delete: 'Delete',
                btn_scale: 'Scale',
                btn_restart: 'Restart',
                btn_refresh: 'Refresh',
                btn_save: 'Save',
                btn_cancel: 'Cancel',
                btn_close: 'Close',
                btn_approve: 'Approve',
                btn_reject: 'Reject',

                // Headers
                header_resources: 'Resources',
                header_workloads: 'Workloads',
                header_network: 'Network',
                header_config: 'Config',
                header_storage: 'Storage',
                header_cluster: 'Cluster',
                header_ai_assistant: 'AI Assistant',
                header_settings: 'Settings',
                header_audit_logs: 'Audit Logs',

                // Status
                status_running: 'Running',
                status_pending: 'Pending',
                status_failed: 'Failed',
                status_succeeded: 'Succeeded',
                status_unknown: 'Unknown',
                status_ready: 'Ready',
                status_not_ready: 'Not Ready',

                // Messages
                msg_loading: 'Loading...',
                msg_no_data: 'No data available',
                msg_error: 'Error',
                msg_success: 'Success',
                msg_confirm_delete: 'Are you sure you want to delete this resource?',
                msg_connection_test: 'Testing connection...',
                msg_connected: 'Connected',
                msg_disconnected: 'Disconnected',
                msg_settings_saved: 'Settings saved!',

                // AI
                ai_placeholder: 'Ask AI anything about your cluster...',
                ai_thinking: 'AI is thinking...',
                ai_approval_required: 'Approval Required',
                ai_command: 'Command',

                // Settings
                settings_general: 'General',
                settings_llm: 'AI/LLM',
                settings_appearance: 'Appearance',
                settings_language: 'Language',
                settings_provider: 'Provider',
                settings_model: 'Model',
                settings_endpoint: 'Endpoint',
                settings_api_key: 'API Key',
                settings_test_connection: 'Test Connection',

                // Reports
                report_generate: 'Generate Report',
                report_preview: 'Preview',
                report_download: 'Download',
                report_include_ai: 'Include AI Analysis',

                // Table Headers
                th_name: 'NAME',
                th_namespace: 'NAMESPACE',
                th_status: 'STATUS',
                th_ready: 'READY',
                th_restarts: 'RESTARTS',
                th_age: 'AGE',
                th_node: 'NODE',
                th_ip: 'IP',
                th_type: 'TYPE',
                th_ports: 'PORTS',
                th_actions: 'ACTIONS'
            },
            ko: {
                // Navigation
                nav_pods: 'íŒŒë“œ',
                nav_deployments: 'ë””í”Œë¡œì´ë¨¼íŠ¸',
                nav_daemonsets: 'ë°ëª¬ì…‹',
                nav_statefulsets: 'ìŠ¤í…Œì´íŠ¸í’€ì…‹',
                nav_replicasets: 'ë ˆí”Œë¦¬ì¹´ì…‹',
                nav_jobs: 'ìž¡',
                nav_cronjobs: 'í¬ë¡ ìž¡',
                nav_services: 'ì„œë¹„ìŠ¤',
                nav_ingresses: 'ì¸ê·¸ë ˆìŠ¤',
                nav_configmaps: 'ì»¨í”¼ê·¸ë§µ',
                nav_secrets: 'ì‹œí¬ë¦¿',
                nav_namespaces: 'ë„¤ìž„ìŠ¤íŽ˜ì´ìŠ¤',
                nav_nodes: 'ë…¸ë“œ',
                nav_events: 'ì´ë²¤íŠ¸',
                nav_pvcs: 'PVC',
                nav_pvs: 'PV',

                // Buttons
                btn_logs: 'ë¡œê·¸',
                btn_terminal: 'í„°ë¯¸ë„',
                btn_forward: 'í¬ì›Œë“œ',
                btn_yaml: 'YAML',
                btn_describe: 'ìƒì„¸ì •ë³´',
                btn_analyze: 'ë¶„ì„',
                btn_delete: 'ì‚­ì œ',
                btn_scale: 'ìŠ¤ì¼€ì¼',
                btn_restart: 'ìž¬ì‹œìž‘',
                btn_refresh: 'ìƒˆë¡œê³ ì¹¨',
                btn_save: 'ì €ìž¥',
                btn_cancel: 'ì·¨ì†Œ',
                btn_close: 'ë‹«ê¸°',
                btn_approve: 'ìŠ¹ì¸',
                btn_reject: 'ê±°ë¶€',

                // Headers
                header_resources: 'ë¦¬ì†ŒìŠ¤',
                header_workloads: 'ì›Œí¬ë¡œë“œ',
                header_network: 'ë„¤íŠ¸ì›Œí¬',
                header_config: 'ì„¤ì •',
                header_storage: 'ìŠ¤í† ë¦¬ì§€',
                header_cluster: 'í´ëŸ¬ìŠ¤í„°',
                header_ai_assistant: 'AI ì–´ì‹œìŠ¤í„´íŠ¸',
                header_settings: 'ì„¤ì •',
                header_audit_logs: 'ê°ì‚¬ ë¡œê·¸',

                // Status
                status_running: 'ì‹¤í–‰ ì¤‘',
                status_pending: 'ëŒ€ê¸° ì¤‘',
                status_failed: 'ì‹¤íŒ¨',
                status_succeeded: 'ì„±ê³µ',
                status_unknown: 'ì•Œ ìˆ˜ ì—†ìŒ',
                status_ready: 'ì¤€ë¹„ë¨',
                status_not_ready: 'ì¤€ë¹„ ì•ˆë¨',

                // Messages
                msg_loading: 'ë¡œë”© ì¤‘...',
                msg_no_data: 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤',
                msg_error: 'ì˜¤ë¥˜',
                msg_success: 'ì„±ê³µ',
                msg_confirm_delete: 'ì´ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                msg_connection_test: 'ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...',
                msg_connected: 'ì—°ê²°ë¨',
                msg_disconnected: 'ì—°ê²° ëŠê¹€',
                msg_settings_saved: 'ì„¤ì •ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤!',

                // AI
                ai_placeholder: 'í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•´ AIì—ê²Œ ì§ˆë¬¸í•˜ì„¸ìš”...',
                ai_thinking: 'AIê°€ ìƒê° ì¤‘ìž…ë‹ˆë‹¤...',
                ai_approval_required: 'ìŠ¹ì¸ í•„ìš”',
                ai_command: 'ëª…ë ¹ì–´',

                // Settings
                settings_general: 'ì¼ë°˜',
                settings_llm: 'AI/LLM',
                settings_appearance: 'ì™¸ê´€',
                settings_language: 'ì–¸ì–´',
                settings_provider: 'ì œê³µìž',
                settings_model: 'ëª¨ë¸',
                settings_endpoint: 'ì—”ë“œí¬ì¸íŠ¸',
                settings_api_key: 'API í‚¤',
                settings_test_connection: 'ì—°ê²° í…ŒìŠ¤íŠ¸',

                // Reports
                report_generate: 'ë¦¬í¬íŠ¸ ìƒì„±',
                report_preview: 'ë¯¸ë¦¬ë³´ê¸°',
                report_download: 'ë‹¤ìš´ë¡œë“œ',
                report_include_ai: 'AI ë¶„ì„ í¬í•¨',

                // Table Headers
                th_name: 'ì´ë¦„',
                th_namespace: 'ë„¤ìž„ìŠ¤íŽ˜ì´ìŠ¤',
                th_status: 'ìƒíƒœ',
                th_ready: 'ì¤€ë¹„',
                th_restarts: 'ìž¬ì‹œìž‘',
                th_age: 'ë‚˜ì´',
                th_node: 'ë…¸ë“œ',
                th_ip: 'IP',
                th_type: 'ìœ í˜•',
                th_ports: 'í¬íŠ¸',
                th_actions: 'ìž‘ì—…'
            },
            zh: {
                // Navigation
                nav_pods: 'Pods',
                nav_deployments: 'Deployments',
                nav_daemonsets: 'DaemonSets',
                nav_statefulsets: 'StatefulSets',
                nav_replicasets: 'ReplicaSets',
                nav_jobs: 'Jobs',
                nav_cronjobs: 'CronJobs',
                nav_services: 'æœåŠ¡',
                nav_ingresses: 'å…¥å£',
                nav_configmaps: 'é…ç½®æ˜ å°„',
                nav_secrets: 'å¯†é’¥',
                nav_namespaces: 'å‘½åç©ºé—´',
                nav_nodes: 'èŠ‚ç‚¹',
                nav_events: 'äº‹ä»¶',
                nav_pvcs: 'PVC',
                nav_pvs: 'PV',

                // Buttons
                btn_logs: 'æ—¥å¿—',
                btn_terminal: 'ç»ˆç«¯',
                btn_forward: 'è½¬å‘',
                btn_yaml: 'YAML',
                btn_describe: 'æè¿°',
                btn_analyze: 'åˆ†æž',
                btn_delete: 'åˆ é™¤',
                btn_scale: 'æ‰©ç¼©',
                btn_restart: 'é‡å¯',
                btn_refresh: 'åˆ·æ–°',
                btn_save: 'ä¿å­˜',
                btn_cancel: 'å–æ¶ˆ',
                btn_close: 'å…³é—­',
                btn_approve: 'æ‰¹å‡†',
                btn_reject: 'æ‹’ç»',

                // Headers
                header_resources: 'èµ„æº',
                header_workloads: 'å·¥ä½œè´Ÿè½½',
                header_network: 'ç½‘ç»œ',
                header_config: 'é…ç½®',
                header_storage: 'å­˜å‚¨',
                header_cluster: 'é›†ç¾¤',
                header_ai_assistant: 'AI åŠ©æ‰‹',
                header_settings: 'è®¾ç½®',
                header_audit_logs: 'å®¡è®¡æ—¥å¿—',

                // Status
                status_running: 'è¿è¡Œä¸­',
                status_pending: 'ç­‰å¾…ä¸­',
                status_failed: 'å¤±è´¥',
                status_succeeded: 'æˆåŠŸ',
                status_unknown: 'æœªçŸ¥',
                status_ready: 'å°±ç»ª',
                status_not_ready: 'æœªå°±ç»ª',

                // Messages
                msg_loading: 'åŠ è½½ä¸­...',
                msg_no_data: 'æš‚æ— æ•°æ®',
                msg_error: 'é”™è¯¯',
                msg_success: 'æˆåŠŸ',
                msg_confirm_delete: 'ç¡®å®šè¦åˆ é™¤æ­¤èµ„æºå—ï¼Ÿ',
                msg_connection_test: 'æµ‹è¯•è¿žæŽ¥ä¸­...',
                msg_connected: 'å·²è¿žæŽ¥',
                msg_disconnected: 'å·²æ–­å¼€',
                msg_settings_saved: 'è®¾ç½®å·²ä¿å­˜ï¼',

                // AI
                ai_placeholder: 'å‘ AI è¯¢é—®æœ‰å…³é›†ç¾¤çš„ä»»ä½•é—®é¢˜...',
                ai_thinking: 'AI æ­£åœ¨æ€è€ƒ...',
                ai_approval_required: 'éœ€è¦æ‰¹å‡†',
                ai_command: 'å‘½ä»¤',

                // Settings
                settings_general: 'å¸¸è§„',
                settings_llm: 'AI/LLM',
                settings_appearance: 'å¤–è§‚',
                settings_language: 'è¯­è¨€',
                settings_provider: 'æä¾›å•†',
                settings_model: 'æ¨¡åž‹',
                settings_endpoint: 'ç«¯ç‚¹',
                settings_api_key: 'API å¯†é’¥',
                settings_test_connection: 'æµ‹è¯•è¿žæŽ¥',

                // Reports
                report_generate: 'ç”ŸæˆæŠ¥å‘Š',
                report_preview: 'é¢„è§ˆ',
                report_download: 'ä¸‹è½½',
                report_include_ai: 'åŒ…å« AI åˆ†æž',

                // Table Headers
                th_name: 'åç§°',
                th_namespace: 'å‘½åç©ºé—´',
                th_status: 'çŠ¶æ€',
                th_ready: 'å°±ç»ª',
                th_restarts: 'é‡å¯',
                th_age: 'æ—¶é—´',
                th_node: 'èŠ‚ç‚¹',
                th_ip: 'IP',
                th_type: 'ç±»åž‹',
                th_ports: 'ç«¯å£',
                th_actions: 'æ“ä½œ'
            },
            ja: {
                // Navigation
                nav_pods: 'ãƒãƒƒãƒ‰',
                nav_deployments: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ',
                nav_daemonsets: 'ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚»ãƒƒãƒˆ',
                nav_statefulsets: 'ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ã‚»ãƒƒãƒˆ',
                nav_replicasets: 'ãƒ¬ãƒ—ãƒªã‚«ã‚»ãƒƒãƒˆ',
                nav_jobs: 'ã‚¸ãƒ§ãƒ–',
                nav_cronjobs: 'ã‚¯ãƒ­ãƒ³ã‚¸ãƒ§ãƒ–',
                nav_services: 'ã‚µãƒ¼ãƒ“ã‚¹',
                nav_ingresses: 'ã‚¤ãƒ³ã‚°ãƒ¬ã‚¹',
                nav_configmaps: 'ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒžãƒƒãƒ—',
                nav_secrets: 'ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ',
                nav_namespaces: 'åå‰ç©ºé–“',
                nav_nodes: 'ãƒŽãƒ¼ãƒ‰',
                nav_events: 'ã‚¤ãƒ™ãƒ³ãƒˆ',
                nav_pvcs: 'PVC',
                nav_pvs: 'PV',

                // Buttons
                btn_logs: 'ãƒ­ã‚°',
                btn_terminal: 'ã‚¿ãƒ¼ãƒŸãƒŠãƒ«',
                btn_forward: 'è»¢é€',
                btn_yaml: 'YAML',
                btn_describe: 'è©³ç´°',
                btn_analyze: 'åˆ†æž',
                btn_delete: 'å‰Šé™¤',
                btn_scale: 'ã‚¹ã‚±ãƒ¼ãƒ«',
                btn_restart: 'å†èµ·å‹•',
                btn_refresh: 'æ›´æ–°',
                btn_save: 'ä¿å­˜',
                btn_cancel: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
                btn_close: 'é–‰ã˜ã‚‹',
                btn_approve: 'æ‰¿èª',
                btn_reject: 'æ‹’å¦',

                // Headers
                header_resources: 'ãƒªã‚½ãƒ¼ã‚¹',
                header_workloads: 'ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰',
                header_network: 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯',
                header_config: 'è¨­å®š',
                header_storage: 'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸',
                header_cluster: 'ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼',
                header_ai_assistant: 'AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ',
                header_settings: 'è¨­å®š',
                header_audit_logs: 'ç›£æŸ»ãƒ­ã‚°',

                // Status
                status_running: 'å®Ÿè¡Œä¸­',
                status_pending: 'ä¿ç•™ä¸­',
                status_failed: 'å¤±æ•—',
                status_succeeded: 'æˆåŠŸ',
                status_unknown: 'ä¸æ˜Ž',
                status_ready: 'æº–å‚™å®Œäº†',
                status_not_ready: 'æº–å‚™æœªå®Œ',

                // Messages
                msg_loading: 'èª­ã¿è¾¼ã¿ä¸­...',
                msg_no_data: 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“',
                msg_error: 'ã‚¨ãƒ©ãƒ¼',
                msg_success: 'æˆåŠŸ',
                msg_confirm_delete: 'ã“ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
                msg_connection_test: 'æŽ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆä¸­...',
                msg_connected: 'æŽ¥ç¶šæ¸ˆã¿',
                msg_disconnected: 'åˆ‡æ–­',
                msg_settings_saved: 'è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼',

                // AI
                ai_placeholder: 'ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ã¤ã„ã¦AIã«è³ªå•...',
                ai_thinking: 'AIãŒè€ƒãˆä¸­...',
                ai_approval_required: 'æ‰¿èªãŒå¿…è¦',
                ai_command: 'ã‚³ãƒžãƒ³ãƒ‰',

                // Settings
                settings_general: 'ä¸€èˆ¬',
                settings_llm: 'AI/LLM',
                settings_appearance: 'å¤–è¦³',
                settings_language: 'è¨€èªž',
                settings_provider: 'ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼',
                settings_model: 'ãƒ¢ãƒ‡ãƒ«',
                settings_endpoint: 'ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ',
                settings_api_key: 'API ã‚­ãƒ¼',
                settings_test_connection: 'æŽ¥ç¶šãƒ†ã‚¹ãƒˆ',

                // Reports
                report_generate: 'ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ',
                report_preview: 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼',
                report_download: 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
                report_include_ai: 'AI åˆ†æžã‚’å«ã‚€',

                // Table Headers
                th_name: 'åå‰',
                th_namespace: 'åå‰ç©ºé–“',
                th_status: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
                th_ready: 'æº–å‚™',
                th_restarts: 'å†èµ·å‹•',
                th_age: 'çµŒéŽ',
                th_node: 'ãƒŽãƒ¼ãƒ‰',
                th_ip: 'IP',
                th_type: 'ã‚¿ã‚¤ãƒ—',
                th_ports: 'ãƒãƒ¼ãƒˆ',
                th_actions: 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³'
            }
        };

        // i18n helper function
        function t(key) {
            const lang = translations[currentLanguage] || translations['en'];
            return lang[key] || translations['en'][key] || key;
        }

        // Update UI language
        function updateUILanguage() {
            // Update AI placeholder
            const aiInput = document.getElementById('ai-input');
            if (aiInput) aiInput.placeholder = t('ai_placeholder');

            // Update sidebar navigation (dynamic elements need special handling)
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });
        }

        // Auto-refresh settings (default to enabled with 30s interval)
        let autoRefreshEnabled = localStorage.getItem('k13d_auto_refresh') !== 'false'; // default true
        let autoRefreshInterval = parseInt(localStorage.getItem('k13d_refresh_interval')) || 30; // seconds
        let autoRefreshTimer = null;

        // SSE streaming settings
        let useStreaming = localStorage.getItem('k13d_use_streaming') !== 'false'; // default true
        let currentEventSource = null;

        // Reasoning effort setting (for Solar Pro2)
        let reasoningEffort = localStorage.getItem('k13d_reasoning_effort') || 'minimal'; // default minimal

        // Table headers for all resource types
        const tableHeaders = {
            pods: ['NAME', 'NAMESPACE', 'READY', 'STATUS', 'RESTARTS', 'AGE', 'IP'],
            deployments: ['NAME', 'NAMESPACE', 'READY', 'UP-TO-DATE', 'AVAILABLE', 'AGE'],
            daemonsets: ['NAME', 'NAMESPACE', 'DESIRED', 'CURRENT', 'READY', 'AGE'],
            statefulsets: ['NAME', 'NAMESPACE', 'READY', 'AGE'],
            replicasets: ['NAME', 'NAMESPACE', 'DESIRED', 'CURRENT', 'READY', 'AGE'],
            jobs: ['NAME', 'NAMESPACE', 'COMPLETIONS', 'DURATION', 'AGE'],
            cronjobs: ['NAME', 'NAMESPACE', 'SCHEDULE', 'SUSPEND', 'ACTIVE', 'LAST SCHEDULE'],
            services: ['NAME', 'NAMESPACE', 'TYPE', 'CLUSTER-IP', 'PORTS', 'AGE'],
            ingresses: ['NAME', 'NAMESPACE', 'CLASS', 'HOSTS', 'ADDRESS', 'AGE'],
            networkpolicies: ['NAME', 'NAMESPACE', 'POD-SELECTOR', 'AGE'],
            configmaps: ['NAME', 'NAMESPACE', 'DATA', 'AGE'],
            secrets: ['NAME', 'NAMESPACE', 'TYPE', 'DATA', 'AGE'],
            serviceaccounts: ['NAME', 'NAMESPACE', 'SECRETS', 'AGE'],
            persistentvolumes: ['NAME', 'CAPACITY', 'ACCESS MODES', 'RECLAIM POLICY', 'STATUS', 'CLAIM'],
            persistentvolumeclaims: ['NAME', 'NAMESPACE', 'STATUS', 'VOLUME', 'CAPACITY', 'ACCESS MODES'],
            nodes: ['NAME', 'STATUS', 'ROLES', 'VERSION', 'AGE'],
            namespaces: ['NAME', 'STATUS', 'AGE'],
            events: ['NAME', 'TYPE', 'REASON', 'MESSAGE', 'COUNT', 'LAST SEEN'],
            roles: ['NAME', 'NAMESPACE', 'AGE'],
            rolebindings: ['NAME', 'NAMESPACE', 'ROLE', 'AGE'],
            clusterroles: ['NAME', 'AGE'],
            clusterrolebindings: ['NAME', 'ROLE', 'AGE']
        };

        // All supported resource types
        const allResources = [
            'pods', 'deployments', 'daemonsets', 'statefulsets', 'replicasets', 'jobs', 'cronjobs',
            'services', 'ingresses', 'networkpolicies',
            'configmaps', 'secrets', 'serviceaccounts',
            'persistentvolumes', 'persistentvolumeclaims',
            'nodes', 'namespaces', 'events',
            'roles', 'rolebindings', 'clusterroles', 'clusterrolebindings'
        ];

        // Cluster-scoped resources (no namespace)
        const clusterScopedResources = ['nodes', 'namespaces', 'persistentvolumes', 'clusterroles', 'clusterrolebindings'];

        // Custom Resource state
        let loadedCRDs = []; // List of CRDs with their info
        let currentCRD = null; // Currently selected CRD (for viewing instances)

        // Sorting and Pagination State
        let sortColumn = null;
        let sortDirection = 'asc'; // 'asc' or 'desc'
        let currentPage = 1;
        let pageSize = 50;
        let allItems = []; // All items before pagination
        let filteredItems = []; // Items after filtering

        // Column filter state
        let columnFiltersVisible = false;
        let columnFilters = {}; // { 'NAME': 'nginx', 'STATUS': 'Running' }

        // Field mapping for sorting (header name -> item property)
        const fieldMapping = {
            'NAME': 'name',
            'NAMESPACE': 'namespace',
            'READY': 'ready',
            'STATUS': 'status',
            'RESTARTS': 'restarts',
            'AGE': 'age',
            'IP': 'ip',
            'UP-TO-DATE': 'upToDate',
            'AVAILABLE': 'available',
            'DESIRED': 'desired',
            'CURRENT': 'current',
            'COMPLETIONS': 'completions',
            'DURATION': 'duration',
            'SCHEDULE': 'schedule',
            'SUSPEND': 'suspend',
            'ACTIVE': 'active',
            'LAST SCHEDULE': 'lastSchedule',
            'TYPE': 'type',
            'CLUSTER-IP': 'clusterIP',
            'PORTS': 'ports',
            'CLASS': 'class',
            'HOSTS': 'hosts',
            'ADDRESS': 'address',
            'POD-SELECTOR': 'podSelector',
            'DATA': 'data',
            'SECRETS': 'secrets',
            'CAPACITY': 'capacity',
            'ACCESS MODES': 'accessModes',
            'RECLAIM POLICY': 'reclaimPolicy',
            'CLAIM': 'claim',
            'VOLUME': 'volume',
            'ROLES': 'roles',
            'VERSION': 'version',
            'REASON': 'reason',
            'MESSAGE': 'message',
            'COUNT': 'count',
            'LAST SEEN': 'lastSeen',
            'ROLE': 'role'
        };

        // Sort items by column
        function sortItems(items, column, direction) {
            const field = fieldMapping[column] || column.toLowerCase().replace(/[- ]/g, '');
            return [...items].sort((a, b) => {
                let valA = a[field];
                let valB = b[field];

                // Handle age sorting (convert to comparable values)
                if (column === 'AGE' || column === 'LAST SEEN' || column === 'DURATION') {
                    valA = parseAgeToSeconds(valA);
                    valB = parseAgeToSeconds(valB);
                }
                // Handle numeric fields
                else if (column === 'RESTARTS' || column === 'COUNT' || column === 'DESIRED' ||
                         column === 'CURRENT' || column === 'AVAILABLE' || column === 'ACTIVE' ||
                         column === 'DATA' || column === 'SECRETS') {
                    valA = parseInt(valA) || 0;
                    valB = parseInt(valB) || 0;
                }
                // Handle ready format (e.g., "1/1")
                else if (column === 'READY' || column === 'COMPLETIONS') {
                    valA = parseReadyValue(valA);
                    valB = parseReadyValue(valB);
                }
                // Handle strings (case-insensitive)
                else {
                    valA = (valA || '').toString().toLowerCase();
                    valB = (valB || '').toString().toLowerCase();
                }

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // Parse age string to seconds for sorting
        function parseAgeToSeconds(age) {
            if (!age || age === '-') return 0;
            const str = age.toString();
            const match = str.match(/(\d+)([smhd])/);
            if (!match) return 0;
            const value = parseInt(match[1]);
            const unit = match[2];
            switch (unit) {
                case 's': return value;
                case 'm': return value * 60;
                case 'h': return value * 3600;
                case 'd': return value * 86400;
                default: return value;
            }
        }

        // Parse ready value (e.g., "1/1" -> 1)
        function parseReadyValue(ready) {
            if (!ready || ready === '-') return 0;
            const parts = ready.toString().split('/');
            return parseInt(parts[0]) || 0;
        }

        // Handle column header click for sorting
        function onColumnSort(column, headerElement) {
            // Toggle direction if same column, otherwise default to asc
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // Update header styling
            document.querySelectorAll('#table-header th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            headerElement.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');

            // Re-render with sorted data
            currentPage = 1;
            applyFilterAndSort();
        }

        // Apply filter and sort to items
        function applyFilterAndSort() {
            const filterText = document.getElementById('filter-input').value.toLowerCase();

            // Filter items by global filter
            filteredItems = allItems.filter(item => {
                if (!filterText) return true;
                return Object.values(item).some(val =>
                    val && val.toString().toLowerCase().includes(filterText)
                );
            });

            // Apply column-specific filters
            const activeColumnFilters = Object.entries(columnFilters).filter(([_, v]) => v && v.trim());
            if (activeColumnFilters.length > 0) {
                filteredItems = filteredItems.filter(item => {
                    return activeColumnFilters.every(([column, filterVal]) => {
                        const field = fieldMapping[column] || column.toLowerCase().replace(/[- ]/g, '');
                        const itemValue = item[field];
                        if (itemValue === undefined || itemValue === null) return false;
                        return itemValue.toString().toLowerCase().includes(filterVal.toLowerCase());
                    });
                });
            }

            // Sort items
            if (sortColumn) {
                filteredItems = sortItems(filteredItems, sortColumn, sortDirection);
            }

            // Render current page
            renderCurrentPage();

            // Update active column filters display
            updateActiveColumnFiltersDisplay();
        }

        // Toggle column filters visibility
        function toggleColumnFilters() {
            columnFiltersVisible = !columnFiltersVisible;
            const filterRow = document.getElementById('column-filter-row');
            const toggleBtn = document.getElementById('column-filter-toggle');

            if (filterRow) {
                filterRow.classList.toggle('active', columnFiltersVisible);
            }
            if (toggleBtn) {
                toggleBtn.classList.toggle('active', columnFiltersVisible);
            }

            // Focus first filter input when showing
            if (columnFiltersVisible && filterRow) {
                const firstInput = filterRow.querySelector('.column-filter-input');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 50);
                }
            }
        }

        // Handle column filter input change
        function onColumnFilterChange(event, column) {
            const value = event.target.value;
            columnFilters[column] = value;

            // Debounce the filter application
            clearTimeout(window.columnFilterTimeout);
            window.columnFilterTimeout = setTimeout(() => {
                currentPage = 1;
                applyFilterAndSort();
            }, 200);
        }

        // Update the active column filters chips display
        function updateActiveColumnFiltersDisplay() {
            const container = document.getElementById('active-column-filters');
            if (!container) return;

            const activeFilters = Object.entries(columnFilters).filter(([_, v]) => v && v.trim());

            if (activeFilters.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = activeFilters.map(([col, val]) =>
                `<span class="column-filter-chip">
                    <span class="col-name">${col}:</span>
                    <span>${val}</span>
                    <span class="remove-col-filter" onclick="clearColumnFilter('${col}')">&times;</span>
                </span>`
            ).join('');
        }

        // Clear a specific column filter
        function clearColumnFilter(column) {
            delete columnFilters[column];

            // Update the input field if visible
            const input = document.querySelector(`.column-filter-input[data-column="${column}"]`);
            if (input) {
                input.value = '';
            }

            currentPage = 1;
            applyFilterAndSort();
        }

        // Clear all column filters
        function clearAllColumnFilters() {
            columnFilters = {};

            // Clear all input fields
            document.querySelectorAll('.column-filter-input').forEach(input => {
                input.value = '';
            });

            currentPage = 1;
            applyFilterAndSort();
        }

        // Render current page of items
        function renderCurrentPage() {
            const totalItems = filteredItems.length;
            const totalPages = pageSize === -1 ? 1 : Math.ceil(totalItems / pageSize);
            currentPage = Math.min(currentPage, Math.max(1, totalPages));

            // Get items for current page
            let pageItems;
            if (pageSize === -1) {
                pageItems = filteredItems;
            } else {
                const startIdx = (currentPage - 1) * pageSize;
                const endIdx = startIdx + pageSize;
                pageItems = filteredItems.slice(startIdx, endIdx);
            }

            // Render table body
            renderTableBody(currentResource, pageItems);

            // Update pagination info
            updatePaginationUI(totalItems, totalPages);
        }

        // Update pagination UI
        function updatePaginationUI(totalItems, totalPages) {
            const startItem = totalItems === 0 ? 0 : (currentPage - 1) * (pageSize === -1 ? totalItems : pageSize) + 1;
            const endItem = pageSize === -1 ? totalItems : Math.min(currentPage * pageSize, totalItems);

            document.getElementById('pagination-info').textContent =
                `Showing ${startItem}-${endItem} of ${totalItems} items`;
            document.getElementById('page-indicator').textContent = `${currentPage} / ${totalPages || 1}`;

            document.getElementById('prev-page-btn').disabled = currentPage <= 1;
            document.getElementById('next-page-btn').disabled = currentPage >= totalPages;
        }

        // Pagination controls
        function goToNextPage() {
            currentPage++;
            renderCurrentPage();
        }

        function goToPrevPage() {
            currentPage--;
            renderCurrentPage();
        }

        function onPageSizeChange() {
            pageSize = parseInt(document.getElementById('page-size-select').value);
            currentPage = 1;
            renderCurrentPage();
        }

        // Initialize
        async function init() {
            if (authToken) {
                try {
                    const health = await fetch('/api/health').then(r => r.json());
                    if (health.auth_enabled) {
                        const user = await fetchWithAuth('/api/auth/me').then(r => r.json());
                        currentUser = user;
                        showApp();
                    } else {
                        showApp();
                    }
                } catch (e) {
                    showLogin();
                }
            } else {
                // Check if auth is enabled
                const health = await fetch('/api/health').then(r => r.json());
                if (!health.auth_enabled) {
                    authToken = 'anonymous';
                    showApp();
                } else {
                    showLogin();
                }
            }
        }

        async function showLogin() {
            document.getElementById('login-page').style.display = 'flex';
            document.getElementById('app').classList.remove('active');

            // Fetch auth status to determine environment and auth mode
            try {
                const status = await fetch('/api/auth/status').then(r => r.json());
                updateLoginPageForAuthMode(status);
            } catch (e) {
                console.error('Failed to fetch auth status:', e);
                // Default to showing token form
                document.getElementById('token-login-form').style.display = 'block';
                document.getElementById('password-login-form').style.display = 'none';
            }
        }

        // Update login page UI based on auth mode (token vs local)
        function updateLoginPageForAuthMode(status) {
            const authModeEl = document.getElementById('auth-mode-indicator');
            const tokenForm = document.getElementById('token-login-form');
            const passwordForm = document.getElementById('password-login-form');

            const authMode = status.auth_mode || status.mode || 'token';

            if (authMode === 'token') {
                // Token authentication mode - show token form only
                authModeEl.className = 'auth-mode-indicator token-mode';
                authModeEl.innerHTML = 'ðŸ” Kubernetes Token ì¸ì¦ ëª¨ë“œ';
                tokenForm.style.display = 'block';
                passwordForm.style.display = 'none';

                // Focus on token input
                setTimeout(() => {
                    document.getElementById('login-token').focus();
                }, 100);
            } else if (authMode === 'local') {
                // Local authentication mode - show password form only
                authModeEl.className = 'auth-mode-indicator local-mode';
                authModeEl.innerHTML = 'ðŸ‘¤ ë¡œì»¬ ê³„ì • ì¸ì¦ ëª¨ë“œ';
                tokenForm.style.display = 'none';
                passwordForm.style.display = 'block';

                // Focus on username input
                setTimeout(() => {
                    document.getElementById('login-username').focus();
                }, 100);
            } else {
                // Default or mixed mode - show token form
                authModeEl.style.display = 'none';
                tokenForm.style.display = 'block';
                passwordForm.style.display = 'none';
            }
        }

        // Handle Enter key in token textarea
        function handleTokenKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                loginWithToken();
            }
        }

        // Handle Enter key in password form
        function handlePasswordKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                login();
            }
        }

        // Toggle token help dropdown
        function toggleTokenHelp() {
            const box = document.getElementById('token-help-box');
            if (box) {
                box.classList.toggle('expanded');
            }
        }

        // Login with kubeconfig credentials (local mode only)
        async function loginWithKubeconfig() {
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';

            try {
                const resp = await fetch('/api/auth/kubeconfig', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await resp.json();
                if (resp.ok) {
                    authToken = data.token;
                    localStorage.setItem('k13d_token', authToken);
                    currentUser = { username: data.username, role: data.role };
                    showApp();
                } else {
                    errorEl.textContent = data.error || 'Kubeconfig login failed';
                }
            } catch (e) {
                errorEl.textContent = 'Login failed: ' + e.message;
            }
        }

        function showApp() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app').classList.add('active');
            if (currentUser) {
                document.getElementById('user-badge').textContent = currentUser.username;
            } else if (authToken === 'anonymous') {
                document.getElementById('user-badge').textContent = 'anonymous';
                // Hide logout button when auth is disabled
                document.getElementById('logout-btn').style.display = 'none';
            }
            // Restore sidebar state
            if (sidebarCollapsed) {
                document.getElementById('sidebar').classList.add('collapsed');
                document.getElementById('hamburger-btn').classList.add('active');
            }
            // Restore debug mode
            if (debugMode) {
                document.getElementById('debug-panel').classList.add('active');
                document.getElementById('debug-toggle').style.background = 'var(--accent-purple)';
            }
            loadNamespaces();
            loadData();
            setupResizeHandle();
            setupHealthCheck();
            // Initialize auto-refresh
            updateAutoRefreshUI();
            updateLastRefreshTime();
            if (autoRefreshEnabled) {
                startAutoRefresh();
            }
            // Initialize AI status (model name and connection status)
            updateAIStatus();
        }

        // Login tab switching
        function switchLoginTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));

            if (tab === 'token') {
                document.querySelector('.login-tab:first-child').classList.add('active');
                document.getElementById('token-login-form').classList.add('active');
            } else {
                document.querySelector('.login-tab:last-child').classList.add('active');
                document.getElementById('password-login-form').classList.add('active');
            }
        }

        // Token-based login (K8s RBAC)
        async function loginWithToken() {
            const token = document.getElementById('login-token').value.trim();
            if (!token) {
                document.getElementById('login-error').textContent = 'Please enter a token';
                return;
            }

            try {
                const resp = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });

                const data = await resp.json();
                if (resp.ok) {
                    authToken = data.token;
                    localStorage.setItem('k13d_token', authToken);
                    currentUser = { username: data.username, role: data.role };
                    showApp();
                } else {
                    document.getElementById('login-error').textContent = data.error || 'Invalid token';
                }
            } catch (e) {
                document.getElementById('login-error').textContent = 'Login failed: ' + e.message;
            }
        }

        // Username/password login
        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            try {
                const resp = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (resp.ok) {
                    const data = await resp.json();
                    authToken = data.token;
                    localStorage.setItem('k13d_token', authToken);
                    currentUser = { username: data.username, role: data.role };
                    showApp();
                } else {
                    document.getElementById('login-error').textContent = 'Invalid credentials';
                }
            } catch (e) {
                document.getElementById('login-error').textContent = 'Login failed';
            }
        }

        async function logout() {
            try {
                // Send logout request with credentials (cookies) and auth header
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include',
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                });
            } catch (e) {
                console.error('Logout request failed:', e);
            }
            // Clear local storage and state regardless of server response
            localStorage.removeItem('k13d_token');
            localStorage.removeItem('k13d_auto_refresh');
            localStorage.removeItem('k13d_refresh_interval');
            authToken = null;
            currentUser = null;
            // Stop auto-refresh timer
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
            location.reload();
        }

        async function fetchWithAuth(url, options = {}) {
            const headers = { ...options.headers };
            if (authToken && authToken !== 'anonymous') {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            return fetch(url, { ...options, headers });
        }

        async function loadNamespaces() {
            try {
                const resp = await fetchWithAuth('/api/k8s/namespaces');
                const data = await resp.json();
                const select = document.getElementById('namespace-select');
                select.innerHTML = '<option value="">All Namespaces</option>';
                if (data.items) {
                    data.items.forEach(ns => {
                        const option = document.createElement('option');
                        option.value = ns.name;
                        option.textContent = ns.name;
                        select.appendChild(option);
                    });
                }
            } catch (e) {
                console.error('Failed to load namespaces:', e);
            }
        }

        async function loadData() {
            for (const resource of allResources) {
                try {
                    const isClusterScoped = clusterScopedResources.includes(resource);
                    const ns = isClusterScoped ? '' : currentNamespace;
                    const url = ns ? `/api/k8s/${resource}?namespace=${ns}` : `/api/k8s/${resource}`;
                    const resp = await fetchWithAuth(url);

                    if (!resp.ok) {
                        console.error(`API error for ${resource}: ${resp.status}`);
                        continue;
                    }

                    const data = await resp.json();

                    // Check for API error in response
                    if (data.error) {
                        console.error(`API returned error for ${resource}:`, data.error);
                        continue;
                    }

                    const countEl = document.getElementById(`${resource}-count`);
                    if (countEl) {
                        countEl.textContent = data.items ? data.items.length : 0;
                    }
                    if (resource === currentResource) {
                        renderTable(resource, data.items || []);
                    }
                } catch (e) {
                    console.error(`Failed to load ${resource}:`, e);
                }
            }

            // Also load CRDs
            loadCRDs();
        }

        // Load Custom Resource Definitions
        async function loadCRDs() {
            try {
                const resp = await fetchWithAuth('/api/crd/');
                const data = await resp.json();

                // Check for server error response
                if (data.error) {
                    console.error('CRD API error:', data.error);
                    document.getElementById('crd-count').textContent = '-';
                    // Show user-friendly message for common permission error
                    const errorMsg = data.error.includes('forbidden') || data.error.includes('Forbidden')
                        ? 'No permission'
                        : 'Error loading';
                    document.getElementById('crd-nav-items').innerHTML = `<div style="font-size: 11px; color: var(--accent-yellow); padding: 4px 8px;" title="${escapeHtml(data.error)}">${errorMsg}</div>`;
                    return;
                }

                if (data.items && data.items.length > 0) {
                    loadedCRDs = data.items;
                    document.getElementById('crd-count').textContent = data.items.length;

                    // Group CRDs by group for better organization
                    const grouped = {};
                    data.items.forEach(crd => {
                        const group = crd.group || 'core';
                        if (!grouped[group]) grouped[group] = [];
                        grouped[group].push(crd);
                    });

                    // Render CRD nav items (limited to first 10 for performance)
                    const container = document.getElementById('crd-nav-items');
                    const sortedGroups = Object.keys(grouped).sort();
                    let html = '';
                    let count = 0;

                    for (const group of sortedGroups) {
                        for (const crd of grouped[group]) {
                            if (count >= 15) break; // Limit to 15 items
                            const shortGroup = group.split('.')[0];
                            html += `<div class="nav-item" data-crd="${crd.name}" onclick="switchToCRD('${crd.name}')" title="${crd.name}">
                                <span style="font-size: 11px;">${crd.kind}</span>
                                <span class="count" style="font-size: 9px; opacity: 0.7;">${shortGroup}</span>
                            </div>`;
                            count++;
                        }
                        if (count >= 15) break;
                    }

                    if (data.items.length > 15) {
                        html += `<div class="nav-item" onclick="showAllCRDs()" style="font-style: italic; opacity: 0.8;">
                            <span>View all ${data.items.length} CRDs...</span>
                        </div>`;
                    }

                    container.innerHTML = html;
                } else {
                    document.getElementById('crd-count').textContent = '0';
                    document.getElementById('crd-nav-items').innerHTML = '<div style="font-size: 11px; color: var(--text-secondary); padding: 4px 8px;">No CRDs found</div>';
                }
            } catch (e) {
                console.error('Failed to load CRDs:', e);
                document.getElementById('crd-nav-items').innerHTML = '<div style="font-size: 11px; color: var(--accent-red); padding: 4px 8px;">Failed to load</div>';
            }
        }

        // Switch to viewing a Custom Resource's instances
        async function switchToCRD(crdName) {
            currentCRD = loadedCRDs.find(c => c.name === crdName);
            if (!currentCRD) return;

            currentResource = `crd:${crdName}`;

            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-crd="${crdName}"]`)?.classList.add('active');

            // Update panel title
            document.getElementById('panel-title').textContent = `${currentCRD.kind} (${currentCRD.group})`;
            document.getElementById('resource-summary').innerHTML = '';

            // Clear filters
            columnFilters = {};
            sortColumn = null;
            sortDirection = 'asc';
            updateActiveColumnFiltersDisplay();

            // Load instances
            await loadCRDInstances(currentCRD);
        }

        // Load instances of a Custom Resource
        async function loadCRDInstances(crdInfo) {
            try {
                // For namespaced resources, use current namespace (empty = all namespaces)
                const ns = crdInfo.namespaced ? currentNamespace : '';
                const url = ns ? `/api/crd/${crdInfo.name}/instances?namespace=${encodeURIComponent(ns)}` : `/api/crd/${crdInfo.name}/instances`;

                console.log(`Loading CR instances: ${url} (namespaced: ${crdInfo.namespaced}, ns: "${ns}")`);

                const resp = await fetchWithAuth(url);

                if (!resp.ok) {
                    const errorText = await resp.text();
                    throw new Error(`HTTP ${resp.status}: ${errorText}`);
                }

                const data = await resp.json();
                console.log(`CR instances response:`, data);

                // Check for API error in response
                if (data.error) {
                    throw new Error(data.error);
                }

                // Set up table headers for this CR
                const headers = crdInfo.namespaced ?
                    ['NAME', 'NAMESPACE', 'STATUS', 'AGE'] :
                    ['NAME', 'STATUS', 'AGE'];

                // Store headers dynamically
                tableHeaders[`crd:${crdInfo.name}`] = headers;

                // Render table
                allItems = data.items || [];
                filteredItems = [...allItems];
                currentPage = 1;

                // Update summary for CRD instances
                const summaryEl = document.getElementById('resource-summary');
                if (summaryEl) {
                    summaryEl.innerHTML = `<span class="summary-item"><span class="summary-count">${allItems.length}</span> instances</span>`;
                }

                // Render headers with filter row
                const headerRow = `<tr>${headers.map(h => {
                    const sortClass = sortColumn === h ? (sortDirection === 'asc' ? 'sort-asc' : 'sort-desc') : '';
                    return `<th class="${sortClass}" onclick="onColumnSort('${h}', this)">${h}<span class="sort-icon"></span></th>`;
                }).join('')}</tr>`;

                const filterRow = `<tr class="column-filter-row ${columnFiltersVisible ? 'active' : ''}" id="column-filter-row">
                    ${headers.map(h => {
                        const filterValue = columnFilters[h] || '';
                        return `<th><input type="text" class="column-filter-input" placeholder="Filter ${h.toLowerCase()}..."
                            value="${filterValue}"
                            data-column="${h}"
                            onkeyup="onColumnFilterChange(event, '${h}')"
                            onclick="event.stopPropagation()"></th>`;
                    }).join('')}
                </tr>`;

                document.getElementById('table-header').innerHTML = headerRow + filterRow;

                if (!data.items || data.items.length === 0) {
                    const nsInfo = crdInfo.namespaced ? (ns ? ` in namespace "${ns}"` : ' (all namespaces)') : '';
                    document.getElementById('table-body').innerHTML =
                        `<tr><td colspan="${headers.length}" style="text-align:center;padding:40px;">
                            <div style="color:var(--text-secondary);">No ${crdInfo.kind} instances found${nsInfo}</div>
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:8px;">
                                CRD: ${crdInfo.group}/${crdInfo.version}
                            </div>
                        </td></tr>`;
                    updatePaginationUI(0, 0);
                    return;
                }

                applyFilterAndSort();
            } catch (e) {
                console.error('Failed to load CR instances:', e);
                const headers = crdInfo.namespaced ? ['NAME', 'NAMESPACE', 'STATUS', 'AGE'] : ['NAME', 'STATUS', 'AGE'];
                document.getElementById('table-body').innerHTML =
                    `<tr><td colspan="${headers.length}" style="text-align:center;padding:40px;">
                        <div style="color:var(--accent-red);">Failed to load ${crdInfo.kind} instances</div>
                        <div style="font-size:11px;color:var(--text-secondary);margin-top:8px;">${escapeHtml(e.message)}</div>
                    </td></tr>`;
            }
        }

        // Show all CRDs in a modal
        function showAllCRDs() {
            let html = `
                <div class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal detail-modal" style="max-width: 800px;" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>All Custom Resource Definitions (${loadedCRDs.length})</h3>
                            <button class="modal-close" onclick="closeAllModals()">&times;</button>
                        </div>
                        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                            <input type="text" id="crd-search" placeholder="Search CRDs..." style="width: 100%; padding: 8px; margin-bottom: 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);" oninput="filterCRDList(this.value)">
                            <div id="crd-list-container">
                                ${renderCRDList(loadedCRDs)}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const modalContainer = document.createElement('div');
            modalContainer.id = 'crd-modal';
            modalContainer.innerHTML = html;
            document.body.appendChild(modalContainer);
        }

        // Render CRD list for modal
        function renderCRDList(crds) {
            if (!crds || crds.length === 0) {
                return '<p style="color: var(--text-secondary);">No CRDs found</p>';
            }

            // Group by group
            const grouped = {};
            crds.forEach(crd => {
                const group = crd.group || 'core';
                if (!grouped[group]) grouped[group] = [];
                grouped[group].push(crd);
            });

            let html = '';
            const sortedGroups = Object.keys(grouped).sort();

            for (const group of sortedGroups) {
                html += `<div style="margin-bottom: 16px;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; border-bottom: 1px solid var(--border-color); padding-bottom: 4px;">${group}</div>`;

                for (const crd of grouped[group]) {
                    const shortNames = crd.shortNames?.length ? ` (${crd.shortNames.join(', ')})` : '';
                    const scope = crd.namespaced ? 'Namespaced' : 'Cluster';
                    html += `<div class="nav-item" style="margin: 4px 0; padding: 8px; cursor: pointer;" onclick="closeAllModals(); switchToCRD('${crd.name}')">
                        <div style="display: flex; justify-content: space-between; width: 100%;">
                            <span><strong>${crd.kind}</strong>${shortNames}</span>
                            <span style="font-size: 11px; color: var(--text-secondary);">${scope} â€¢ ${crd.version}</span>
                        </div>
                    </div>`;
                }

                html += '</div>';
            }

            return html;
        }

        // Filter CRD list in modal
        function filterCRDList(query) {
            const filtered = loadedCRDs.filter(crd => {
                const q = query.toLowerCase();
                return crd.name.toLowerCase().includes(q) ||
                       crd.kind.toLowerCase().includes(q) ||
                       crd.group.toLowerCase().includes(q) ||
                       (crd.shortNames || []).some(s => s.toLowerCase().includes(q));
            });
            document.getElementById('crd-list-container').innerHTML = renderCRDList(filtered);
        }

        function switchResource(resource) {
            currentResource = resource;

            // Clear column filters when switching resources
            columnFilters = {};

            // Reset sort when switching resources
            sortColumn = null;
            sortDirection = 'asc';

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.resource === resource);
            });
            document.getElementById('panel-title').textContent = resource.charAt(0).toUpperCase() + resource.slice(1);

            // Update active column filters display
            updateActiveColumnFiltersDisplay();

            loadData();
        }

        function onNamespaceChange() {
            currentNamespace = document.getElementById('namespace-select').value;
            loadData();
        }

        function refreshData() {
            loadData();
            updateLastRefreshTime();
        }

        // Auto-refresh functions
        function startAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            if (autoRefreshEnabled && autoRefreshInterval > 0) {
                autoRefreshTimer = setInterval(() => {
                    loadData();
                    updateLastRefreshTime();
                }, autoRefreshInterval * 1000);
                updateAutoRefreshUI();
            }
        }

        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
            updateAutoRefreshUI();
        }

        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            localStorage.setItem('k13d_auto_refresh', autoRefreshEnabled);
            if (autoRefreshEnabled) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        }

        function setAutoRefreshInterval(seconds) {
            autoRefreshInterval = Math.max(5, Math.min(300, seconds)); // 5s to 5min
            localStorage.setItem('k13d_refresh_interval', autoRefreshInterval);
            if (autoRefreshEnabled) {
                startAutoRefresh();
            }
        }

        function updateAutoRefreshUI() {
            const toggle = document.getElementById('auto-refresh-toggle');
            const intervalSelect = document.getElementById('refresh-interval');
            if (toggle) {
                toggle.classList.toggle('active', autoRefreshEnabled);
                toggle.title = autoRefreshEnabled
                    ? `Auto-refresh: ON (every ${autoRefreshInterval}s)`
                    : 'Auto-refresh: OFF';
            }
            if (intervalSelect) {
                intervalSelect.value = autoRefreshInterval;
            }
        }

        async function manualRefresh() {
            const btn = document.querySelector('.refresh-btn');
            if (btn) {
                btn.classList.add('spinning');
            }
            try {
                await loadData();
                updateLastRefreshTime();
            } finally {
                if (btn) {
                    setTimeout(() => btn.classList.remove('spinning'), 500);
                }
            }
        }

        function updateLastRefreshTime() {
            const el = document.getElementById('last-refresh-time');
            if (el) {
                el.textContent = new Date().toLocaleTimeString();
            }
        }

        function updateResourceSummary(resource, items) {
            const summaryEl = document.getElementById('resource-summary');
            if (!summaryEl) return;

            if (!items || items.length === 0) {
                summaryEl.innerHTML = '<span class="summary-item"><span class="summary-count">0</span> total</span>';
                return;
            }

            const total = items.length;
            let html = `<span class="summary-item"><span class="summary-count">${total}</span> total</span>`;

            // Resource-specific status breakdown
            if (resource === 'pods') {
                const statusCounts = {};
                items.forEach(item => {
                    const status = (item.status || 'Unknown').toLowerCase();
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                });
                const statusOrder = ['running', 'pending', 'succeeded', 'failed', 'unknown'];
                statusOrder.forEach(status => {
                    if (statusCounts[status]) {
                        html += `<span class="summary-item"><span class="summary-count status-${status}">${statusCounts[status]}</span> ${status}</span>`;
                    }
                });
                // Handle other statuses
                Object.keys(statusCounts).forEach(status => {
                    if (!statusOrder.includes(status) && statusCounts[status]) {
                        html += `<span class="summary-item"><span class="summary-count">${statusCounts[status]}</span> ${status}</span>`;
                    }
                });
            } else if (resource === 'deployments' || resource === 'statefulsets' || resource === 'replicasets') {
                let ready = 0, notReady = 0;
                items.forEach(item => {
                    const readyStr = String(item.ready || '0/0');
                    const parts = readyStr.includes('/') ? readyStr.split('/') : [readyStr, readyStr];
                    if (parts.length === 2 && parts[0] === parts[1] && parts[0] !== '0') {
                        ready++;
                    } else {
                        notReady++;
                    }
                });
                if (ready > 0) html += `<span class="summary-item"><span class="summary-count status-running">${ready}</span> ready</span>`;
                if (notReady > 0) html += `<span class="summary-item"><span class="summary-count status-pending">${notReady}</span> not ready</span>`;
            } else if (resource === 'nodes') {
                let ready = 0, notReady = 0;
                items.forEach(item => {
                    if (item.status === 'Ready') ready++;
                    else notReady++;
                });
                if (ready > 0) html += `<span class="summary-item"><span class="summary-count status-running">${ready}</span> ready</span>`;
                if (notReady > 0) html += `<span class="summary-item"><span class="summary-count status-failed">${notReady}</span> not ready</span>`;
            } else if (resource === 'jobs') {
                let complete = 0, running = 0, failed = 0;
                items.forEach(item => {
                    const status = (item.status || '').toLowerCase();
                    if (status.includes('complete') || status === 'succeeded') complete++;
                    else if (status.includes('fail')) failed++;
                    else running++;
                });
                if (complete > 0) html += `<span class="summary-item"><span class="summary-count status-succeeded">${complete}</span> complete</span>`;
                if (running > 0) html += `<span class="summary-item"><span class="summary-count status-pending">${running}</span> running</span>`;
                if (failed > 0) html += `<span class="summary-item"><span class="summary-count status-failed">${failed}</span> failed</span>`;
            } else if (resource === 'events') {
                const typeCounts = {};
                items.forEach(item => {
                    const type = item.type || 'Unknown';
                    typeCounts[type] = (typeCounts[type] || 0) + 1;
                });
                if (typeCounts['Normal']) html += `<span class="summary-item"><span class="summary-count status-running">${typeCounts['Normal']}</span> normal</span>`;
                if (typeCounts['Warning']) html += `<span class="summary-item"><span class="summary-count status-pending">${typeCounts['Warning']}</span> warning</span>`;
            } else if (resource === 'services') {
                const typeCounts = {};
                items.forEach(item => {
                    const type = item.type || 'ClusterIP';
                    typeCounts[type] = (typeCounts[type] || 0) + 1;
                });
                Object.keys(typeCounts).forEach(type => {
                    html += `<span class="summary-item"><span class="summary-count">${typeCounts[type]}</span> ${type}</span>`;
                });
            }

            summaryEl.innerHTML = html;
        }

        function renderTable(resource, items) {
            const headers = tableHeaders[resource];

            // Update resource summary
            updateResourceSummary(resource, items);

            // Store all items for sorting/filtering
            allItems = items || [];
            filteredItems = [...allItems];

            // Reset pagination on new data load
            currentPage = 1;

            // Render sortable headers with column filter row
            const headerRow = `<tr>${headers.map(h => {
                const sortClass = sortColumn === h ? (sortDirection === 'asc' ? 'sort-asc' : 'sort-desc') : '';
                return `<th class="${sortClass}" onclick="onColumnSort('${h}', this)">${h}<span class="sort-icon"></span></th>`;
            }).join('')}</tr>`;

            const filterRow = `<tr class="column-filter-row ${columnFiltersVisible ? 'active' : ''}" id="column-filter-row">
                ${headers.map(h => {
                    const filterValue = columnFilters[h] || '';
                    return `<th><input type="text" class="column-filter-input" placeholder="Filter ${h.toLowerCase()}..."
                        value="${filterValue}"
                        data-column="${h}"
                        onkeyup="onColumnFilterChange(event, '${h}')"
                        onclick="event.stopPropagation()"></th>`;
                }).join('')}
            </tr>`;

            document.getElementById('table-header').innerHTML = headerRow + filterRow;

            if (!items || items.length === 0) {
                document.getElementById('table-body').innerHTML =
                    `<tr><td colspan="${headers.length}" style="text-align:center;padding:40px;">No ${resource} found</td></tr>`;
                updatePaginationUI(0, 0);
                return;
            }

            // Apply current filter and sort, then render
            applyFilterAndSort();
        }

        // Render table body only (used by pagination)
        function renderTableBody(resource, items) {
            const headers = tableHeaders[resource];
            if (!items || items.length === 0) {
                document.getElementById('table-body').innerHTML =
                    `<tr><td colspan="${headers.length}" style="text-align:center;padding:40px;">No ${resource} found</td></tr>`;
                return;
            }

            document.getElementById('table-body').innerHTML = items.map((item, index) => {
                switch (resource) {
                    case 'pods':
                        const containers = item.containers || ['default'];
                        const containersJson = JSON.stringify(containers).replace(/'/g, "\\'");
                        return `<tr data-index="${index}" data-containers='${containersJson}'>
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.ready}</td>
                            <td class="status-${item.status.toLowerCase()}">${item.status}</td>
                            <td>${item.restarts}</td>
                            <td>${item.age}</td>
                            <td>${item.ip || '-'}</td>
                            <td class="resource-actions">
                                <button class="resource-action-btn terminal" onclick="event.stopPropagation(); openTerminal('${item.name}', '${item.namespace}')">Terminal</button>
                                <button class="resource-action-btn logs" onclick="event.stopPropagation(); openLogViewerFromRow(this, '${item.name}', '${item.namespace}')">Logs</button>
                                <button class="resource-action-btn portforward" onclick="event.stopPropagation(); openPortForward('${item.name}', '${item.namespace}')">Forward</button>
                            </td>
                        </tr>`;
                    case 'deployments':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.ready}</td>
                            <td>${item.upToDate || item.up_to_date || '-'}</td>
                            <td>${item.available || '-'}</td>
                            <td>${item.age}</td>
                            <td class="resource-actions">
                                <button class="resource-action-btn logs" onclick="event.stopPropagation(); openMultiPodLogViewer('${item.name}', '${item.namespace}', '${item.selector || 'app=' + item.name}')">Logs</button>
                            </td>
                        </tr>`;
                    case 'daemonsets':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.desired || '-'}</td>
                            <td>${item.current || '-'}</td>
                            <td>${item.ready || '-'}</td>
                            <td>${item.age}</td>
                            <td class="resource-actions">
                                <button class="resource-action-btn logs" onclick="event.stopPropagation(); openMultiPodLogViewer('${item.name}', '${item.namespace}', '${item.selector || 'app=' + item.name}')">Logs</button>
                            </td>
                        </tr>`;
                    case 'statefulsets':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.ready || '-'}</td>
                            <td>${item.age}</td>
                            <td class="resource-actions">
                                <button class="resource-action-btn logs" onclick="event.stopPropagation(); openMultiPodLogViewer('${item.name}', '${item.namespace}', '${item.selector || 'app=' + item.name}')">Logs</button>
                            </td>
                        </tr>`;
                    case 'replicasets':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.desired || '-'}</td>
                            <td>${item.current || '-'}</td>
                            <td>${item.ready || '-'}</td>
                            <td>${item.age}</td>
                            <td class="resource-actions">
                                <button class="resource-action-btn logs" onclick="event.stopPropagation(); openMultiPodLogViewer('${item.name}', '${item.namespace}', '${item.selector || 'app=' + item.name}')">Logs</button>
                            </td>
                        </tr>`;
                    case 'jobs':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.completions || '-'}</td>
                            <td>${item.duration || '-'}</td>
                            <td>${item.age}</td>
                        </tr>`;
                    case 'cronjobs':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.schedule || '-'}</td>
                            <td>${item.suspend ? 'Yes' : 'No'}</td>
                            <td>${item.active || 0}</td>
                            <td>${item.lastSchedule || '-'}</td>
                        </tr>`;
                    case 'services':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.type}</td>
                            <td>${item.clusterIP}</td>
                            <td>${item.ports}</td>
                            <td>${item.age}</td>
                        </tr>`;
                    case 'ingresses':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.class || item.ingressClass || '-'}</td>
                            <td>${item.hosts || '-'}</td>
                            <td>${item.address || '-'}</td>
                            <td>${item.age}</td>
                        </tr>`;
                    case 'networkpolicies':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.podSelector || '-'}</td>
                            <td>${item.age}</td>
                        </tr>`;
                    case 'configmaps':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.data || item.dataCount || 0}</td>
                            <td>${item.age}</td>
                        </tr>`;
                    case 'secrets':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.type || '-'}</td>
                            <td>${item.data || item.dataCount || 0}</td>
                            <td>${item.age}</td>
                        </tr>`;
                    case 'serviceaccounts':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.secrets || 0}</td>
                            <td>${item.age}</td>
                        </tr>`;
                    case 'persistentvolumes':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.capacity || '-'}</td>
                            <td>${item.accessModes || '-'}</td>
                            <td>${item.reclaimPolicy || '-'}</td>
                            <td class="status-${(item.status || '').toLowerCase()}">${item.status || '-'}</td>
                            <td>${item.claim || '-'}</td>
                        </tr>`;
                    case 'persistentvolumeclaims':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td class="status-${(item.status || '').toLowerCase()}">${item.status || '-'}</td>
                            <td>${item.volume || '-'}</td>
                            <td>${item.capacity || '-'}</td>
                            <td>${item.accessModes || '-'}</td>
                        </tr>`;
                    case 'nodes':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td class="status-${(item.status || '').toLowerCase()}">${item.status}</td>
                            <td>${item.roles}</td>
                            <td>${item.version}</td>
                            <td>${item.age}</td>
                        </tr>`;
                    case 'namespaces':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td class="status-active">${item.status}</td>
                            <td>${item.age}</td>
                        </tr>`;
                    case 'events':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.type}</td>
                            <td>${item.reason}</td>
                            <td>${item.message?.substring(0, 50) || '-'}${item.message?.length > 50 ? '...' : ''}</td>
                            <td>${item.count}</td>
                            <td>${item.lastSeen}</td>
                        </tr>`;
                    case 'roles':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.age}</td>
                        </tr>`;
                    case 'rolebindings':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.namespace}</td>
                            <td>${item.role || item.roleRef || '-'}</td>
                            <td>${item.age}</td>
                        </tr>`;
                    case 'clusterroles':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.age}</td>
                        </tr>`;
                    case 'clusterrolebindings':
                        return `<tr data-index="${index}">
                            <td>${item.name}</td>
                            <td>${item.role || item.roleRef || '-'}</td>
                            <td>${item.age}</td>
                        </tr>`;
                    default:
                        // Handle Custom Resources (crd:xxx format) and unknown types
                        if (resource.startsWith('crd:')) {
                            const crdInfo = currentCRD;
                            if (crdInfo && crdInfo.namespaced) {
                                const statusClass = (item.status || '').toLowerCase().includes('ready') ? 'status-running' :
                                                   (item.status || '').toLowerCase().includes('failed') ? 'status-failed' : '';
                                return `<tr data-index="${index}" onclick="showCRDetail('${crdInfo.name}', '${item.namespace || ''}', '${item.name}')">
                                    <td>${item.name}</td>
                                    <td>${item.namespace || '-'}</td>
                                    <td class="${statusClass}">${item.status || '-'}</td>
                                    <td>${item.age || '-'}</td>
                                </tr>`;
                            } else {
                                const statusClass = (item.status || '').toLowerCase().includes('ready') ? 'status-running' :
                                                   (item.status || '').toLowerCase().includes('failed') ? 'status-failed' : '';
                                return `<tr data-index="${index}" onclick="showCRDetail('${crdInfo?.name || ''}', '', '${item.name}')">
                                    <td>${item.name}</td>
                                    <td class="${statusClass}">${item.status || '-'}</td>
                                    <td>${item.age || '-'}</td>
                                </tr>`;
                            }
                        }
                        // Generic fallback for unknown resource types
                        const defaultHeaders = tableHeaders[resource] || ['NAME'];
                        return `<tr data-index="${index}">${defaultHeaders.map(h => `<td>${item[h.toLowerCase().replace(/[- ]/g, '')] || item.name || '-'}</td>`).join('')}</tr>`;
                }
            }).join('');
        }

        // Show Custom Resource detail modal
        async function showCRDetail(crdName, namespace, name) {
            const crdInfo = loadedCRDs.find(c => c.name === crdName);
            if (!crdInfo) return;

            try {
                const ns = namespace ? `&namespace=${namespace}` : '';
                const resp = await fetchWithAuth(`/api/crd/${crdName}/instances/${name}?format=yaml${ns}`);
                const yamlContent = await resp.text();

                // Show modal with YAML
                let html = `
                    <div class="modal-overlay" onclick="closeModal(event)">
                        <div class="modal detail-modal" onclick="event.stopPropagation()">
                            <div class="modal-header">
                                <h3>${crdInfo.kind}: ${name}</h3>
                                <button class="modal-close" onclick="closeAllModals()">&times;</button>
                            </div>
                            <div class="detail-tabs">
                                <button class="detail-tab active" data-tab="yaml">YAML</button>
                            </div>
                            <div class="modal-body" style="padding: 0;">
                                <pre id="cr-yaml-content" style="padding: 16px; margin: 0; background: var(--bg-primary); overflow: auto; max-height: 60vh; font-size: 12px;">${escapeHtml(yamlContent)}</pre>
                            </div>
                        </div>
                    </div>
                `;

                const modalContainer = document.createElement('div');
                modalContainer.id = 'cr-detail-modal';
                modalContainer.innerHTML = html;
                document.body.appendChild(modalContainer);
            } catch (e) {
                console.error('Failed to load CR detail:', e);
                alert('Failed to load resource details: ' + e.message);
            }
        }

        // Escape HTML for safe display
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Agentic Mode State - DEFAULT ON for tool execution
        let pendingApproval = null;

        // Resource name mappings for AI command parsing
        const resourceAliases = {
            // Korean aliases
            'íŒŒë“œ': 'pods', 'íŒŸ': 'pods', 'í¬ë“œ': 'pods',
            'ë””í”Œë¡œì´ë¨¼íŠ¸': 'deployments', 'ë°°í¬': 'deployments',
            'ì„œë¹„ìŠ¤': 'services', 'ì„œë¹„ìŠ¤ë“¤': 'services',
            'ë…¸ë“œ': 'nodes', 'ë…¸ë“œë“¤': 'nodes',
            'ë„¤ìž„ìŠ¤íŽ˜ì´ìŠ¤': 'namespaces', 'ë„¤ìž„ìŠ¤íŽ˜ì´ìŠ¤ë“¤': 'namespaces',
            'ì»¨í”¼ê·¸ë§µ': 'configmaps', 'ì„¤ì •': 'configmaps',
            'ì‹œí¬ë¦¿': 'secrets', 'ë¹„ë°€': 'secrets',
            'ì¸ê·¸ë ˆìŠ¤': 'ingresses',
            'ì´ë²¤íŠ¸': 'events', 'ì´ë²¤íŠ¸ë“¤': 'events',
            'ìŠ¤í…Œì´íŠ¸í’€ì…‹': 'statefulsets',
            'ë°ëª¬ì…‹': 'daemonsets',
            'ë ˆí”Œë¦¬ì¹´ì…‹': 'replicasets',
            'ìž¡': 'jobs', 'ìž‘ì—…': 'jobs',
            'í¬ë¡ ìž¡': 'cronjobs', 'ìŠ¤ì¼€ì¤„ìž¡': 'cronjobs',
            'ë³¼ë¥¨': 'persistentvolumeclaims', 'pvc': 'persistentvolumeclaims',
            'ë¡¤': 'roles', 'ì—­í• ': 'roles',
            'ì„œë¹„ìŠ¤ê³„ì •': 'serviceaccounts',
            // English aliases
            'pod': 'pods', 'deployment': 'deployments', 'deploy': 'deployments',
            'service': 'services', 'svc': 'services',
            'node': 'nodes', 'namespace': 'namespaces', 'ns': 'namespaces',
            'configmap': 'configmaps', 'cm': 'configmaps',
            'secret': 'secrets', 'ingress': 'ingresses', 'ing': 'ingresses',
            'event': 'events', 'ev': 'events',
            'statefulset': 'statefulsets', 'sts': 'statefulsets',
            'daemonset': 'daemonsets', 'ds': 'daemonsets',
            'replicaset': 'replicasets', 'rs': 'replicasets',
            'job': 'jobs', 'cronjob': 'cronjobs', 'cj': 'cronjobs',
            'pv': 'persistentvolumes', 'persistentvolume': 'persistentvolumes',
            'role': 'roles', 'rolebinding': 'rolebindings', 'rb': 'rolebindings',
            'clusterrole': 'clusterroles', 'cr': 'clusterroles',
            'clusterrolebinding': 'clusterrolebindings', 'crb': 'clusterrolebindings',
            'serviceaccount': 'serviceaccounts', 'sa': 'serviceaccounts',
            'networkpolicy': 'networkpolicies', 'netpol': 'networkpolicies'
        };

        // Parse user message and AI response for dashboard commands
        async function handleAIDashboardCommands(aiResponse, userMessage) {
            const msg = userMessage.toLowerCase();
            const resp = aiResponse.toLowerCase();

            // Detect show/list resource commands from user message
            const showPatterns = [
                /(?:show|display|list|get|ë³´ì—¬|ì¡°íšŒ|í™•ì¸|ë´|ë´ì¤˜|ë³´ê¸°|ë¦¬ìŠ¤íŠ¸).*?(pods?|deployments?|services?|nodes?|namespaces?|configmaps?|secrets?|ingress(?:es)?|events?|statefulsets?|daemonsets?|replicasets?|jobs?|cronjobs?|persistentvolume(?:claim)?s?|roles?|rolebindings?|clusterroles?|clusterrolebindings?|serviceaccounts?|networkpolic(?:y|ies)|íŒŒë“œ|íŒŸ|í¬ë“œ|ë””í”Œë¡œì´ë¨¼íŠ¸|ë°°í¬|ì„œë¹„ìŠ¤|ë…¸ë“œ|ë„¤ìž„ìŠ¤íŽ˜ì´ìŠ¤|ì»¨í”¼ê·¸ë§µ|ì„¤ì •|ì‹œí¬ë¦¿|ë¹„ë°€|ì¸ê·¸ë ˆìŠ¤|ì´ë²¤íŠ¸|ìŠ¤í…Œì´íŠ¸í’€ì…‹|ë°ëª¬ì…‹|ë ˆí”Œë¦¬ì¹´ì…‹|ìž¡|ìž‘ì—…|í¬ë¡ ìž¡|ìŠ¤ì¼€ì¤„ìž¡|ë³¼ë¥¨|pvc|pv|ë¡¤|ì—­í• |ì„œë¹„ìŠ¤ê³„ì •|svc|ns|cm|ing|ev|sts|ds|rs|cj|rb|cr|crb|sa|netpol)/i,
                /(?:pods?|deployments?|services?|nodes?|namespaces?|configmaps?|secrets?|ingress(?:es)?|events?|statefulsets?|daemonsets?|replicasets?|jobs?|cronjobs?|persistentvolume(?:claim)?s?|roles?|rolebindings?|clusterroles?|clusterrolebindings?|serviceaccounts?|networkpolic(?:y|ies)|íŒŒë“œ|íŒŸ|í¬ë“œ|ë””í”Œë¡œì´ë¨¼íŠ¸|ë°°í¬|ì„œë¹„ìŠ¤|ë…¸ë“œ|ë„¤ìž„ìŠ¤íŽ˜ì´ìŠ¤|ì»¨í”¼ê·¸ë§µ|ì„¤ì •|ì‹œí¬ë¦¿|ë¹„ë°€|ì¸ê·¸ë ˆìŠ¤|ì´ë²¤íŠ¸|ìŠ¤í…Œì´íŠ¸í’€ì…‹|ë°ëª¬ì…‹|ë ˆí”Œë¦¬ì¹´ì…‹|ìž¡|ìž‘ì—…|í¬ë¡ ìž¡|ìŠ¤ì¼€ì¤„ìž¡|ë³¼ë¥¨|pvc|pv|ë¡¤|ì—­í• |ì„œë¹„ìŠ¤ê³„ì •|svc|ns|cm|ing|ev|sts|ds|rs|cj|rb|cr|crb|sa|netpol).*?(?:show|display|list|ë³´ì—¬|ì¡°íšŒ|í™•ì¸|ë´|ë´ì¤˜|ë³´ê¸°|ë¦¬ìŠ¤íŠ¸)/i
            ];

            let detectedResource = null;
            let detectedNamespace = null;

            // Check user message for resource commands
            for (const pattern of showPatterns) {
                const match = msg.match(pattern);
                if (match) {
                    const resourceWord = match[1] || match[0];
                    detectedResource = resourceAliases[resourceWord.toLowerCase()] || resourceWord.toLowerCase();
                    // Ensure it's a valid resource
                    if (allResources.includes(detectedResource)) {
                        break;
                    }
                    detectedResource = null;
                }
            }

            // Check for namespace specification
            const nsPatterns = [
                /(?:namespace|ns|ë„¤ìž„ìŠ¤íŽ˜ì´ìŠ¤)[:\s=]+([a-z0-9-]+)/i,
                /(?:in|from|ì—ì„œ|ì˜)\s+([a-z0-9-]+)\s+(?:namespace|ns|ë„¤ìž„ìŠ¤íŽ˜ì´ìŠ¤)/i,
                /-n\s+([a-z0-9-]+)/i
            ];

            for (const pattern of nsPatterns) {
                const match = msg.match(pattern);
                if (match) {
                    detectedNamespace = match[1];
                    break;
                }
            }

            // Also check AI response for explicit dashboard commands
            // AI can include special markers like [[SHOW:pods]] or [[NAMESPACE:default]]
            const aiShowMatch = aiResponse.match(/\[\[SHOW:([a-z]+)\]\]/i);
            const aiNsMatch = aiResponse.match(/\[\[NAMESPACE:([a-z0-9-]*)\]\]/i);

            if (aiShowMatch) {
                detectedResource = aiShowMatch[1].toLowerCase();
            }
            if (aiNsMatch) {
                detectedNamespace = aiNsMatch[1] || ''; // empty string means all namespaces
            }

            // Execute dashboard navigation if resource detected
            if (detectedResource && allResources.includes(detectedResource)) {
                // Show notification
                showDashboardActionNotification(`Switching to ${detectedResource}...`);

                // Switch namespace first if specified
                if (detectedNamespace !== null) {
                    const nsSelect = document.getElementById('namespace-select');
                    if (nsSelect) {
                        // Check if namespace exists in dropdown
                        const nsExists = Array.from(nsSelect.options).some(opt => opt.value === detectedNamespace);
                        if (nsExists || detectedNamespace === '') {
                            nsSelect.value = detectedNamespace;
                            currentNamespace = detectedNamespace;
                        }
                    }
                }

                // Switch to the resource view
                switchResource(detectedResource);

                // Scroll dashboard into view on mobile
                const dashboardPanel = document.querySelector('.dashboard-panel');
                if (dashboardPanel && window.innerWidth < 768) {
                    dashboardPanel.scrollIntoView({ behavior: 'smooth' });
                }
            }

            // Check for filter commands
            const filterPatterns = [
                /(?:filter|find|search|í•„í„°|ê²€ìƒ‰|ì°¾ì•„)[:\s]+["']?([^"'\n]+)["']?/i,
                /["']([^"']+)["'].*?(?:filter|find|search|í•„í„°|ê²€ìƒ‰|ì°¾ì•„)/i
            ];

            for (const pattern of filterPatterns) {
                const match = msg.match(pattern);
                if (match && match[1]) {
                    const filterText = match[1].trim();
                    if (filterText && filterText.length > 1) {
                        const filterInput = document.getElementById('filter-input');
                        if (filterInput) {
                            filterInput.value = filterText;
                            filterTable(filterText.toLowerCase());
                            showDashboardActionNotification(`Filtering by "${filterText}"...`);
                        }
                    }
                    break;
                }
            }
        }

        // Show a brief notification for dashboard actions
        function showDashboardActionNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'dashboard-action-notification';
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 60px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--accent-blue);
                color: white;
                padding: 8px 16px;
                border-radius: 4px;
                z-index: 10000;
                font-size: 13px;
                animation: fadeInOut 2s ease-in-out;
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // AI Chat
        async function sendMessage() {
            const input = document.getElementById('ai-input');
            const message = input.value.trim();
            if (!message || isLoading) return;

            // Check guardrails (K8s safety analysis)
            const guardrailCheck = checkGuardrails(message);

            if (!guardrailCheck.allowed) {
                showNotification(guardrailCheck.reason, 'error');
                return;
            }

            // Show safety confirmation dialog for risky operations
            if (guardrailCheck.requireConfirmation) {
                const analysis = {
                    riskLevel: guardrailCheck.riskLevel || 'warning',
                    explanation: guardrailCheck.reason,
                    warnings: [guardrailCheck.reason],
                    recommendations: guardrailCheck.riskLevel === 'critical' ?
                        ['Consider using --dry-run=client first', 'Verify the correct cluster context'] :
                        ['Review the operation before proceeding']
                };

                return new Promise((resolve) => {
                    showSafetyConfirmation(analysis,
                        () => {
                            // User confirmed - proceed
                            proceedWithMessage(message);
                            resolve();
                        },
                        () => {
                            // User cancelled
                            showNotification('Operation cancelled', 'info');
                            resolve();
                        }
                    );
                });
            }

            await proceedWithMessage(message);
        }

        async function proceedWithMessage(message) {
            isLoading = true;
            document.getElementById('send-btn').disabled = true;
            document.getElementById('ai-input').value = '';

            // Save user message to chat history
            saveCurrentChatMessage(message, true);
            addMessage(message, true);

            // Always use agentic mode
            console.log('[DEBUG] sendMessage - using agentic mode');
            await sendMessageAgentic(message);

            isLoading = false;
            document.getElementById('send-btn').disabled = false;
        }

        // Format resource links in AI responses to make them clickable
        function formatResourceLinks(text) {
            // Common Kubernetes resource patterns
            // Match patterns like: pod/nginx-xxx, deployment/my-app, service/my-svc
            // or just: nginx-pod, my-deployment (when context is clear)

            // Pattern 1: explicit resource/name format (e.g., pod/nginx-xxx, deployment/my-app)
            const explicitPattern = /\b(pod|deployment|service|statefulset|daemonset|configmap|secret|ingress|node|namespace|replicaset|job|cronjob)s?\/([a-z0-9][-a-z0-9]*[a-z0-9])\b/gi;

            text = text.replace(explicitPattern, (match, kind, name) => {
                const resourceMap = {
                    'pod': 'pods', 'pods': 'pods',
                    'deployment': 'deployments', 'deployments': 'deployments',
                    'service': 'services', 'services': 'services',
                    'statefulset': 'statefulsets', 'statefulsets': 'statefulsets',
                    'daemonset': 'daemonsets', 'daemonsets': 'daemonsets',
                    'configmap': 'configmaps', 'configmaps': 'configmaps',
                    'secret': 'secrets', 'secrets': 'secrets',
                    'ingress': 'ingresses', 'ingresses': 'ingresses',
                    'node': 'nodes', 'nodes': 'nodes',
                    'namespace': 'namespaces', 'namespaces': 'namespaces',
                    'replicaset': 'replicasets', 'replicasets': 'replicasets',
                    'job': 'jobs', 'jobs': 'jobs',
                    'cronjob': 'cronjobs', 'cronjobs': 'cronjobs'
                };
                const resourceType = resourceMap[kind.toLowerCase()] || 'pods';
                return `<a href="#" class="resource-link" onclick="navigateToResource('${resourceType}', '${name}'); return false;">${match}</a>`;
            });

            // Pattern 2: backtick-quoted names that look like k8s resources
            // e.g., `nginx-deployment`, `my-service`, `coredns-xxxxx`
            const backtickPattern = /`([a-z][a-z0-9]*(?:-[a-z0-9]+)+)`/gi;
            text = text.replace(backtickPattern, (match, name) => {
                // Only convert if it looks like a k8s resource name (has hyphens)
                if (name.includes('-')) {
                    return `<a href="#" class="resource-link" onclick="searchAndNavigateToResource('${name}'); return false;">\`${name}\`</a>`;
                }
                return match;
            });

            return text;
        }

        // Navigate directly to a known resource type
        function navigateToResource(resourceType, name) {
            switchResource(resourceType);
            setTimeout(() => {
                document.getElementById('filter-input').value = name;
                currentFilter = name.toLowerCase();
                applyFilterAndSort();
            }, 500);
        }

        // Search for resource and navigate (when type is unknown)
        async function searchAndNavigateToResource(name) {
            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(name)}&namespace=${currentNamespace || ''}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.results && data.results.length > 0) {
                        navigateToSearchResult(data.results[0]);
                        return;
                    }
                }
            } catch (e) {
                console.error('Search error:', e);
            }
            // Fallback: just filter current view
            document.getElementById('filter-input').value = name;
            currentFilter = name.toLowerCase();
            applyFilterAndSort();
        }

        // Agentic chat with tool calling and Decision Required flow
        async function sendMessageAgentic(message) {
            const container = document.getElementById('ai-messages');
            const div = document.createElement('div');
            div.className = 'message assistant streaming';
            div.id = 'streaming-message';
            div.innerHTML = `<div class="message-content"><span class="cursor">â–Š</span></div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;

            const contentEl = div.querySelector('.message-content');
            let fullContent = '';

            try {
                const response = await fetch('/api/chat/agentic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ message, language: currentLanguage })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                let currentEventType = null;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        // Handle event type lines
                        if (line.startsWith('event: ')) {
                            currentEventType = line.slice(7).trim();
                            continue;
                        }

                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);

                            if (data === '[DONE]') {
                                break;
                            }

                            // Handle tool_execution events - insert before the AI response text
                            if (currentEventType === 'tool_execution') {
                                try {
                                    const execInfo = JSON.parse(data);
                                    showToolExecution(execInfo, div, contentEl);
                                } catch (e) {
                                    console.error('Failed to parse tool_execution:', e);
                                }
                                currentEventType = null;
                                continue;
                            }

                            // Check if this is an approval request
                            if (currentEventType === 'approval') {
                                try {
                                    const parsed = JSON.parse(data);
                                    if (parsed.type === 'approval_required') {
                                        showApprovalModal(parsed);
                                    }
                                } catch (e) {
                                    console.error('Failed to parse approval:', e);
                                }
                                currentEventType = null;
                                continue;
                            }

                            // Try parsing as JSON for other event types
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.type === 'approval_required') {
                                    showApprovalModal(parsed);
                                    continue;
                                }
                                if (parsed.type === 'tool_execution') {
                                    showToolExecution(parsed, div, contentEl);
                                    continue;
                                }
                            } catch (e) {
                                // Not JSON, treat as regular text
                            }

                            // Regular text streaming
                            const text = data.replace(/\\n/g, '\n');
                            fullContent += text;

                            let formatted = fullContent;
                            formatted = formatted.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
                            formatted = formatted.replace(/\n/g, '<br>');
                            contentEl.innerHTML = formatted + '<span class="cursor">â–Š</span>';
                            container.scrollTop = container.scrollHeight;

                            currentEventType = null;
                        }
                    }
                }

                // Finalize
                div.classList.remove('streaming');
                div.id = '';
                let formatted = fullContent;
                formatted = formatted.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
                formatted = formatResourceLinks(formatted);
                formatted = formatted.replace(/\n/g, '<br>');
                contentEl.innerHTML = formatted;

                // Save AI response to chat history
                if (fullContent.trim()) {
                    saveCurrentChatMessage(fullContent, false);
                }

                // Parse AI response for dashboard commands and execute them
                await handleAIDashboardCommands(fullContent, message);

                // Refresh resource list after potential changes
                await loadData();

            } catch (e) {
                div.classList.remove('streaming');
                div.id = '';

                // Provide user-friendly error messages
                let errorMsg = e.message;
                if (e.message.includes('AI client not configured') || e.message.includes('503')) {
                    errorMsg = `<strong>AI Assistant Not Configured</strong><br><br>
                        The AI assistant requires an LLM provider to be configured. Please go to
                        <strong>Settings â†’ AI/LLM Settings</strong> to configure your preferred provider
                        (OpenAI, Anthropic, Ollama, etc.).<br><br>
                        <em>Note: You need an API key from your chosen provider.</em>`;
                } else if (e.message.includes('does not support tool calling')) {
                    errorMsg = `<strong>Tool Calling Not Supported</strong><br><br>
                        The current AI provider does not support tool calling (agentic mode).
                        Please configure a provider that supports tool calling, such as:<br>
                        â€¢ OpenAI (GPT-4, GPT-3.5-turbo)<br>
                        â€¢ Anthropic Claude<br>
                        â€¢ Ollama with compatible models`;
                }

                contentEl.innerHTML = `<span style="color: var(--accent-red)">${errorMsg}</span>`;
            }
        }

        // Show tool execution info with expandable result
        // messageDiv: the AI message div, contentEl: the text content element inside it
        function showToolExecution(execInfo, messageDiv, contentEl) {
            const execDiv = document.createElement('div');
            execDiv.className = 'tool-execution';

            const isError = execInfo.is_error;
            const statusIcon = isError ? 'âŒ' : 'âœ…';
            const statusColor = isError ? 'var(--accent-red)' : 'var(--accent-green)';

            const uniqueId = 'tool-result-' + Date.now();
            const resultLength = execInfo.result ? execInfo.result.length : 0;

            execDiv.innerHTML = `
                <div class="tool-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                    <span style="color: ${statusColor};">${statusIcon}</span>
                    <span class="tool-name">${execInfo.tool}</span>
                </div>
                <div class="tool-command" style="background: var(--bg-primary); padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px; margin-bottom: 8px; word-break: break-all;">
                    $ ${escapeHtml(execInfo.command || 'N/A')}
                </div>
                ${execInfo.result ? `
                    <div class="tool-result-container">
                        <div class="tool-result-full" id="${uniqueId}-full" style="display: none; background: var(--bg-primary); padding: 8px; border-radius: 4px; font-family: monospace; font-size: 11px; max-height: 400px; overflow: auto; white-space: pre-wrap; word-break: break-all; color: ${isError ? 'var(--accent-red)' : 'var(--text-secondary)'};">
${escapeHtml(execInfo.result)}</div>
                        <button onclick="toggleToolResult('${uniqueId}')" id="${uniqueId}-btn" style="margin-top: 6px; padding: 4px 8px; font-size: 11px; background: var(--bg-tertiary); border: none; border-radius: 4px; color: var(--text-primary); cursor: pointer;">
                            â–¼ Show Result (${resultLength} chars)
                        </button>
                    </div>
                ` : ''}
            `;

            // Insert tool execution before the content element (AI response text)
            messageDiv.insertBefore(execDiv, contentEl);
            const container = document.getElementById('ai-messages');
            container.scrollTop = container.scrollHeight;

            // Log to debug panel
            addDebugLog('tool', 'Tool Executed', {
                tool: execInfo.tool,
                command: execInfo.command,
                result_length: resultLength,
                is_error: isError
            });
        }

        // Toggle tool result expansion
        function toggleToolResult(uniqueId) {
            const full = document.getElementById(uniqueId + '-full');
            const btn = document.getElementById(uniqueId + '-btn');

            if (full.style.display === 'none') {
                full.style.display = 'block';
                btn.textContent = 'â–² Hide Result';
            } else {
                full.style.display = 'none';
                btn.textContent = btn.textContent.replace('â–² Hide Result', 'â–¼ Show Result');
            }
        }

        // Show Decision Required approval modal
        function showApprovalModal(approval) {
            pendingApproval = approval;

            const isDangerous = approval.category === 'dangerous';
            const icon = isDangerous ? 'âš ï¸' : 'ðŸ”§';
            const title = isDangerous ? 'Dangerous Operation' : 'Decision Required';

            const modal = document.createElement('div');
            modal.className = 'approval-modal';
            modal.id = 'approval-modal';
            modal.innerHTML = `
                <div class="approval-box ${isDangerous ? 'dangerous' : ''}">
                    <div class="approval-header">
                        <span class="approval-icon">${icon}</span>
                        <span class="approval-title">${title}</span>
                    </div>
                    <div class="approval-category ${approval.category}">${approval.category}</div>
                    <p>The AI wants to execute the following command:</p>
                    <div class="approval-command">${escapeHtml(approval.command)}</div>
                    <p style="font-size: 12px; color: var(--text-secondary);">
                        Tool: <strong>${approval.tool_name}</strong>
                    </p>
                    <div class="approval-buttons">
                        <button class="btn-reject" onclick="respondToApproval(false)">
                            âœ• Reject
                        </button>
                        <button class="btn-approve" onclick="respondToApproval(true)">
                            âœ“ Approve
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Add keyboard handlers
            document.addEventListener('keydown', handleApprovalKeypress);
        }

        function handleApprovalKeypress(e) {
            if (!pendingApproval) return;

            if (e.key === 'Enter' || e.key === 'y' || e.key === 'Y') {
                respondToApproval(true);
            } else if (e.key === 'Escape' || e.key === 'n' || e.key === 'N') {
                respondToApproval(false);
            }
        }

        async function respondToApproval(approved) {
            if (!pendingApproval) return;

            const approvalId = pendingApproval.id;
            pendingApproval = null;

            // Remove modal
            const modal = document.getElementById('approval-modal');
            if (modal) {
                modal.remove();
            }

            // Remove keyboard handler
            document.removeEventListener('keydown', handleApprovalKeypress);

            // Send response to server
            try {
                await fetch('/api/tool/approve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ id: approvalId, approved })
                });

                // Add temporary status message to chat (auto-removes after 5 seconds)
                const container = document.getElementById('ai-messages');
                const statusDiv = document.createElement('div');
                statusDiv.className = 'tool-execution';
                statusDiv.style.transition = 'opacity 0.3s ease-out';
                statusDiv.innerHTML = approved
                    ? `<span class="tool-name">âœ“ Approved:</span> Command execution proceeding...`
                    : `<span class="tool-name" style="color: var(--accent-red)">âœ• Rejected:</span> Command was cancelled by user.`;
                container.appendChild(statusDiv);
                container.scrollTop = container.scrollHeight;

                // Auto-remove the status message after 5 seconds
                setTimeout(() => {
                    statusDiv.style.opacity = '0';
                    setTimeout(() => statusDiv.remove(), 300);
                }, 5000);

            } catch (e) {
                console.error('Failed to send approval response:', e);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addMessage(content, isUser = false) {
            const container = document.getElementById('ai-messages');
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user' : 'assistant'}`;

            let formatted = content;
            if (!isUser) {
                formatted = content.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
                formatted = formatted.replace(/\n/g, '<br>');
            }

            div.innerHTML = `<div class="message-content">${formatted}</div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addLoadingMessage() {
            const container = document.getElementById('ai-messages');
            const div = document.createElement('div');
            div.className = 'message assistant';
            div.id = 'loading-message';
            div.innerHTML = `<div class="message-content"><div class="loading-dots"><span></span><span></span><span></span></div></div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function removeLoadingMessage() {
            const loading = document.getElementById('loading-message');
            if (loading) loading.remove();
        }

        document.getElementById('ai-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Resizable panel
        function setupResizeHandle() {
            const handle = document.getElementById('resize-handle');
            const aiPanel = document.getElementById('ai-panel');
            let isResizing = false;

            handle.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                const containerWidth = document.querySelector('.content-wrapper').offsetWidth;
                const newWidth = containerWidth - e.clientX + document.querySelector('.sidebar').offsetWidth;
                if (newWidth >= 280 && newWidth <= 600) {
                    aiPanel.style.width = newWidth + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            });
        }

        // Health check
        function setupHealthCheck() {
            setInterval(async () => {
                try {
                    const resp = await fetch('/api/health');
                    const data = await resp.json();
                    const dot = document.getElementById('health-dot');
                    const status = document.getElementById('health-status');

                    if (data.status === 'ok' && data.k8s_ready) {
                        dot.className = 'health-dot ok';
                        status.textContent = 'Connected';
                    } else {
                        dot.className = 'health-dot warning';
                        status.textContent = 'Degraded';
                    }
                } catch (e) {
                    document.getElementById('health-dot').className = 'health-dot error';
                    document.getElementById('health-status').textContent = 'Disconnected';
                }
            }, 10000);
        }

        // Settings
        function showSettings() {
            document.getElementById('settings-modal').classList.add('active');
            loadSettings();
            loadVersionInfo();
            // Show Admin tab only for admin users
            const adminTab = document.getElementById('admin-tab');
            if (adminTab) {
                adminTab.style.display = (currentUser && currentUser.role === 'admin') ? 'block' : 'none';
            }
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function switchSettingsTab(tab) {
            document.querySelectorAll('.tabs .tab').forEach((t, i) => {
                t.classList.toggle('active', t.textContent.toLowerCase().includes(tab));
            });
            document.querySelectorAll('.settings-content').forEach(c => c.style.display = 'none');
            document.getElementById(`settings-${tab}`).style.display = 'block';

            // Load data for specific tabs
            if (tab === 'ai') {
                loadModelProfiles();
                updateEndpointPlaceholder();
                loadLLMStatus();
                onLLMTabOpened();
            } else if (tab === 'mcp') {
                loadMCPServers();
                loadMCPTools();
            } else if (tab === 'admin') {
                loadAdminUsers();
                loadAuthStatus();
            }
        }

        // LLM Connection Test Functions
        async function testLLMConnection() {
            const btn = document.getElementById('llm-test-btn');
            const btnText = document.getElementById('llm-test-btn-text');
            const indicator = document.getElementById('llm-status-indicator');
            const statusText = document.getElementById('llm-status-text');
            const statusDetail = document.getElementById('llm-status-detail');

            // Show testing state
            btn.disabled = true;
            btnText.textContent = 'Testing...';
            indicator.style.background = '#888';
            indicator.style.boxShadow = '0 0 8px rgba(136,136,136,0.5)';
            indicator.style.animation = 'pulse 1s infinite';
            statusText.textContent = 'Testing Connection...';
            statusDetail.textContent = 'Please wait...';

            // Get current form values to test
            const testConfig = {
                provider: document.getElementById('setting-llm-provider').value,
                model: document.getElementById('setting-llm-model').value,
                endpoint: document.getElementById('setting-llm-endpoint').value,
                api_key: document.getElementById('setting-llm-apikey').value
            };

            try {
                const resp = await fetchWithAuth('/api/llm/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testConfig)
                });
                const status = await resp.json();

                if (status.connected) {
                    // Success - green light
                    indicator.style.background = '#10b981';
                    indicator.style.boxShadow = '0 0 12px rgba(16,185,129,0.8)';
                    indicator.style.animation = '';
                    statusText.textContent = 'Connection Successful';
                    statusText.style.color = 'var(--accent-green)';
                    statusDetail.textContent = `${status.provider} / ${status.model} - Response time: ${status.response_time_ms}ms`;
                } else {
                    // Failure - red light
                    indicator.style.background = '#ef4444';
                    indicator.style.boxShadow = '0 0 12px rgba(239,68,68,0.8)';
                    indicator.style.animation = '';
                    statusText.textContent = 'Connection Failed';
                    statusText.style.color = 'var(--accent-red)';
                    statusDetail.textContent = status.error || 'Unknown error';
                    if (status.message) {
                        statusDetail.textContent += ' - ' + status.message;
                    }
                }
            } catch (e) {
                // Error - red light
                indicator.style.background = '#ef4444';
                indicator.style.boxShadow = '0 0 12px rgba(239,68,68,0.8)';
                indicator.style.animation = '';
                statusText.textContent = 'Connection Error';
                statusText.style.color = 'var(--accent-red)';
                statusDetail.textContent = e.message || 'Failed to test connection';
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Test Connection';
            }
        }

        async function loadLLMStatus() {
            try {
                const resp = await fetchWithAuth('/api/llm/status');
                const status = await resp.json();

                const indicator = document.getElementById('llm-status-indicator');
                const statusText = document.getElementById('llm-status-text');
                const statusDetail = document.getElementById('llm-status-detail');

                // Check if using embedded LLM - disable settings if so
                if (status.embedded_llm) {
                    indicator.style.background = 'var(--accent-green)';
                    indicator.style.boxShadow = '0 0 8px rgba(158,206,106,0.5)';
                    statusText.textContent = 'Embedded LLM Active';
                    statusText.style.color = 'var(--accent-green)';
                    statusDetail.textContent = `${status.provider} / ${status.model} (Local llama.cpp server)`;

                    // Disable all LLM settings inputs
                    disableLLMSettings(true, 'Embedded LLM is active. Settings are managed via CLI flags.');
                    return;
                }

                // Re-enable settings if not using embedded LLM
                disableLLMSettings(false);

                if (status.configured && status.ready) {
                    indicator.style.background = '#f59e0b';
                    indicator.style.boxShadow = '0 0 8px rgba(245,158,11,0.5)';
                    statusText.textContent = 'LLM Configured';
                    statusText.style.color = 'var(--accent-yellow)';
                    statusDetail.textContent = `${status.provider} / ${status.model} - Click 'Test Connection' to verify`;
                } else if (!status.configured) {
                    indicator.style.background = '#888';
                    indicator.style.boxShadow = '0 0 8px rgba(136,136,136,0.5)';
                    statusText.textContent = 'LLM Not Configured';
                    statusText.style.color = 'var(--text-secondary)';
                    statusDetail.textContent = 'Configure provider, model, and API key below';
                } else {
                    indicator.style.background = '#888';
                    indicator.style.boxShadow = '0 0 8px rgba(136,136,136,0.5)';
                    statusText.textContent = 'Configuration Incomplete';
                    statusText.style.color = 'var(--text-secondary)';
                    const missing = [];
                    if (!status.has_api_key) missing.push('API key');
                    if (!status.endpoint && !status.default_endpoint) missing.push('endpoint');
                    statusDetail.textContent = missing.length > 0 ? 'Missing: ' + missing.join(', ') : 'Check configuration';
                }
            } catch (e) {
                console.error('Failed to load LLM status:', e);
            }
        }

        function disableLLMSettings(disabled, message) {
            const settingsLLM = document.getElementById('settings-llm');
            if (!settingsLLM) return;

            const inputs = settingsLLM.querySelectorAll('input, select, button');
            inputs.forEach(input => {
                // Don't disable the test connection button
                if (input.id === 'llm-test-btn') return;
                input.disabled = disabled;
                input.style.opacity = disabled ? '0.5' : '1';
                input.style.cursor = disabled ? 'not-allowed' : '';
            });

            // Show/hide embedded LLM notice
            let notice = document.getElementById('embedded-llm-notice');
            if (disabled && message) {
                if (!notice) {
                    notice = document.createElement('div');
                    notice.id = 'embedded-llm-notice';
                    notice.style.cssText = 'margin:16px 0;padding:12px 16px;background:linear-gradient(135deg,rgba(158,206,106,0.15),rgba(122,162,247,0.15));border:1px solid rgba(158,206,106,0.3);border-radius:8px;display:flex;align-items:center;gap:12px;';
                    notice.innerHTML = `
                        <span style="font-size:24px;">ðŸ¤–</span>
                        <div>
                            <div style="font-weight:600;color:var(--accent-green);margin-bottom:4px;">Embedded LLM Mode</div>
                            <div style="font-size:12px;color:var(--text-secondary);">${message}</div>
                        </div>
                    `;
                    const firstSection = settingsLLM.querySelector('.settings-section');
                    if (firstSection) {
                        firstSection.parentNode.insertBefore(notice, firstSection);
                    }
                }
            } else if (notice) {
                notice.remove();
            }

            // Hide Ollama setup section when embedded LLM is active
            const ollamaSection = document.getElementById('ollama-setup-section');
            if (ollamaSection) {
                ollamaSection.style.display = disabled ? 'none' : '';
            }
        }

        function updateEndpointPlaceholder() {
            const provider = document.getElementById('setting-llm-provider').value;
            const endpointInput = document.getElementById('setting-llm-endpoint');
            const hint = document.getElementById('endpoint-hint');

            const defaults = {
                'solar': { placeholder: 'https://api.upstage.ai/v1', hint: '(Default: Upstage Solar API)', model: 'solar-pro2', apiKeyHint: 'up_...' },
                'openai': { placeholder: 'https://api.openai.com/v1', hint: '(Default: OpenAI API)', model: 'gpt-4', apiKeyHint: 'sk-...' },
                'ollama': { placeholder: 'http://localhost:11434', hint: '(Required for Ollama)', model: 'llama3', apiKeyHint: '' },
                'gemini': { placeholder: 'https://generativelanguage.googleapis.com/v1beta', hint: '(Default: Gemini API)', model: 'gemini-pro', apiKeyHint: '' },
                'anthropic': { placeholder: 'https://api.anthropic.com', hint: '(Default: Anthropic API)', model: 'claude-3-opus', apiKeyHint: 'sk-ant-...' },
                'bedrock': { placeholder: '', hint: '(Uses AWS credentials)', model: '', apiKeyHint: '' },
                'azopenai': { placeholder: 'https://your-resource.openai.azure.com', hint: '(Azure resource endpoint required)', model: '', apiKeyHint: '' }
            };

            const config = defaults[provider] || { placeholder: '', hint: '', model: '', apiKeyHint: '' };
            endpointInput.placeholder = config.placeholder;
            hint.textContent = config.hint;

            // Update model value and placeholder when switching providers
            const modelInput = document.getElementById('setting-llm-model');
            if (modelInput) {
                modelInput.placeholder = config.model || '';
                // Always set model to provider default when switching
                if (config.model) {
                    modelInput.value = config.model;
                }
            }

            // Always set endpoint to provider default when switching
            if (config.placeholder) {
                endpointInput.value = config.placeholder;
            }

            // Update API key placeholder
            const apiKeyInput = document.getElementById('setting-llm-apikey');
            if (apiKeyInput && config.apiKeyHint) {
                apiKeyInput.placeholder = config.apiKeyHint;
            }

            // Update API key link based on provider
            const apiKeyLabel = apiKeyInput?.parentElement?.querySelector('label');
            if (apiKeyLabel) {
                const existingLink = apiKeyLabel.querySelector('a');
                if (existingLink) existingLink.remove();

                const links = {
                    'solar': { url: 'https://console.upstage.ai/api-keys', text: 'Get API Key â†’' },
                    'openai': { url: 'https://platform.openai.com/api-keys', text: 'Get API Key â†’' },
                    'anthropic': { url: 'https://console.anthropic.com/settings/keys', text: 'Get API Key â†’' },
                    'gemini': { url: 'https://aistudio.google.com/app/apikey', text: 'Get API Key â†’' }
                };

                if (links[provider]) {
                    const link = document.createElement('a');
                    link.href = links[provider].url;
                    link.target = '_blank';
                    link.style.cssText = 'font-size:11px;color:var(--accent-blue);margin-left:8px;';
                    link.textContent = links[provider].text;
                    apiKeyLabel.appendChild(link);
                }
            }

            // Update reasoning effort UI visibility (only for Solar)
            updateReasoningEffortUI();
        }

        // Model Management Functions
        async function loadModelProfiles() {
            try {
                const resp = await fetchWithAuth('/api/models');
                const data = await resp.json();
                const container = document.getElementById('models-list');

                if (!data.models || data.models.length === 0) {
                    container.innerHTML = '<p style="color:var(--text-secondary);">No model profiles configured.</p>';
                    return;
                }

                container.innerHTML = data.models.map(m => `
                    <div class="settings-row" style="background:var(--bg-primary);padding:12px;border-radius:8px;margin-bottom:8px;">
                        <div style="flex:1;">
                            <div style="font-weight:bold;display:flex;align-items:center;gap:8px;">
                                ${escapeHtml(m.name)}
                                ${m.is_active ? '<span style="background:var(--accent-green);color:var(--bg-primary);padding:2px 8px;border-radius:4px;font-size:10px;">ACTIVE</span>' : ''}
                            </div>
                            <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">
                                ${escapeHtml(m.provider)} / ${escapeHtml(m.model)} ${m.description ? '- ' + escapeHtml(m.description) : ''}
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;">
                            ${!m.is_active ? `<button class="btn btn-secondary" onclick="switchModel('${escapeHtml(m.name)}')" style="padding:4px 12px;font-size:12px;">Use</button>` : ''}
                            <button class="btn btn-secondary" onclick="deleteModel('${escapeHtml(m.name)}')" style="padding:4px 12px;font-size:12px;color:var(--accent-red);">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load models:', e);
            }
        }

        async function switchModel(name) {
            try {
                await fetchWithAuth('/api/models/active', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                loadModelProfiles();
                alert('Switched to model: ' + name);
            } catch (e) {
                alert('Failed to switch model: ' + e.message);
            }
        }

        async function deleteModel(name) {
            if (!confirm('Delete model profile "' + name + '"?')) return;
            try {
                await fetchWithAuth('/api/models?name=' + encodeURIComponent(name), {
                    method: 'DELETE'
                });
                loadModelProfiles();
            } catch (e) {
                alert('Failed to delete model: ' + e.message);
            }
        }

        function showAddModelForm() {
            document.getElementById('add-model-form').style.display = 'block';
        }

        function hideAddModelForm() {
            document.getElementById('add-model-form').style.display = 'none';
            // Clear form
            document.getElementById('new-model-name').value = '';
            document.getElementById('new-model-model').value = '';
            document.getElementById('new-model-endpoint').value = '';
            document.getElementById('new-model-apikey').value = '';
            document.getElementById('new-model-description').value = '';
        }

        async function addModelProfile() {
            const profile = {
                name: document.getElementById('new-model-name').value.trim(),
                provider: document.getElementById('new-model-provider').value,
                model: document.getElementById('new-model-model').value.trim(),
                endpoint: document.getElementById('new-model-endpoint').value.trim(),
                api_key: document.getElementById('new-model-apikey').value,
                description: document.getElementById('new-model-description').value.trim()
            };

            if (!profile.name || !profile.model) {
                alert('Name and Model are required');
                return;
            }

            try {
                await fetchWithAuth('/api/models', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profile)
                });
                hideAddModelForm();
                loadModelProfiles();
            } catch (e) {
                alert('Failed to add model: ' + e.message);
            }
        }

        // MCP Management Functions
        async function loadMCPServers() {
            try {
                const resp = await fetchWithAuth('/api/mcp/servers');
                const data = await resp.json();
                const container = document.getElementById('mcp-servers-list');

                if (!data.servers || data.servers.length === 0) {
                    container.innerHTML = '<p style="color:var(--text-secondary);">No MCP servers configured.</p>';
                    return;
                }

                container.innerHTML = data.servers.map(s => `
                    <div class="settings-row" style="background:var(--bg-primary);padding:12px;border-radius:8px;margin-bottom:8px;">
                        <div style="flex:1;">
                            <div style="font-weight:bold;display:flex;align-items:center;gap:8px;">
                                ${escapeHtml(s.name)}
                                ${s.connected ? '<span style="background:var(--accent-green);color:var(--bg-primary);padding:2px 8px;border-radius:4px;font-size:10px;">CONNECTED</span>' : s.enabled ? '<span style="background:var(--accent-yellow);color:var(--bg-primary);padding:2px 8px;border-radius:4px;font-size:10px;">DISCONNECTED</span>' : '<span style="background:var(--bg-tertiary);padding:2px 8px;border-radius:4px;font-size:10px;">DISABLED</span>'}
                            </div>
                            <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">
                                ${escapeHtml(s.command)} ${s.args ? escapeHtml(s.args.join(' ')) : ''} ${s.description ? '- ' + escapeHtml(s.description) : ''}
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;">
                            ${s.enabled ? `<button class="btn btn-secondary" onclick="toggleMCPServer('${s.name}', 'disable')" style="padding:4px 12px;font-size:12px;">Disable</button>` : `<button class="btn btn-secondary" onclick="toggleMCPServer('${s.name}', 'enable')" style="padding:4px 12px;font-size:12px;">Enable</button>`}
                            ${s.enabled ? `<button class="btn btn-secondary" onclick="toggleMCPServer('${s.name}', 'reconnect')" style="padding:4px 12px;font-size:12px;">Reconnect</button>` : ''}
                            <button class="btn btn-secondary" onclick="deleteMCPServer('${s.name}')" style="padding:4px 12px;font-size:12px;color:var(--accent-red);">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load MCP servers:', e);
            }
        }

        async function loadMCPTools() {
            try {
                const resp = await fetchWithAuth('/api/mcp/tools');
                const data = await resp.json();
                const container = document.getElementById('mcp-tools-list');

                let html = '';

                if (data.builtin_tools && data.builtin_tools.length > 0) {
                    html += '<div style="margin-bottom:12px;"><strong>Built-in Tools:</strong></div>';
                    html += data.builtin_tools.map(t => `
                        <div style="background:var(--bg-primary);padding:8px 12px;border-radius:4px;margin-bottom:4px;font-size:12px;">
                            <span style="color:var(--accent-blue);">${t.name}</span>
                            <span style="color:var(--text-secondary);margin-left:8px;">${t.description || ''}</span>
                        </div>
                    `).join('');
                }

                if (data.mcp_tools && data.mcp_tools.length > 0) {
                    html += '<div style="margin:12px 0;"><strong>MCP Tools:</strong></div>';
                    html += data.mcp_tools.map(t => `
                        <div style="background:var(--bg-primary);padding:8px 12px;border-radius:4px;margin-bottom:4px;font-size:12px;">
                            <span style="color:var(--accent-purple);">${t.name}</span>
                            <span style="color:var(--text-secondary);margin-left:8px;">${t.description || ''}</span>
                            <span style="color:var(--accent-cyan);margin-left:8px;font-size:10px;">[${t.server}]</span>
                        </div>
                    `).join('');
                }

                if (!html) {
                    html = '<p style="color:var(--text-secondary);">No tools available.</p>';
                }

                container.innerHTML = html;
            } catch (e) {
                console.error('Failed to load MCP tools:', e);
            }
        }

        async function toggleMCPServer(name, action) {
            try {
                await fetchWithAuth('/api/mcp/servers', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, action })
                });
                loadMCPServers();
                loadMCPTools();
            } catch (e) {
                alert('Failed to ' + action + ' MCP server: ' + e.message);
            }
        }

        async function deleteMCPServer(name) {
            if (!confirm('Delete MCP server "' + name + '"?')) return;
            try {
                await fetchWithAuth('/api/mcp/servers?name=' + encodeURIComponent(name), {
                    method: 'DELETE'
                });
                loadMCPServers();
                loadMCPTools();
            } catch (e) {
                alert('Failed to delete MCP server: ' + e.message);
            }
        }

        function showAddMCPForm() {
            document.getElementById('add-mcp-form').style.display = 'block';
        }

        function hideAddMCPForm() {
            document.getElementById('add-mcp-form').style.display = 'none';
            // Clear form
            document.getElementById('new-mcp-name').value = '';
            document.getElementById('new-mcp-command').value = '';
            document.getElementById('new-mcp-args').value = '';
            document.getElementById('new-mcp-description').value = '';
            document.getElementById('new-mcp-enabled').checked = true;
        }

        async function addMCPServer() {
            const argsStr = document.getElementById('new-mcp-args').value.trim();
            const args = argsStr ? argsStr.split(',').map(a => a.trim()).filter(a => a) : [];

            const server = {
                name: document.getElementById('new-mcp-name').value.trim(),
                command: document.getElementById('new-mcp-command').value.trim(),
                args: args,
                description: document.getElementById('new-mcp-description').value.trim(),
                enabled: document.getElementById('new-mcp-enabled').checked
            };

            if (!server.name || !server.command) {
                alert('Name and Command are required');
                return;
            }

            try {
                const resp = await fetchWithAuth('/api/mcp/servers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(server)
                });
                const data = await resp.json();
                hideAddMCPForm();
                loadMCPServers();
                loadMCPTools();
                if (data.warning) {
                    alert(data.warning);
                }
            } catch (e) {
                alert('Failed to add MCP server: ' + e.message);
            }
        }

        // Admin User Management Functions
        async function loadAdminUsers() {
            try {
                const resp = await fetchWithAuth('/api/admin/users');
                if (!resp.ok) {
                    if (resp.status === 403) {
                        document.getElementById('admin-users-list').innerHTML = '<p style="color:var(--accent-red);">Access denied. Admin role required.</p>';
                        return;
                    }
                    throw new Error('Failed to load users');
                }
                const data = await resp.json();
                const container = document.getElementById('admin-users-list');

                if (!data.users || data.users.length === 0) {
                    container.innerHTML = '<p style="color:var(--text-secondary);">No users found.</p>';
                    return;
                }

                container.innerHTML = data.users.map(u => `
                    <div class="settings-row" style="background:var(--bg-primary);padding:12px;border-radius:8px;margin-bottom:8px;">
                        <div style="flex:1;">
                            <div style="font-weight:bold;display:flex;align-items:center;gap:8px;">
                                ${escapeHtml(u.username)}
                                <span style="background:${u.role === 'admin' ? 'var(--accent-red)' : u.role === 'user' ? 'var(--accent-blue)' : 'var(--bg-tertiary)'};color:${u.role === 'admin' || u.role === 'user' ? '#fff' : 'var(--text-primary)'};padding:2px 8px;border-radius:4px;font-size:10px;text-transform:uppercase;">${u.role}</span>
                                <span style="background:var(--bg-tertiary);padding:2px 8px;border-radius:4px;font-size:10px;">${u.source || 'local'}</span>
                            </div>
                            <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">
                                ${u.email ? escapeHtml(u.email) + ' Â· ' : ''}Last login: ${u.last_login ? new Date(u.last_login).toLocaleString() : 'Never'}
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;">
                            ${u.source === 'local' ? `
                                <button class="btn btn-secondary" onclick="showResetPasswordModal('${escapeHtml(u.username)}')" style="padding:4px 12px;font-size:12px;">Reset Password</button>
                                <button class="btn btn-secondary" onclick="deleteUser('${escapeHtml(u.username)}')" style="padding:4px 12px;font-size:12px;color:var(--accent-red);">Delete</button>
                            ` : '<span style="font-size:11px;color:var(--text-secondary);">External user</span>'}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load admin users:', e);
                document.getElementById('admin-users-list').innerHTML = '<p style="color:var(--accent-red);">Failed to load users.</p>';
            }
        }

        async function loadAuthStatus() {
            try {
                const resp = await fetchWithAuth('/api/admin/status');
                if (!resp.ok) return;
                const data = await resp.json();

                // Update current auth mode display
                const currentModeEl = document.getElementById('current-auth-mode');
                if (currentModeEl) {
                    const modeLabels = {
                        'local': 'Local (Username/Password)',
                        'token': 'Kubernetes Token',
                        'oidc': 'OIDC/OAuth SSO',
                        'ldap': 'LDAP/Active Directory'
                    };
                    currentModeEl.textContent = modeLabels[data.auth_mode] || data.auth_mode || 'Unknown';
                }

                // Set the auth mode select to current value
                const authModeSelect = document.getElementById('auth-mode');
                if (authModeSelect && data.auth_mode) {
                    authModeSelect.value = data.auth_mode;
                    onAuthModeChange(data.auth_mode);
                }

                // Load SSO settings if available
                if (data.oidc_configured) {
                    // Try to load OIDC settings
                    try {
                        const oidcResp = await fetchWithAuth('/api/settings/auth');
                        if (oidcResp.ok) {
                            const authConfig = await oidcResp.json();
                            if (authConfig.oidc) {
                                const oidc = authConfig.oidc;
                                if (document.getElementById('oidc-provider-url')) {
                                    document.getElementById('oidc-provider-url').value = oidc.provider_url || '';
                                }
                                if (document.getElementById('oidc-client-id')) {
                                    document.getElementById('oidc-client-id').value = oidc.client_id || '';
                                }
                                if (document.getElementById('oidc-scopes')) {
                                    document.getElementById('oidc-scopes').value = oidc.scopes || 'openid email profile';
                                }
                            }
                            if (authConfig.ldap) {
                                const ldap = authConfig.ldap;
                                if (document.getElementById('ldap-server-url')) {
                                    document.getElementById('ldap-server-url').value = ldap.server_url || '';
                                }
                                if (document.getElementById('ldap-bind-dn')) {
                                    document.getElementById('ldap-bind-dn').value = ldap.bind_dn || '';
                                }
                                if (document.getElementById('ldap-user-search-base')) {
                                    document.getElementById('ldap-user-search-base').value = ldap.user_search_base || '';
                                }
                            }
                        }
                    } catch (configErr) {
                        console.log('Auth config not available:', configErr);
                    }
                }
            } catch (e) {
                console.error('Failed to load auth status:', e);
            }
        }

        function showAddUserForm() {
            document.getElementById('add-user-form').style.display = 'block';
        }

        function hideAddUserForm() {
            document.getElementById('add-user-form').style.display = 'none';
            document.getElementById('new-user-username').value = '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('new-user-email').value = '';
            document.getElementById('new-user-role').value = 'viewer';
        }

        async function addUser() {
            const user = {
                username: document.getElementById('new-user-username').value.trim(),
                password: document.getElementById('new-user-password').value,
                email: document.getElementById('new-user-email').value.trim(),
                role: document.getElementById('new-user-role').value
            };

            if (!user.username || !user.password) {
                alert('Username and password are required');
                return;
            }

            try {
                const resp = await fetchWithAuth('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user)
                });

                if (!resp.ok) {
                    const error = await resp.text();
                    throw new Error(error);
                }

                hideAddUserForm();
                loadAdminUsers();
                alert('User created successfully');
            } catch (e) {
                alert('Failed to create user: ' + e.message);
            }
        }

        async function deleteUser(username) {
            if (!confirm('Delete user "' + username + '"? This action cannot be undone.')) return;

            try {
                const resp = await fetchWithAuth('/api/admin/users/' + encodeURIComponent(username), {
                    method: 'DELETE'
                });

                if (!resp.ok) {
                    const error = await resp.text();
                    throw new Error(error);
                }

                loadAdminUsers();
                alert('User deleted successfully');
            } catch (e) {
                alert('Failed to delete user: ' + e.message);
            }
        }

        function showResetPasswordModal(username) {
            const newPassword = prompt('Enter new password for ' + username + ':');
            if (!newPassword) return;

            resetUserPassword(username, newPassword);
        }

        async function resetUserPassword(username, newPassword) {
            try {
                const resp = await fetchWithAuth('/api/admin/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, new_password: newPassword })
                });

                if (!resp.ok) {
                    const error = await resp.text();
                    throw new Error(error);
                }

                alert('Password reset successfully');
            } catch (e) {
                alert('Failed to reset password: ' + e.message);
            }
        }

        async function loadSettings() {
            try {
                const resp = await fetchWithAuth('/api/settings');
                const data = await resp.json();
                currentLanguage = data.language || 'ko';
                document.getElementById('setting-language').value = currentLanguage;
                document.getElementById('setting-log-level').value = data.log_level || 'info';
                if (data.llm) {
                    const provider = data.llm.provider || 'solar';
                    document.getElementById('setting-llm-provider').value = provider;

                    // Set model and endpoint with defaults based on provider
                    const defaults = {
                        'solar': { model: 'solar-pro2', endpoint: 'https://api.upstage.ai/v1' },
                        'openai': { model: 'gpt-4', endpoint: 'https://api.openai.com/v1' },
                        'ollama': { model: 'qwen2.5:3b', endpoint: 'http://localhost:11434' },
                        'gemini': { model: 'gemini-pro', endpoint: 'https://generativelanguage.googleapis.com/v1beta' },
                        'anthropic': { model: 'claude-3-opus', endpoint: 'https://api.anthropic.com' }
                    };
                    const providerDefaults = defaults[provider] || { model: '', endpoint: '' };

                    document.getElementById('setting-llm-model').value = data.llm.model || providerDefaults.model;
                    document.getElementById('setting-llm-endpoint').value = data.llm.endpoint || providerDefaults.endpoint;
                    currentLLMModel = data.llm.model || providerDefaults.model;

                    // Load reasoning effort setting
                    if (data.llm.reasoning_effort) {
                        reasoningEffort = data.llm.reasoning_effort;
                        localStorage.setItem('k13d_reasoning_effort', reasoningEffort);
                    }
                } else {
                    // No LLM config from server, set Solar defaults
                    document.getElementById('setting-llm-provider').value = 'solar';
                    document.getElementById('setting-llm-model').value = 'solar-pro2';
                    document.getElementById('setting-llm-endpoint').value = 'https://api.upstage.ai/v1';
                    currentLLMModel = 'solar-pro2';
                }
                // Update endpoint placeholder based on current provider
                updateEndpointPlaceholder();
                // Load local settings
                updateSettingsUI();
                // Update AI panel status
                updateAIStatus();
                // Update UI language based on loaded settings
                updateUILanguage();
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        // Load version info for About page
        async function loadVersionInfo() {
            try {
                const resp = await fetch('/api/version');
                const data = await resp.json();

                const versionEl = document.getElementById('about-version');
                const buildTimeEl = document.getElementById('about-build-time');
                const gitCommitEl = document.getElementById('about-git-commit');

                if (versionEl) {
                    versionEl.textContent = data.version || 'dev';
                    // Add badge for dev version
                    if (data.version === 'dev') {
                        versionEl.innerHTML = '<span style="color: var(--accent-yellow);">dev</span> <span style="font-size: 10px; color: var(--text-muted);">(development build)</span>';
                    }
                }
                if (buildTimeEl) {
                    if (data.build_time && data.build_time !== 'unknown') {
                        // Format the date nicely
                        const date = new Date(data.build_time);
                        if (!isNaN(date.getTime())) {
                            buildTimeEl.textContent = date.toLocaleString();
                        } else {
                            buildTimeEl.textContent = data.build_time;
                        }
                    } else {
                        buildTimeEl.textContent = '-';
                    }
                }
                if (gitCommitEl) {
                    if (data.git_commit && data.git_commit !== 'unknown') {
                        // Show shortened commit hash
                        const shortCommit = data.git_commit.substring(0, 7);
                        gitCommitEl.textContent = shortCommit;
                        gitCommitEl.title = data.git_commit;
                    } else {
                        gitCommitEl.textContent = '-';
                    }
                }
            } catch (e) {
                console.error('Failed to load version info:', e);
            }
        }

        // Update AI Assistant panel with model name and connection status
        async function updateAIStatus() {
            const statusDot = document.getElementById('ai-status-dot');
            const modelBadge = document.getElementById('ai-model-badge');

            if (!statusDot || !modelBadge) return;

            // Show checking state
            statusDot.className = 'ai-status-dot checking';
            statusDot.title = 'Checking connection...';

            try {
                // Get LLM settings to display model name
                const settingsResp = await fetchWithAuth('/api/settings');
                const settings = await settingsResp.json();

                if (settings.llm && settings.llm.model) {
                    currentLLMModel = settings.llm.model;
                    modelBadge.textContent = currentLLMModel;
                    modelBadge.title = `${settings.llm.provider || 'openai'}: ${currentLLMModel}`;
                } else {
                    modelBadge.textContent = 'Not configured';
                    modelBadge.title = 'AI model not configured';
                    statusDot.className = 'ai-status-dot disconnected';
                    statusDot.title = 'AI not configured';
                    llmConnected = false;
                    return;
                }

                // Ping test - try to check LLM connection
                const pingResp = await fetchWithAuth('/api/ai/ping');
                if (pingResp.ok) {
                    statusDot.className = 'ai-status-dot connected';
                    statusDot.title = 'Connected';
                    llmConnected = true;
                } else {
                    statusDot.className = 'ai-status-dot disconnected';
                    statusDot.title = 'Connection failed';
                    llmConnected = false;
                }
            } catch (e) {
                console.error('Failed to check AI status:', e);
                statusDot.className = 'ai-status-dot disconnected';
                statusDot.title = 'Connection error';
                modelBadge.textContent = 'Error';
                llmConnected = false;
            }
        }

        function updateSettingsUI() {
            const streamingToggle = document.getElementById('setting-streaming');
            const autoRefreshToggle = document.getElementById('setting-auto-refresh');
            const intervalSelect = document.getElementById('setting-refresh-interval');

            if (streamingToggle) {
                streamingToggle.classList.toggle('active', useStreaming);
            }
            if (autoRefreshToggle) {
                autoRefreshToggle.classList.toggle('active', autoRefreshEnabled);
            }
            if (intervalSelect) {
                intervalSelect.value = autoRefreshInterval;
            }
        }

        function toggleStreamingSetting() {
            useStreaming = !useStreaming;
            localStorage.setItem('k13d_use_streaming', useStreaming);
            updateSettingsUI();
        }

        function toggleAutoRefreshSetting() {
            toggleAutoRefresh();
            updateSettingsUI();
        }

        function setAutoRefreshIntervalSetting(value) {
            setAutoRefreshInterval(parseInt(value));
            updateSettingsUI();
        }

        function toggleReasoningEffort() {
            reasoningEffort = reasoningEffort === 'minimal' ? 'high' : 'minimal';
            localStorage.setItem('k13d_reasoning_effort', reasoningEffort);
            updateReasoningEffortUI();
            // Save to server config
            saveReasoningEffortToServer();
        }

        function updateReasoningEffortUI() {
            const toggle = document.getElementById('reasoning-effort-toggle');
            const status = document.getElementById('reasoning-effort-status');
            const section = document.getElementById('reasoning-effort-section');
            const provider = document.getElementById('setting-llm-provider')?.value;

            // Show/hide section based on provider (only for solar)
            if (section) {
                section.style.display = (provider === 'solar') ? 'block' : 'none';
            }

            if (toggle) {
                toggle.classList.toggle('active', reasoningEffort === 'high');
            }
            if (status) {
                status.textContent = reasoningEffort === 'high'
                    ? 'Current: high (deeper reasoning enabled)'
                    : 'Current: minimal (default)';
            }
        }

        async function saveReasoningEffortToServer() {
            try {
                await fetchWithAuth('/api/config', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        llm: { reasoning_effort: reasoningEffort }
                    })
                });
            } catch (e) {
                console.error('Failed to save reasoning effort:', e);
            }
        }

        // SSO/Authentication settings handlers
        function onAuthModeChange(mode) {
            const oidcSection = document.getElementById('oidc-settings');
            const ldapSection = document.getElementById('ldap-settings');
            const oauthRoleSection = document.getElementById('oauth-role-settings');

            // Hide all sections first
            if (oidcSection) oidcSection.style.display = 'none';
            if (ldapSection) ldapSection.style.display = 'none';
            if (oauthRoleSection) oauthRoleSection.style.display = 'none';

            // Show relevant section based on mode
            if (mode === 'oidc') {
                if (oidcSection) oidcSection.style.display = 'block';
                if (oauthRoleSection) oauthRoleSection.style.display = 'block';
            } else if (mode === 'ldap') {
                if (ldapSection) ldapSection.style.display = 'block';
            }
        }

        function toggleAllowPasswordLogin() {
            const toggle = document.getElementById('allow-password-login');
            if (toggle) {
                toggle.classList.toggle('active');
            }
        }

        function toggleEnableSignup() {
            const toggle = document.getElementById('enable-signup');
            if (toggle) {
                toggle.classList.toggle('active');
            }
        }

        async function testLDAPConnection() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Testing...';
            btn.disabled = true;

            try {
                const config = {
                    server_url: document.getElementById('ldap-server-url')?.value || '',
                    bind_dn: document.getElementById('ldap-bind-dn')?.value || '',
                    bind_password: document.getElementById('ldap-bind-password')?.value || '',
                    user_search_base: document.getElementById('ldap-user-search-base')?.value || '',
                    user_search_filter: document.getElementById('ldap-user-search-filter')?.value || ''
                };

                const resp = await fetchWithAuth('/api/settings/auth/ldap/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await resp.json();
                if (result.success) {
                    alert('LDAP connection successful!\n\nServer: ' + config.server_url);
                } else {
                    alert('LDAP connection failed:\n' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('LDAP connection test failed:\n' + e.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function getAuthSettings() {
            const mode = document.getElementById('auth-mode')?.value || 'local';
            const settings = { mode };

            if (mode === 'oidc') {
                settings.oidc = {
                    provider_url: document.getElementById('oidc-provider-url')?.value || '',
                    client_id: document.getElementById('oidc-client-id')?.value || '',
                    client_secret: document.getElementById('oidc-client-secret')?.value || '',
                    scopes: document.getElementById('oidc-scopes')?.value || 'openid profile email',
                    redirect_uri: document.getElementById('oidc-redirect-uri')?.value || ''
                };
                settings.oauth_roles = {
                    roles_claim: document.getElementById('oauth-roles-claim')?.value || 'roles',
                    admin_roles: document.getElementById('oauth-admin-roles')?.value || '',
                    allowed_roles: document.getElementById('oauth-allowed-roles')?.value || ''
                };
                settings.allow_password_login = document.getElementById('allow-password-login')?.classList.contains('active') || false;
                settings.enable_signup = document.getElementById('enable-signup')?.classList.contains('active') || false;
            } else if (mode === 'ldap') {
                settings.ldap = {
                    server_url: document.getElementById('ldap-server-url')?.value || '',
                    bind_dn: document.getElementById('ldap-bind-dn')?.value || '',
                    bind_password: document.getElementById('ldap-bind-password')?.value || '',
                    user_search_base: document.getElementById('ldap-user-search-base')?.value || '',
                    user_search_filter: document.getElementById('ldap-user-search-filter')?.value || '(uid={{username}})',
                    group_search_base: document.getElementById('ldap-group-search-base')?.value || '',
                    group_search_filter: document.getElementById('ldap-group-search-filter')?.value || '',
                    admin_group: document.getElementById('ldap-admin-group')?.value || ''
                };
            }

            return settings;
        }

        async function saveAuthSettings() {
            try {
                const authSettings = getAuthSettings();
                const resp = await fetchWithAuth('/api/settings/auth', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(authSettings)
                });

                if (!resp.ok) {
                    const error = await resp.text();
                    throw new Error(error);
                }

                alert('Authentication settings saved!\n\nNote: Server restart may be required for changes to take effect.');
            } catch (e) {
                alert('Failed to save authentication settings:\n' + e.message);
            }
        }

        async function saveSettings() {
            try {
                // Save general settings
                await fetchWithAuth('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        language: document.getElementById('setting-language').value,
                        log_level: document.getElementById('setting-log-level').value
                    })
                });

                // Save LLM settings
                const apiKey = document.getElementById('setting-llm-apikey').value;
                await fetchWithAuth('/api/settings/llm', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: document.getElementById('setting-llm-provider').value,
                        model: document.getElementById('setting-llm-model').value,
                        endpoint: document.getElementById('setting-llm-endpoint').value,
                        api_key: apiKey,
                        reasoning_effort: reasoningEffort
                    })
                });

                // Update current language for AI responses
                currentLanguage = document.getElementById('setting-language').value;
                updateUILanguage();

                closeSettings();
                showToast(t('msg_settings_saved'));

                // Update AI status (model name and connection status)
                updateAIStatus();
            } catch (e) {
                alert('Failed to save settings');
            }
        }

        // Audit logs and reports
        let auditFilter = { onlyLLM: false, onlyErrors: false };

        async function showAuditLogs() {
            currentResource = 'audit';
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('panel-title').textContent = 'Audit Logs';
            document.getElementById('resource-summary').innerHTML = '';

            try {
                // Build query params
                let params = new URLSearchParams();
                if (auditFilter.onlyLLM) params.append('only_llm', 'true');
                if (auditFilter.onlyErrors) params.append('only_errors', 'true');

                const resp = await fetchWithAuth('/api/audit?' + params.toString());
                const data = await resp.json();

                // Create filter controls and header
                document.getElementById('table-header').innerHTML = `
                    <tr>
                        <td colspan="8" style="padding: 10px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);">
                            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" id="filter-llm-only" ${auditFilter.onlyLLM ? 'checked' : ''} onchange="toggleAuditFilter('onlyLLM')">
                                    <span>ðŸ¤– LLM Actions Only</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" id="filter-errors-only" ${auditFilter.onlyErrors ? 'checked' : ''} onchange="toggleAuditFilter('onlyErrors')">
                                    <span>âŒ Errors Only</span>
                                </label>
                                <span style="color: var(--text-secondary); margin-left: auto;">
                                    Showing ${data.logs ? data.logs.length : 0} entries (View actions excluded)
                                </span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th>TIME</th>
                        <th>USER</th>
                        <th>K8S USER</th>
                        <th>ACTION</th>
                        <th>RESOURCE</th>
                        <th>SOURCE</th>
                        <th>STATUS</th>
                        <th>DETAILS</th>
                    </tr>`;

                if (data.logs && data.logs.length > 0) {
                    document.getElementById('table-body').innerHTML = data.logs.map(log => {
                        const isLLM = log.action_type === 'llm' || log.llm_tool;
                        const statusBadge = log.success
                            ? '<span style="color: var(--status-running);">âœ“</span>'
                            : '<span style="color: var(--status-failed);">âœ—</span>';
                        const actionBadge = getActionBadge(log.action, log.action_type);
                        const llmDetails = isLLM && log.llm_tool
                            ? `<div style="margin-top:5px;padding:5px;background:var(--bg-tertiary);border-radius:4px;font-size:11px;">
                                <strong>ðŸ¤– LLM Tool:</strong> ${escapeHtml(log.llm_tool)}<br>
                                <strong>Command:</strong> <code style="color:var(--accent-yellow);">${escapeHtml(log.llm_command || 'N/A')}</code><br>
                                <strong>Approved:</strong> ${log.llm_approved ? 'âœ… Yes' : 'âŒ No'}
                                ${log.llm_request ? `<br><strong>Question:</strong> ${escapeHtml(truncateText(log.llm_request, 100))}` : ''}
                              </div>`
                            : '';
                        const errorInfo = log.error_msg
                            ? `<div style="color:var(--status-failed);margin-top:3px;font-size:11px;">Error: ${escapeHtml(log.error_msg)}</div>`
                            : '';

                        return `
                            <tr style="${!log.success ? 'background: rgba(239,68,68,0.1);' : (isLLM ? 'background: rgba(59,130,246,0.05);' : '')}">
                                <td style="white-space:nowrap;">${new Date(log.timestamp).toLocaleString()}</td>
                                <td>${escapeHtml(log.user || 'anonymous')}</td>
                                <td style="color:var(--accent-cyan);">${escapeHtml(log.k8s_user || '-')}</td>
                                <td>${actionBadge}</td>
                                <td>${escapeHtml(log.resource)}</td>
                                <td><span style="padding:2px 6px;border-radius:3px;background:var(--bg-tertiary);font-size:11px;">${escapeHtml(log.source || 'unknown')}</span></td>
                                <td style="text-align:center;">${statusBadge}</td>
                                <td>
                                    ${escapeHtml(log.details)}
                                    ${llmDetails}
                                    ${errorInfo}
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    document.getElementById('table-body').innerHTML =
                        '<tr><td colspan="8" style="text-align:center;padding:40px;">No audit logs found (View actions are excluded by default)</td></tr>';
                }
            } catch (e) {
                console.error('Failed to load audit logs:', e);
            }
        }

        function toggleAuditFilter(filterName) {
            auditFilter[filterName] = !auditFilter[filterName];
            showAuditLogs();
        }

        function getActionBadge(action, actionType) {
            const colors = {
                'llm': { bg: 'rgba(59,130,246,0.2)', color: 'var(--accent-blue)', icon: 'ðŸ¤–' },
                'mutation': { bg: 'rgba(234,179,8,0.2)', color: 'var(--accent-yellow)', icon: 'âš¡' },
                'auth': { bg: 'rgba(139,92,246,0.2)', color: 'var(--accent-purple)', icon: 'ðŸ”' },
                'config': { bg: 'rgba(34,197,94,0.2)', color: 'var(--status-running)', icon: 'âš™ï¸' }
            };
            const style = colors[actionType] || colors['mutation'];
            return `<span style="padding:2px 8px;border-radius:4px;background:${style.bg};color:${style.color};font-size:12px;">${style.icon} ${escapeHtml(action)}</span>`;
        }

        function truncateText(text, maxLen) {
            if (!text) return '';
            return text.length > maxLen ? text.substring(0, maxLen) + '...' : text;
        }

        async function showReports() {
            currentResource = 'reports';
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('panel-title').textContent = 'Cluster Report & FinOps Analysis';
            document.getElementById('resource-summary').innerHTML = '';

            document.getElementById('table-header').innerHTML = '';
            document.getElementById('table-body').innerHTML = `
                <tr><td colspan="5" style="padding: 40px; text-align: center;">
                    <div style="max-width: 800px; margin: 0 auto;">
                        <h2 style="margin-bottom: 20px; color: var(--accent-blue);">ðŸ“Š Generate Cluster Report</h2>
                        <p style="margin-bottom: 30px; color: var(--text-secondary);">
                            Generate a comprehensive report including nodes, pods, deployments, services,
                            container images, security analysis, <strong style="color: var(--accent-green);">FinOps cost optimization</strong>, and AI-powered insights.
                        </p>

                        <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="include-ai-analysis" checked>
                                <span>Include AI Analysis with FinOps recommendations</span>
                            </label>

                            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 10px;">
                                <button class="refresh-btn" onclick="previewReport()" style="padding: 12px 24px; font-size: 14px; background: var(--accent-green);">
                                    ðŸ‘ï¸ Preview Report
                                </button>
                                <button class="refresh-btn" onclick="downloadReport('html')" style="padding: 12px 24px; font-size: 14px;">
                                    ðŸ“„ Download HTML
                                </button>
                                <button class="refresh-btn" onclick="downloadReport('csv')" style="padding: 12px 24px; font-size: 14px;">
                                    ðŸ“Š Download CSV
                                </button>
                                <button class="refresh-btn" onclick="generateReport('json')" style="padding: 12px 24px; font-size: 14px;">
                                    ðŸ“‹ View Summary
                                </button>
                            </div>
                        </div>

                        <div id="report-status" style="margin-top: 30px;"></div>
                        <div id="report-preview" style="margin-top: 20px; text-align: left;"></div>
                    </div>
                </td></tr>
            `;
        }

        // Preview report in new window
        async function previewReport() {
            const includeAI = document.getElementById('include-ai-analysis')?.checked ?? true;
            const statusEl = document.getElementById('report-status');

            statusEl.innerHTML = `<div style="color: var(--accent-blue);">
                <span class="loading-dots"><span></span><span></span><span></span></span>
                Generating report preview${includeAI ? ' with AI analysis' : ''}... This may take a moment.
            </div>`;

            try {
                const url = `/api/reports/preview?ai=${includeAI}`;
                const resp = await fetchWithAuth(url);

                if (!resp.ok) throw new Error('Failed to generate report');

                const html = await resp.text();

                // Open in new window
                const previewWindow = window.open('', '_blank', 'width=1200,height=800');
                previewWindow.document.write(html);
                previewWindow.document.close();

                statusEl.innerHTML = `<div style="color: var(--accent-green);">
                    âœ“ Report preview opened in new window
                </div>`;
            } catch (e) {
                statusEl.innerHTML = `<div style="color: var(--accent-red);">
                    âœ• Failed to generate preview: ${e.message}
                </div>`;
            }
        }

        // Download report
        async function downloadReport(format) {
            const includeAI = document.getElementById('include-ai-analysis')?.checked ?? true;
            const statusEl = document.getElementById('report-status');

            statusEl.innerHTML = `<div style="color: var(--accent-blue);">
                <span class="loading-dots"><span></span><span></span><span></span></span>
                Generating ${format.toUpperCase()} report${includeAI ? ' with AI analysis' : ''}...
            </div>`;

            try {
                const url = `/api/reports?format=${format}&ai=${includeAI}&download=true`;
                const resp = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!resp.ok) throw new Error('Failed to generate report');

                const blob = await resp.blob();
                const filename = resp.headers.get('Content-Disposition')?.match(/filename=(.+)/)?.[1]
                    || `k13d-report-${new Date().toISOString().slice(0,10)}.${format}`;

                // Trigger download
                const downloadUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);

                statusEl.innerHTML = `<div style="color: var(--accent-green);">
                    âœ“ Report downloaded: ${filename}
                </div>`;

                if (format === 'html') {
                    document.getElementById('report-preview').innerHTML = `
                        <p style="color: var(--text-secondary); margin-top: 10px;">
                            ðŸ’¡ <strong>Tip:</strong> Open the HTML file in your browser and use Print â†’ Save as PDF to create a PDF version.
                        </p>
                    `;
                }
            } catch (e) {
                statusEl.innerHTML = `<div style="color: var(--accent-red);">
                    âœ• Failed to download report: ${e.message}
                </div>`;
            }
        }

        async function generateReport(format) {
            const includeAI = document.getElementById('include-ai-analysis')?.checked ?? true;
            const statusEl = document.getElementById('report-status');
            const previewEl = document.getElementById('report-preview');

            statusEl.innerHTML = `<div style="color: var(--accent-blue);">
                <span class="loading-dots"><span></span><span></span><span></span></span>
                Generating report${includeAI ? ' with AI analysis' : ''}... This may take a moment.
            </div>`;
            previewEl.innerHTML = '';

            try {
                const url = `/api/reports?format=${format}&ai=${includeAI}`;

                if (format === 'json') {
                    // View JSON in preview
                    const resp = await fetchWithAuth(url);
                    const report = await resp.json();

                    statusEl.innerHTML = `<div style="color: var(--accent-green);">
                        âœ“ Report generated successfully at ${new Date(report.generated_at).toLocaleString()}
                    </div>`;

                    // Calculate total potential savings
                    const totalSavings = (report.finops_analysis?.cost_optimizations || [])
                        .reduce((sum, opt) => sum + (opt.estimated_saving || 0), 0);

                    // Show summary with FinOps
                    previewEl.innerHTML = `
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; margin-top: 20px;">
                            <h3 style="margin-bottom: 15px;">ðŸ“ˆ Report Summary</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 22px; font-weight: bold; color: var(--accent-blue);">${report.node_summary?.total || 0}</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Nodes (${report.node_summary?.ready || 0} Ready)</div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 22px; font-weight: bold; color: var(--accent-green);">${report.workloads?.total_pods || 0}</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Pods (${report.workloads?.running_pods || 0} Running)</div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 22px; font-weight: bold; color: var(--accent-purple);">${report.workloads?.total_deployments || 0}</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Deployments</div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 22px; font-weight: bold; color: ${report.health_score >= 90 ? 'var(--accent-green)' : report.health_score >= 70 ? 'var(--accent-yellow)' : 'var(--accent-red)'};">${Math.round(report.health_score || 0)}%</div>
                                    <div style="font-size: 11px; color: var(--text-secondary);">Health Score</div>
                                </div>
                            </div>

                            <!-- FinOps Section -->
                            <div style="margin-top: 25px; background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%); padding: 20px; border-radius: 8px; border: 1px solid #4caf50;">
                                <h3 style="margin-bottom: 15px; color: #9ece6a;">ðŸ’° FinOps Cost Analysis</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px;">
                                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: bold; color: #9ece6a;">$${(report.finops_analysis?.total_estimated_monthly_cost || 0).toFixed(2)}</div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">Est. Monthly Cost</div>
                                    </div>
                                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: bold; color: #7dcfff;">${(report.finops_analysis?.resource_efficiency?.cpu_requests_vs_capacity || 0).toFixed(1)}%</div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">CPU Utilization</div>
                                    </div>
                                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: bold; color: #bb9af7;">${(report.finops_analysis?.resource_efficiency?.memory_requests_vs_capacity || 0).toFixed(1)}%</div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">Memory Utilization</div>
                                    </div>
                                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 24px; font-weight: bold; color: #f7768e;">$${totalSavings.toFixed(2)}</div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">Potential Savings/mo</div>
                                    </div>
                                </div>

                                ${(report.finops_analysis?.cost_optimizations || []).length > 0 ? `
                                    <h4 style="margin: 15px 0 10px 0; color: #e0af68;">âš¡ Cost Optimization Recommendations</h4>
                                    <div style="max-height: 200px; overflow-y: auto;">
                                        ${(report.finops_analysis?.cost_optimizations || []).slice(0, 5).map(opt => `
                                            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid ${opt.priority === 'high' ? '#f7768e' : opt.priority === 'medium' ? '#e0af68' : '#9ece6a'};">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-weight: bold; color: ${opt.priority === 'high' ? '#f7768e' : opt.priority === 'medium' ? '#e0af68' : '#9ece6a'};">[${opt.priority.toUpperCase()}] ${escapeHtml(opt.category)}</span>
                                                    <span style="color: #9ece6a; font-weight: bold;">Save $${(opt.estimated_saving || 0).toFixed(2)}/mo</span>
                                                </div>
                                                <div style="font-size: 12px; margin-top: 5px; color: var(--text-secondary);">${escapeHtml(opt.description)}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<p style="color: var(--text-secondary);">No optimization recommendations at this time.</p>'}
                            </div>

                            ${report.ai_analysis ? `
                                <div style="margin-top: 20px;">
                                    <h4 style="margin-bottom: 10px;">ðŸ¤– AI Analysis with FinOps Insights</h4>
                                    <div style="background: var(--bg-primary); padding: 15px; border-radius: 6px; white-space: pre-wrap; font-size: 13px; max-height: 300px; overflow-y: auto; border-left: 3px solid var(--accent-blue);">
                                        ${escapeHtml(report.ai_analysis)}
                                    </div>
                                </div>
                            ` : ''}

                            <div style="margin-top: 20px;">
                                <h4 style="margin-bottom: 10px;">ðŸ“Š Cost by Namespace (Top 5)</h4>
                                <table style="width: 100%; font-size: 12px;">
                                    <tr style="background: var(--bg-secondary);"><th style="padding: 8px;">Namespace</th><th style="padding: 8px;">Pods</th><th style="padding: 8px;">CPU</th><th style="padding: 8px;">Memory</th><th style="padding: 8px;">Est. Cost</th></tr>
                                    ${(report.finops_analysis?.cost_by_namespace || []).slice(0, 5).map(ns => `
                                        <tr><td style="padding: 8px;">${escapeHtml(ns.namespace)}</td><td style="padding: 8px;">${ns.pod_count}</td><td style="padding: 8px;">${escapeHtml(ns.cpu_requests)}</td><td style="padding: 8px;">${escapeHtml(ns.memory_requests)}</td><td style="padding: 8px;">$${(ns.estimated_cost || 0).toFixed(2)}</td></tr>
                                    `).join('')}
                                </table>
                            </div>

                            <div style="margin-top: 20px;">
                                <h4 style="margin-bottom: 10px;">ðŸ³ Top Container Images</h4>
                                <table style="width: 100%; font-size: 12px;">
                                    <tr style="background: var(--bg-secondary);"><th style="padding: 8px;">Image</th><th style="padding: 8px;">Tag</th><th style="padding: 8px;">Pods</th></tr>
                                    ${(report.images || []).slice(0, 8).map(img => `
                                        <tr><td style="padding: 8px;">${escapeHtml(img.repository)}</td><td style="padding: 8px;">${escapeHtml(img.tag)}</td><td style="padding: 8px;">${img.pod_count}</td></tr>
                                    `).join('')}
                                </table>
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                statusEl.innerHTML = `<div style="color: var(--accent-red);">
                    âœ• Failed to generate report: ${e.message}
                </div>`;
            }
        }

        // Note: Auto-refresh is now handled by startAutoRefresh() in init()
        // with user-configurable interval settings

        // Global search across all resources
        let searchTimeout = null;
        let searchSelectedIndex = -1;
        let searchResults = [];

        function handleGlobalSearchInput(event) {
            const query = event.target.value.trim();

            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            if (query.length < 2) {
                hideSearchResults();
                return;
            }

            // Debounce search
            searchTimeout = setTimeout(() => {
                performGlobalSearch(query);
            }, 300);
        }

        function handleGlobalSearchKeydown(event) {
            const resultsDiv = document.getElementById('search-results');
            const items = resultsDiv.querySelectorAll('.search-result-item');

            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    searchSelectedIndex = Math.min(searchSelectedIndex + 1, items.length - 1);
                    updateSearchSelection(items);
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    searchSelectedIndex = Math.max(searchSelectedIndex - 1, 0);
                    updateSearchSelection(items);
                    break;
                case 'Enter':
                    event.preventDefault();
                    if (searchSelectedIndex >= 0 && searchResults[searchSelectedIndex]) {
                        navigateToSearchResult(searchResults[searchSelectedIndex]);
                    }
                    break;
                case 'Escape':
                    hideSearchResults();
                    event.target.blur();
                    break;
            }
        }

        function updateSearchSelection(items) {
            items.forEach((item, idx) => {
                if (idx === searchSelectedIndex) {
                    item.style.background = 'var(--bg-tertiary)';
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.style.background = '';
                }
            });
        }

        async function performGlobalSearch(query) {
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '<div class="search-loading">Searching...</div>';
            resultsDiv.style.display = 'block';

            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&namespace=${currentNamespace || ''}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) throw new Error('Search failed');

                const data = await response.json();
                searchResults = data.results || [];
                searchSelectedIndex = -1;

                if (searchResults.length === 0) {
                    resultsDiv.innerHTML = '<div class="search-no-results">No results found</div>';
                } else {
                    resultsDiv.innerHTML = searchResults.map((result, idx) => `
                        <div class="search-result-item" onclick="navigateToSearchResult(searchResults[${idx}])">
                            <span class="search-result-kind ${result.kind.toLowerCase()}">${result.kind}</span>
                            <div class="search-result-info">
                                <div class="search-result-name">${escapeHtml(result.name)}</div>
                                ${result.namespace ? `<div class="search-result-namespace">${escapeHtml(result.namespace)}</div>` : ''}
                            </div>
                            ${result.status ? `<span class="search-result-status ${result.status.toLowerCase().replace(/\s/g, '')}">${result.status}</span>` : ''}
                        </div>
                    `).join('');
                }
            } catch (e) {
                resultsDiv.innerHTML = '<div class="search-no-results">Search error</div>';
                console.error('Search error:', e);
            }
        }

        function navigateToSearchResult(result) {
            hideSearchResults();
            document.getElementById('global-search').value = '';

            // Map kind to resource type
            const kindToResource = {
                'Pod': 'pods',
                'Deployment': 'deployments',
                'Service': 'services',
                'StatefulSet': 'statefulsets',
                'DaemonSet': 'daemonsets',
                'ConfigMap': 'configmaps',
                'Secret': 'secrets',
                'Ingress': 'ingresses',
                'Node': 'nodes',
                'Namespace': 'namespaces',
                'ReplicaSet': 'replicasets',
                'Job': 'jobs',
                'CronJob': 'cronjobs'
            };

            const resourceType = kindToResource[result.kind] || result.kind.toLowerCase() + 's';

            // Switch namespace if needed
            if (result.namespace && result.namespace !== currentNamespace) {
                currentNamespace = result.namespace;
                document.getElementById('namespace-select').value = result.namespace;
            }

            // Switch to the resource type
            switchResource(resourceType);

            // Set filter to highlight the specific resource
            setTimeout(() => {
                document.getElementById('filter-input').value = result.name;
                currentFilter = result.name.toLowerCase();
                applyFilterAndSort();
            }, 500);
        }

        function showSearchResults() {
            const query = document.getElementById('global-search').value.trim();
            if (query.length >= 2 && searchResults.length > 0) {
                document.getElementById('search-results').style.display = 'block';
            }
        }

        function hideSearchResults() {
            document.getElementById('search-results').style.display = 'none';
            searchSelectedIndex = -1;
        }

        // Hide search results when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                hideSearchResults();
            }
        });

        // Filter functionality
        let currentFilter = '';
        let cachedData = [];

        function handleFilter(event) {
            currentFilter = event.target.value.trim().toLowerCase();
            // Use the new filtering system that works with sorting/pagination
            currentPage = 1;
            applyFilterAndSort();
        }

        // Legacy filterTable for compatibility (now uses new system)
        function filterTable(query) {
            document.getElementById('filter-input').value = query;
            currentPage = 1;
            applyFilterAndSort();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Check if command bar is open
            const commandBarOpen = document.getElementById('command-bar-overlay').classList.contains('active');
            const yamlEditorOpen = document.getElementById('yaml-editor-modal').classList.contains('active');

            // Handle command bar input separately
            if (commandBarOpen) {
                handleCommandBarKeydown(e);
                return;
            }

            // Handle YAML editor shortcuts
            if (yamlEditorOpen) {
                handleYamlEditorKeydown(e);
                return;
            }

            // Ignore if in input/textarea (except for specific shortcuts)
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                if (e.key === 'Escape') {
                    e.target.blur();
                }
                return;
            }

            // Check for modifiers
            const isMeta = e.metaKey || e.ctrlKey;
            const isAlt = e.altKey;

            // Alt+number for namespace switching
            if (isAlt && e.key >= '0' && e.key <= '9') {
                e.preventDefault();
                switchToRecentNamespace(parseInt(e.key));
                return;
            }

            switch (e.key.toLowerCase()) {
                case 'k':
                    if (isMeta) {
                        e.preventDefault();
                        document.getElementById('global-search').focus();
                    }
                    break;
                case 'f':
                    if (isMeta) {
                        e.preventDefault();
                        toggleColumnFilters();
                    }
                    break;
                case '/':
                    e.preventDefault();
                    document.getElementById('filter-input').focus();
                    break;
                case ':':
                    e.preventDefault();
                    openCommandBar();
                    break;
                case 'r':
                    e.preventDefault();
                    refreshData();
                    break;
                case 'a':
                    e.preventDefault();
                    toggleAIPanel();
                    break;
                case 'b':
                    e.preventDefault();
                    toggleSidebar();
                    break;
                case 'd':
                    e.preventDefault();
                    toggleDebugMode();
                    break;
                case 'e':
                    e.preventDefault();
                    openYamlEditor();
                    break;
                case 'n':
                    e.preventDefault();
                    showNamespaceIndicator();
                    break;
                case '1':
                    e.preventDefault();
                    switchResource('pods');
                    break;
                case '2':
                    e.preventDefault();
                    switchResource('deployments');
                    break;
                case '3':
                    e.preventDefault();
                    switchResource('services');
                    break;
                case '4':
                    e.preventDefault();
                    switchResource('nodes');
                    break;
                case 's':
                    e.preventDefault();
                    showSettings();
                    break;
                case '?':
                    e.preventDefault();
                    showShortcuts();
                    break;
                case 'escape':
                    closeAllModals();
                    hideNamespaceIndicator();
                    break;
            }
        });

        function toggleAIPanel() {
            const panel = document.getElementById('ai-panel');
            const handle = document.getElementById('resize-handle');
            if (panel.style.display === 'none') {
                panel.style.display = 'flex';
                handle.style.display = 'block';
            } else {
                panel.style.display = 'none';
                handle.style.display = 'none';
            }
        }

        function closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
            closeCommandBar();
            closeYamlEditor();
        }

        // ==================== Command Bar (TUI-style : mode) ====================
        const commandDefinitions = [
            // Resource commands
            { name: 'pods', alias: ['po', 'pod'], desc: 'View Pods', action: () => switchResource('pods') },
            { name: 'deployments', alias: ['deploy', 'dep'], desc: 'View Deployments', action: () => switchResource('deployments') },
            { name: 'services', alias: ['svc', 'service'], desc: 'View Services', action: () => switchResource('services') },
            { name: 'statefulsets', alias: ['sts'], desc: 'View StatefulSets', action: () => switchResource('statefulsets') },
            { name: 'daemonsets', alias: ['ds'], desc: 'View DaemonSets', action: () => switchResource('daemonsets') },
            { name: 'replicasets', alias: ['rs'], desc: 'View ReplicaSets', action: () => switchResource('replicasets') },
            { name: 'configmaps', alias: ['cm'], desc: 'View ConfigMaps', action: () => switchResource('configmaps') },
            { name: 'secrets', alias: ['sec'], desc: 'View Secrets', action: () => switchResource('secrets') },
            { name: 'ingresses', alias: ['ing'], desc: 'View Ingresses', action: () => switchResource('ingresses') },
            { name: 'jobs', alias: ['job'], desc: 'View Jobs', action: () => switchResource('jobs') },
            { name: 'cronjobs', alias: ['cj'], desc: 'View CronJobs', action: () => switchResource('cronjobs') },
            { name: 'nodes', alias: ['no', 'node'], desc: 'View Nodes', action: () => switchResource('nodes') },
            { name: 'namespaces', alias: ['ns'], desc: 'View Namespaces', action: () => switchResource('namespaces') },
            { name: 'pvcs', alias: ['pvc'], desc: 'View PVCs', action: () => switchResource('pvcs') },
            { name: 'pvs', alias: ['pv'], desc: 'View PVs', action: () => switchResource('pvs') },
            { name: 'events', alias: ['ev'], desc: 'View Events', action: () => switchResource('events') },
            { name: 'serviceaccounts', alias: ['sa'], desc: 'View Service Accounts', action: () => switchResource('serviceaccounts') },
            { name: 'roles', alias: ['role'], desc: 'View Roles', action: () => switchResource('roles') },
            { name: 'rolebindings', alias: ['rb'], desc: 'View RoleBindings', action: () => switchResource('rolebindings') },
            { name: 'clusterroles', alias: ['cr'], desc: 'View ClusterRoles', action: () => switchResource('clusterroles') },
            { name: 'clusterrolebindings', alias: ['crb'], desc: 'View ClusterRoleBindings', action: () => switchResource('clusterrolebindings') },
            // Actions
            { name: 'refresh', alias: ['r', 'reload'], desc: 'Refresh current data', action: () => refreshData() },
            { name: 'ai', alias: ['assistant', 'chat'], desc: 'Toggle AI Panel', action: () => toggleAIPanel() },
            { name: 'settings', alias: ['config', 'set'], desc: 'Open Settings', action: () => showSettings() },
            { name: 'help', alias: ['?', 'h'], desc: 'Show Shortcuts', action: () => showShortcuts() },
            { name: 'yaml', alias: ['edit', 'create'], desc: 'Open YAML Editor', action: () => openYamlEditor() },
            { name: 'metrics', alias: ['metric'], desc: 'Show Metrics View', action: () => document.getElementById('metrics-tab')?.click() },
            { name: 'audit', alias: ['log', 'history'], desc: 'Show Audit Logs', action: () => document.getElementById('audit-tab')?.click() },
        ];

        let commandSelectedIndex = 0;
        let filteredCommands = [];

        function openCommandBar() {
            const overlay = document.getElementById('command-bar-overlay');
            const input = document.getElementById('command-input');
            overlay.classList.add('active');
            input.value = '';
            input.focus();
            commandSelectedIndex = 0;
            updateCommandSuggestions('');
        }

        function closeCommandBar() {
            document.getElementById('command-bar-overlay').classList.remove('active');
        }

        function handleCommandBarKeydown(e) {
            const input = document.getElementById('command-input');

            switch (e.key) {
                case 'Escape':
                    e.preventDefault();
                    closeCommandBar();
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    commandSelectedIndex = Math.min(commandSelectedIndex + 1, filteredCommands.length - 1);
                    renderCommandSuggestions();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    commandSelectedIndex = Math.max(commandSelectedIndex - 1, 0);
                    renderCommandSuggestions();
                    break;
                case 'Tab':
                    e.preventDefault();
                    if (filteredCommands.length > 0) {
                        input.value = filteredCommands[commandSelectedIndex].name;
                        updateCommandSuggestions(input.value);
                    }
                    break;
                case 'Enter':
                    e.preventDefault();
                    executeSelectedCommand();
                    break;
                default:
                    // Let input handle it, then update suggestions
                    setTimeout(() => updateCommandSuggestions(input.value), 0);
            }
        }

        function updateCommandSuggestions(query) {
            query = query.toLowerCase().trim();

            if (!query) {
                filteredCommands = commandDefinitions.slice(0, 15);
            } else {
                filteredCommands = commandDefinitions.filter(cmd => {
                    if (cmd.name.startsWith(query)) return true;
                    if (cmd.alias.some(a => a.startsWith(query))) return true;
                    if (cmd.desc.toLowerCase().includes(query)) return true;
                    return false;
                }).slice(0, 10);
            }

            commandSelectedIndex = 0;
            renderCommandSuggestions();
        }

        function renderCommandSuggestions() {
            const container = document.getElementById('command-suggestions');

            if (filteredCommands.length === 0) {
                container.innerHTML = '<div class="command-suggestion" style="color: var(--text-secondary);">No matching commands</div>';
                return;
            }

            container.innerHTML = filteredCommands.map((cmd, i) => `
                <div class="command-suggestion ${i === commandSelectedIndex ? 'selected' : ''}"
                     onclick="executeCommand(${i})"
                     onmouseover="commandSelectedIndex = ${i}; renderCommandSuggestions();">
                    <div>
                        <span class="command-suggestion-name">${cmd.name}</span>
                        <span class="command-suggestion-desc"> - ${cmd.desc}</span>
                    </div>
                    <span class="command-suggestion-shortcut">${cmd.alias[0] || ''}</span>
                </div>
            `).join('');
        }

        function executeCommand(index) {
            if (filteredCommands[index]) {
                closeCommandBar();
                filteredCommands[index].action();
            }
        }

        function executeSelectedCommand() {
            const input = document.getElementById('command-input').value.trim().toLowerCase();

            // First try exact match
            const exactMatch = commandDefinitions.find(cmd =>
                cmd.name === input || cmd.alias.includes(input)
            );

            if (exactMatch) {
                closeCommandBar();
                exactMatch.action();
                return;
            }

            // Otherwise execute selected suggestion
            if (filteredCommands[commandSelectedIndex]) {
                closeCommandBar();
                filteredCommands[commandSelectedIndex].action();
            }
        }

        // Click outside to close command bar
        document.getElementById('command-bar-overlay')?.addEventListener('click', (e) => {
            if (e.target.id === 'command-bar-overlay') {
                closeCommandBar();
            }
        });

        // ==================== Namespace Quick Switcher ====================
        let recentNamespaces = [];
        let namespaceIndicatorTimeout = null;

        function trackNamespaceUsage(ns) {
            // Remove if already exists
            recentNamespaces = recentNamespaces.filter(n => n !== ns);
            // Add to front
            if (ns) {
                recentNamespaces.unshift(ns);
            }
            // Keep max 9
            recentNamespaces = recentNamespaces.slice(0, 9);
            // Save to localStorage
            localStorage.setItem('k13d-recent-namespaces', JSON.stringify(recentNamespaces));
        }

        function loadRecentNamespaces() {
            try {
                const saved = localStorage.getItem('k13d-recent-namespaces');
                if (saved) {
                    recentNamespaces = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Failed to load recent namespaces:', e);
            }
        }

        function switchToRecentNamespace(index) {
            if (index === 0) {
                // All namespaces
                document.getElementById('namespace-select').value = '';
                currentNamespace = '';
                onNamespaceChange();
                showNotification('Switched to All Namespaces');
                return;
            }

            const ns = recentNamespaces[index - 1];
            if (ns) {
                document.getElementById('namespace-select').value = ns;
                currentNamespace = ns;
                onNamespaceChange();
                showNotification(`Switched to namespace: ${ns}`);
            }
        }

        function showNamespaceIndicator() {
            const indicator = document.getElementById('namespace-indicator');

            // Build namespace keys
            let html = `
                <div class="namespace-key ${!currentNamespace ? 'current' : ''}" onclick="switchToRecentNamespace(0)">
                    <span class="namespace-key-num">0</span>
                    <span class="namespace-key-name">All</span>
                </div>
            `;

            for (let i = 0; i < 9; i++) {
                const ns = recentNamespaces[i];
                const isCurrent = ns && ns === currentNamespace;
                html += `
                    <div class="namespace-key ${isCurrent ? 'current' : ''} ${!ns ? 'disabled' : ''}"
                         onclick="${ns ? `switchToRecentNamespace(${i + 1})` : ''}"
                         style="${!ns ? 'opacity: 0.3; cursor: default;' : ''}">
                        <span class="namespace-key-num">${i + 1}</span>
                        <span class="namespace-key-name">${ns || '-'}</span>
                    </div>
                `;
            }

            indicator.innerHTML = html;
            indicator.classList.add('active');

            // Auto hide after 3 seconds
            if (namespaceIndicatorTimeout) {
                clearTimeout(namespaceIndicatorTimeout);
            }
            namespaceIndicatorTimeout = setTimeout(hideNamespaceIndicator, 3000);
        }

        function hideNamespaceIndicator() {
            document.getElementById('namespace-indicator').classList.remove('active');
            if (namespaceIndicatorTimeout) {
                clearTimeout(namespaceIndicatorTimeout);
                namespaceIndicatorTimeout = null;
            }
        }

        // Track namespace changes
        const originalOnNamespaceChange = typeof onNamespaceChange === 'function' ? onNamespaceChange : null;

        // ==================== YAML Editor ====================
        const yamlTemplates = [
            {
                title: 'Pod',
                desc: 'Basic Pod template',
                yaml: `apiVersion: v1
kind: Pod
metadata:
  name: my-pod
  namespace: default
  labels:
    app: my-app
spec:
  containers:
  - name: main
    image: nginx:latest
    ports:
    - containerPort: 80
    resources:
      limits:
        memory: "128Mi"
        cpu: "500m"`
            },
            {
                title: 'Deployment',
                desc: 'Deployment with replicas',
                yaml: `apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-deployment
  namespace: default
spec:
  replicas: 3
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
      - name: main
        image: nginx:latest
        ports:
        - containerPort: 80`
            },
            {
                title: 'Service',
                desc: 'ClusterIP Service',
                yaml: `apiVersion: v1
kind: Service
metadata:
  name: my-service
  namespace: default
spec:
  selector:
    app: my-app
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP`
            },
            {
                title: 'ConfigMap',
                desc: 'Configuration data',
                yaml: `apiVersion: v1
kind: ConfigMap
metadata:
  name: my-config
  namespace: default
data:
  config.json: |
    {
      "key": "value"
    }
  APP_ENV: production`
            },
            {
                title: 'Secret',
                desc: 'Opaque Secret',
                yaml: `apiVersion: v1
kind: Secret
metadata:
  name: my-secret
  namespace: default
type: Opaque
stringData:
  username: admin
  password: changeme`
            },
            {
                title: 'Ingress',
                desc: 'HTTP Ingress rule',
                yaml: `apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: my-ingress
  namespace: default
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - host: example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: my-service
            port:
              number: 80`
            },
            {
                title: 'CronJob',
                desc: 'Scheduled job',
                yaml: `apiVersion: batch/v1
kind: CronJob
metadata:
  name: my-cronjob
  namespace: default
spec:
  schedule: "*/5 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: job
            image: busybox
            command: ["echo", "Hello"]
          restartPolicy: OnFailure`
            },
            {
                title: 'PVC',
                desc: 'Persistent Volume Claim',
                yaml: `apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc
  namespace: default
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi`
            }
        ];

        let yamlEditorMode = 'create'; // 'create' or 'edit'
        let yamlEditingResource = null;

        function openYamlEditor(existingYaml = null, resourceInfo = null) {
            const modal = document.getElementById('yaml-editor-modal');
            const textarea = document.getElementById('yaml-editor-content');
            const modeLabel = document.getElementById('yaml-editor-mode');
            const nsSelect = document.getElementById('yaml-editor-namespace');

            // Populate namespace select
            nsSelect.innerHTML = document.getElementById('namespace-select').innerHTML;
            nsSelect.value = currentNamespace || '';

            // Render templates
            renderYamlTemplates();

            if (existingYaml) {
                textarea.value = existingYaml;
                yamlEditorMode = 'edit';
                modeLabel.textContent = 'Edit';
                modeLabel.style.background = 'var(--accent-yellow)';
                yamlEditingResource = resourceInfo;
            } else {
                textarea.value = '';
                yamlEditorMode = 'create';
                modeLabel.textContent = 'Create';
                modeLabel.style.background = 'var(--accent-blue)';
                yamlEditingResource = null;
            }

            updateYamlEditorStatus('valid', 'Ready');
            modal.classList.add('active');
            textarea.focus();
        }

        function closeYamlEditor() {
            document.getElementById('yaml-editor-modal').classList.remove('active');
        }

        function renderYamlTemplates() {
            const container = document.getElementById('yaml-template-list');
            container.innerHTML = yamlTemplates.map((tpl, i) => `
                <div class="yaml-template-item" onclick="loadYamlTemplate(${i})">
                    <div class="yaml-template-item-title">${tpl.title}</div>
                    <div class="yaml-template-item-desc">${tpl.desc}</div>
                </div>
            `).join('');
        }

        function loadYamlTemplate(index) {
            const tpl = yamlTemplates[index];
            if (tpl) {
                const textarea = document.getElementById('yaml-editor-content');
                // Replace namespace in template
                const ns = document.getElementById('yaml-editor-namespace').value || 'default';
                let yaml = tpl.yaml.replace(/namespace: default/g, `namespace: ${ns}`);
                textarea.value = yaml;
                updateYamlEditorStatus('valid', 'Template loaded');
            }
        }

        function validateYaml() {
            const yaml = document.getElementById('yaml-editor-content').value;

            if (!yaml.trim()) {
                updateYamlEditorStatus('invalid', 'YAML is empty');
                return false;
            }

            // Basic validation
            if (!yaml.includes('apiVersion:')) {
                updateYamlEditorStatus('invalid', 'Missing apiVersion');
                return false;
            }
            if (!yaml.includes('kind:')) {
                updateYamlEditorStatus('invalid', 'Missing kind');
                return false;
            }
            if (!yaml.includes('metadata:')) {
                updateYamlEditorStatus('invalid', 'Missing metadata');
                return false;
            }

            updateYamlEditorStatus('valid', 'YAML is valid');
            return true;
        }

        function formatYaml() {
            // Simple formatting - just normalize indentation
            const textarea = document.getElementById('yaml-editor-content');
            const yaml = textarea.value;

            try {
                // Basic cleanup
                let formatted = yaml
                    .replace(/\t/g, '  ')  // Tabs to spaces
                    .replace(/  +$/gm, '') // Trailing spaces
                    .replace(/\n{3,}/g, '\n\n'); // Multiple blank lines

                textarea.value = formatted;
                updateYamlEditorStatus('valid', 'Formatted');
            } catch (e) {
                updateYamlEditorStatus('invalid', 'Format error: ' + e.message);
            }
        }

        async function applyYaml() {
            const yaml = document.getElementById('yaml-editor-content').value;
            const dryRun = document.getElementById('yaml-dry-run').checked;
            const namespace = document.getElementById('yaml-editor-namespace').value || 'default';

            if (!validateYaml()) {
                return;
            }

            updateYamlEditorStatus('valid', dryRun ? 'Validating (dry-run)...' : 'Applying...');

            try {
                const resp = await fetchWithAuth('/api/k8s/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        yaml: yaml,
                        namespace: namespace,
                        dryRun: dryRun
                    })
                });

                const result = await resp.json();

                if (result.error) {
                    updateYamlEditorStatus('invalid', 'Error: ' + result.error);
                    return;
                }

                if (dryRun) {
                    updateYamlEditorStatus('valid', 'Dry-run successful! Uncheck "Dry Run" to apply.');
                    showNotification('Dry-run validation passed', 'success');
                } else {
                    updateYamlEditorStatus('valid', 'Applied successfully!');
                    showNotification('Resource applied successfully', 'success');
                    // Refresh data
                    refreshData();
                    // Close editor after short delay
                    setTimeout(closeYamlEditor, 1500);
                }
            } catch (e) {
                updateYamlEditorStatus('invalid', 'Error: ' + e.message);
            }
        }

        function updateYamlEditorStatus(state, message) {
            const status = document.getElementById('yaml-editor-status');
            status.className = 'yaml-editor-status ' + state;
            status.querySelector('.status-text').textContent = message;
        }

        function handleYamlEditorKeydown(e) {
            const isMeta = e.metaKey || e.ctrlKey;

            if (e.key === 'Escape') {
                e.preventDefault();
                closeYamlEditor();
                return;
            }

            if (isMeta && e.key === 'Enter') {
                e.preventDefault();
                applyYaml();
                return;
            }

            if (isMeta && e.shiftKey && e.key.toLowerCase() === 'f') {
                e.preventDefault();
                formatYaml();
                return;
            }
        }

        // Edit existing resource YAML
        function editResourceYaml(resource, item) {
            // Get full YAML from API
            const ns = item.namespace || currentNamespace;
            const name = item.name;

            fetchWithAuth(`/api/k8s/${resource}/${name}?namespace=${ns}&format=yaml`)
                .then(resp => resp.text())
                .then(yaml => {
                    openYamlEditor(yaml, { resource, name, namespace: ns });
                })
                .catch(e => {
                    showNotification('Failed to load YAML: ' + e.message, 'error');
                });
        }

        // Initialize
        loadRecentNamespaces();

        // ==================== Chat History (localStorage) ====================
        const CHAT_STORAGE_KEY = 'k13d-chat-history';
        const MAX_CHATS = 50;
        let chatHistory = [];
        let currentChatId = null;

        function generateChatId() {
            return 'chat-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        function loadChatHistory() {
            try {
                const saved = localStorage.getItem(CHAT_STORAGE_KEY);
                if (saved) {
                    chatHistory = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Failed to load chat history:', e);
                chatHistory = [];
            }
            renderChatHistoryList();

            // Load most recent chat or create new one
            if (chatHistory.length > 0) {
                loadChat(chatHistory[0].id);
            } else {
                createNewChat();
            }
        }

        function saveChatHistory() {
            try {
                // Limit to MAX_CHATS
                if (chatHistory.length > MAX_CHATS) {
                    chatHistory = chatHistory.slice(0, MAX_CHATS);
                }
                localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(chatHistory));
            } catch (e) {
                console.error('Failed to save chat history:', e);
            }
        }

        function createNewChat() {
            const chat = {
                id: generateChatId(),
                title: 'New Chat',
                messages: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            chatHistory.unshift(chat);
            saveChatHistory();
            loadChat(chat.id);
            renderChatHistoryList();
        }

        function loadChat(chatId) {
            const chat = chatHistory.find(c => c.id === chatId);
            if (!chat) return;

            currentChatId = chatId;

            // Clear and restore messages
            const container = document.getElementById('ai-messages');
            container.innerHTML = '';

            if (chat.messages.length === 0) {
                // Show welcome message for new chats
                container.innerHTML = `
                    <div class="message assistant">
                        <div class="message-content">
                            Welcome to k13d! I can help you manage your Kubernetes cluster.
                            <br><br>
                            Try asking:
                            <br>- "Show me all pods"
                            <br>- "Create an nginx pod"
                            <br>- "Scale deployment to 3 replicas"
                            <br><br>
                            <strong>Tip:</strong> Click any resource row to add it as context for AI analysis!
                        </div>
                    </div>
                `;
            } else {
                // Restore messages
                chat.messages.forEach(msg => {
                    addMessageToDOM(msg.content, msg.isUser, false);
                });
            }

            renderChatHistoryList();
        }

        function saveCurrentChatMessage(content, isUser) {
            const chat = chatHistory.find(c => c.id === currentChatId);
            if (!chat) return;

            chat.messages.push({
                content: content,
                isUser: isUser,
                timestamp: new Date().toISOString()
            });

            // Update title from first user message
            if (isUser && chat.title === 'New Chat') {
                chat.title = generateChatTitle(content);
            }

            chat.updatedAt = new Date().toISOString();

            // Move to top
            chatHistory = chatHistory.filter(c => c.id !== chat.id);
            chatHistory.unshift(chat);

            saveChatHistory();
            renderChatHistoryList();
        }

        function deleteChat(chatId, event) {
            event.stopPropagation();

            if (!confirm('Delete this chat?')) return;

            chatHistory = chatHistory.filter(c => c.id !== chatId);
            saveChatHistory();

            if (currentChatId === chatId) {
                if (chatHistory.length > 0) {
                    loadChat(chatHistory[0].id);
                } else {
                    createNewChat();
                }
            }

            renderChatHistoryList();
        }

        function renderChatHistoryList(filter = '') {
            const container = document.getElementById('chat-history-list');
            let filtered = chatHistory;

            if (filter) {
                const lowerFilter = filter.toLowerCase();
                filtered = chatHistory.filter(c =>
                    c.title.toLowerCase().includes(lowerFilter) ||
                    c.messages.some(m => m.content.toLowerCase().includes(lowerFilter))
                );
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="chat-history-empty">
                        <div class="chat-history-empty-icon">ðŸ’¬</div>
                        <div>${filter ? 'No matching chats' : 'No chat history yet'}</div>
                        <div style="margin-top: 8px; font-size: 11px;">Start a new conversation!</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(chat => {
                const date = new Date(chat.updatedAt);
                const dateStr = formatChatDate(date);
                const msgCount = chat.messages.length;
                const isActive = chat.id === currentChatId;

                return `
                    <div class="chat-history-item ${isActive ? 'active' : ''}" onclick="loadChat('${chat.id}')">
                        <div class="chat-history-title">${escapeHtml(chat.title)}</div>
                        <div class="chat-history-meta">
                            <span>${dateStr}</span>
                            <span>${msgCount} message${msgCount !== 1 ? 's' : ''}</span>
                        </div>
                        <button class="chat-history-edit" onclick="startRenameChat('${chat.id}', event)" title="Rename">âœï¸</button>
                        <button class="chat-history-delete" onclick="deleteChat('${chat.id}', event)" title="Delete">ðŸ—‘ï¸</button>
                    </div>
                `;
            }).join('');
        }

        function formatChatDate(date) {
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (days === 1) {
                return 'Yesterday';
            } else if (days < 7) {
                return date.toLocaleDateString([], { weekday: 'short' });
            } else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
        }

        function filterChatHistory(query) {
            renderChatHistoryList(query);
        }

        // Generate a meaningful chat title from the first message
        function generateChatTitle(content) {
            // Remove markdown, code blocks, and extra whitespace
            let title = content
                .replace(/```[\s\S]*?```/g, '')  // Remove code blocks
                .replace(/`[^`]+`/g, '')          // Remove inline code
                .replace(/\*\*([^*]+)\*\*/g, '$1') // Remove bold
                .replace(/\*([^*]+)\*/g, '$1')     // Remove italic
                .replace(/#+\s*/g, '')             // Remove headers
                .replace(/\n/g, ' ')               // Replace newlines
                .replace(/\s+/g, ' ')              // Collapse whitespace
                .trim();

            // If it starts with common question words, keep them
            const questionPatterns = [
                /^(show|list|get|create|delete|scale|restart|describe|explain|why|what|how|can|help|find|check|monitor|deploy|update|patch|edit|fix|debug)/i
            ];

            // Extract the main intent (first meaningful phrase)
            const words = title.split(' ');
            let titleWords = [];
            let charCount = 0;

            for (const word of words) {
                if (charCount + word.length > 35) break;
                titleWords.push(word);
                charCount += word.length + 1;
            }

            title = titleWords.join(' ');

            // Capitalize first letter
            if (title.length > 0) {
                title = title.charAt(0).toUpperCase() + title.slice(1);
            }

            // Add ellipsis if truncated
            if (words.length > titleWords.length) {
                title += '...';
            }

            return title || 'New Chat';
        }

        // Rename chat functionality
        function startRenameChat(chatId, event) {
            event.stopPropagation();
            const chat = chatHistory.find(c => c.id === chatId);
            if (!chat) return;

            const item = event.target.closest('.chat-history-item');
            const titleEl = item.querySelector('.chat-history-title');
            const currentTitle = chat.title;

            // Replace title with input
            titleEl.innerHTML = `<input type="text" class="chat-history-rename-input" value="${escapeHtml(currentTitle)}" />`;
            const input = titleEl.querySelector('input');
            input.focus();
            input.select();

            // Handle save on Enter or blur
            const saveRename = () => {
                const newTitle = input.value.trim() || 'New Chat';
                chat.title = newTitle;
                chat.updatedAt = new Date().toISOString();
                saveChatHistory();
                renderChatHistoryList();
            };

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveRename();
                } else if (e.key === 'Escape') {
                    renderChatHistoryList();
                }
            });

            input.addEventListener('blur', saveRename);
        }

        function toggleChatHistory() {
            const sidebar = document.getElementById('chat-history-sidebar');
            const panel = document.getElementById('ai-panel');

            sidebar.classList.toggle('open');
            panel.classList.toggle('history-open');
        }

        // Add message to DOM (without saving)
        function addMessageToDOM(content, isUser, scroll = true) {
            const container = document.getElementById('ai-messages');
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user' : 'assistant'}`;

            let formattedContent = content;
            if (!isUser) {
                formattedContent = formatResourceLinks(marked.parse(content));
            }

            div.innerHTML = `<div class="message-content">${formattedContent}</div>`;
            container.appendChild(div);

            if (scroll) {
                container.scrollTop = container.scrollHeight;
            }
        }

        // Initialize chat history on load
        loadChatHistory();

        // ==================== K8s Safety Guardrails ====================
        const GUARDRAILS_STORAGE_KEY = 'k13d-guardrails';
        let guardrailsConfig = {
            enabled: true,
            strictMode: false,  // Block all dangerous operations
            autoAnalyze: true,  // Auto-analyze AI responses for safety
            currentNamespace: 'default',
            recentAnalysis: null,
            analysisHistory: []
        };

        // Risk level styling
        const RISK_STYLES = {
            safe: { color: 'var(--accent-green)', icon: 'âœ“', label: 'Safe' },
            warning: { color: 'var(--accent-yellow)', icon: 'âš ', label: 'Warning' },
            dangerous: { color: 'var(--accent-red)', icon: 'âš¡', label: 'Dangerous' },
            critical: { color: '#ff4757', icon: 'â˜ ', label: 'Critical' }
        };

        function loadGuardrailsConfig() {
            try {
                const saved = localStorage.getItem(GUARDRAILS_STORAGE_KEY);
                if (saved) {
                    guardrailsConfig = { ...guardrailsConfig, ...JSON.parse(saved) };
                }
            } catch (e) {
                console.error('Failed to load guardrails config:', e);
            }
            updateGuardrailsUI();
        }

        function saveGuardrailsConfig() {
            try {
                localStorage.setItem(GUARDRAILS_STORAGE_KEY, JSON.stringify(guardrailsConfig));
            } catch (e) {
                console.error('Failed to save guardrails config:', e);
            }
        }

        // Analyze K8s command/action safety via backend API
        async function analyzeK8sSafety(command, namespace = null) {
            if (!guardrailsConfig.enabled) {
                return { safe: true, riskLevel: 'safe', allowed: true };
            }

            try {
                const response = await fetchWithAuth('/api/safety/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        command: command,
                        namespace: namespace || guardrailsConfig.currentNamespace || currentNamespace
                    })
                });

                if (!response.ok) {
                    console.error('Safety analysis failed:', response.status);
                    return { safe: true, riskLevel: 'safe', allowed: true }; // Fail open
                }

                const analysis = await response.json();

                // Store in history
                guardrailsConfig.recentAnalysis = analysis;
                guardrailsConfig.analysisHistory.unshift({
                    command: command,
                    analysis: analysis,
                    timestamp: Date.now()
                });
                if (guardrailsConfig.analysisHistory.length > 50) {
                    guardrailsConfig.analysisHistory.pop();
                }
                saveGuardrailsConfig();

                updateGuardrailsUI(analysis);

                return {
                    ...analysis,
                    allowed: !analysis.requires_approval || !guardrailsConfig.strictMode
                };
            } catch (e) {
                console.error('Safety analysis error:', e);
                return { safe: true, riskLevel: 'safe', allowed: true }; // Fail open
            }
        }

        // Quick client-side check for common dangerous patterns
        function checkGuardrails(message) {
            if (!guardrailsConfig.enabled) {
                return { allowed: true };
            }

            const lowerMessage = message.toLowerCase();

            // Critical patterns that should always be flagged
            const criticalPatterns = [
                { pattern: 'delete namespace', reason: 'Deleting a namespace removes ALL resources within it' },
                { pattern: 'delete ns ', reason: 'Deleting a namespace removes ALL resources within it' },
                { pattern: '--all-namespaces', reason: 'Operation affects ALL namespaces in the cluster' },
                { pattern: 'drain node', reason: 'Draining a node evicts all pods' },
                { pattern: 'delete node', reason: 'Deleting a node removes it from the cluster' },
                { pattern: '--force --grace-period=0', reason: 'Force deletion bypasses graceful termination' },
                { pattern: 'rm -rf', reason: 'Recursive file deletion is dangerous' },
            ];

            // Check critical patterns
            for (const { pattern, reason } of criticalPatterns) {
                if (lowerMessage.includes(pattern)) {
                    return {
                        allowed: !guardrailsConfig.strictMode,
                        requireConfirmation: true,
                        riskLevel: 'critical',
                        reason: reason,
                        dangerous: true
                    };
                }
            }

            // Dangerous patterns that need confirmation
            const dangerousPatterns = [
                { pattern: 'delete deployment', reason: 'Deleting deployments stops all pods' },
                { pattern: 'delete statefulset', reason: 'StatefulSet deletion can cause data issues' },
                { pattern: 'delete service', reason: 'Deleting services breaks connectivity' },
                { pattern: 'delete pvc', reason: 'PVC deletion can cause data loss' },
                { pattern: 'delete secret', reason: 'Deleting secrets can break applications' },
                { pattern: 'scale --replicas=0', reason: 'Scaling to zero stops all pods' },
            ];

            for (const { pattern, reason } of dangerousPatterns) {
                if (lowerMessage.includes(pattern)) {
                    return {
                        allowed: true,
                        requireConfirmation: true,
                        riskLevel: 'dangerous',
                        reason: reason
                    };
                }
            }

            // Warning patterns
            const warningPatterns = [
                { pattern: 'delete pod', reason: 'Pod deletion causes temporary unavailability' },
                { pattern: 'scale ', reason: 'Scaling changes running pod count' },
                { pattern: 'rollout restart', reason: 'Restart causes temporary unavailability' },
                { pattern: 'apply ', reason: 'Applying changes modifies cluster state' },
                { pattern: 'patch ', reason: 'Patching modifies resource configuration' },
            ];

            for (const { pattern, reason } of warningPatterns) {
                if (lowerMessage.includes(pattern)) {
                    return {
                        allowed: true,
                        requireConfirmation: true,
                        riskLevel: 'warning',
                        reason: reason
                    };
                }
            }

            // Check for production namespace indicators
            const productionIndicators = ['prod', 'production', 'live', 'main', 'master'];
            for (const indicator of productionIndicators) {
                if (lowerMessage.includes(indicator)) {
                    return {
                        allowed: true,
                        requireConfirmation: true,
                        riskLevel: 'warning',
                        reason: 'Possible production environment detected'
                    };
                }
            }

            return { allowed: true, riskLevel: 'safe' };
        }

        // Show safety confirmation dialog
        function showSafetyConfirmation(analysis, onConfirm, onCancel) {
            const style = RISK_STYLES[analysis.riskLevel] || RISK_STYLES.warning;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'safety-confirmation-modal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header" style="background: ${style.color}20; border-bottom: 2px solid ${style.color};">
                        <h2 style="color: ${style.color};">${style.icon} ${style.label}: Safety Check Required</h2>
                        <button class="modal-close" onclick="closeSafetyConfirmation(false)">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <div style="margin-bottom: 16px;">
                            <strong style="color: ${style.color};">Risk Level:</strong> ${analysis.riskLevel.toUpperCase()}
                        </div>

                        ${analysis.explanation ? `
                        <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                            ${analysis.explanation}
                        </div>
                        ` : ''}

                        ${analysis.warnings && analysis.warnings.length > 0 ? `
                        <div style="margin-bottom: 16px;">
                            <strong>Warnings:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; color: var(--accent-yellow);">
                                ${analysis.warnings.map(w => `<li>${w}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}

                        ${analysis.recommendations && analysis.recommendations.length > 0 ? `
                        <div style="margin-bottom: 16px;">
                            <strong>Recommendations:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; color: var(--text-secondary);">
                                ${analysis.recommendations.map(r => `<li>${r}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}

                        <div style="margin-top: 20px; padding: 12px; background: ${style.color}10; border: 1px solid ${style.color}40; border-radius: 8px;">
                            <strong>Do you want to proceed with this action?</strong>
                        </div>
                    </div>
                    <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeSafetyConfirmation(false)">Cancel</button>
                        <button class="btn" style="background: ${style.color};" onclick="closeSafetyConfirmation(true)">
                            Proceed Anyway
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Store callbacks
            window._safetyConfirmCallbacks = { onConfirm, onCancel };
        }

        function closeSafetyConfirmation(confirmed) {
            const modal = document.getElementById('safety-confirmation-modal');
            if (modal) {
                modal.remove();
            }

            const callbacks = window._safetyConfirmCallbacks;
            if (callbacks) {
                if (confirmed && callbacks.onConfirm) {
                    callbacks.onConfirm();
                } else if (!confirmed && callbacks.onCancel) {
                    callbacks.onCancel();
                }
                delete window._safetyConfirmCallbacks;
            }
        }

        function updateGuardrailsUI(analysis = null) {
            const indicator = document.getElementById('guardrails-indicator');
            const limitDisplay = document.getElementById('guardrails-limit');

            if (!guardrailsConfig.enabled) {
                indicator.className = 'guardrails-indicator warning';
                indicator.innerHTML = '<span class="dot"></span><span>Protection Off</span>';
                limitDisplay.textContent = 'K8s Safety: Disabled';
            } else if (analysis) {
                const style = RISK_STYLES[analysis.risk_level] || RISK_STYLES.safe;
                indicator.className = `guardrails-indicator ${analysis.risk_level || 'safe'}`;
                indicator.innerHTML = `<span class="dot" style="background: ${style.color};"></span><span>${style.label}</span>`;
                limitDisplay.textContent = `Last: ${analysis.category || 'read-only'} | ${analysis.affected_scope || 'pod'}`;
            } else {
                indicator.className = 'guardrails-indicator safe';
                indicator.innerHTML = '<span class="dot"></span><span>Protected</span>';
                limitDisplay.textContent = 'K8s Safety: Active';
            }
        }

        // Initialize guardrails
        loadGuardrailsConfig();

        // ==================== Ollama Auto-Detection ====================
        let selectedOllamaModel = null;
        let ollamaModels = [];

        async function checkOllamaStatus() {
            const statusDot = document.getElementById('ollama-status-dot');
            const statusText = document.getElementById('ollama-status-text');
            const notInstalled = document.getElementById('ollama-not-installed');
            const installed = document.getElementById('ollama-installed');

            statusDot.style.background = '#888';
            statusText.textContent = 'Checking Ollama status...';

            try {
                // Check if Ollama is running by trying to connect to default endpoint
                const response = await fetch('http://localhost:11434/api/tags', {
                    method: 'GET',
                    signal: AbortSignal.timeout(3000)
                });

                if (response.ok) {
                    const data = await response.json();
                    ollamaModels = data.models || [];

                    statusDot.style.background = 'var(--accent-green)';
                    statusText.textContent = `Ollama running - ${ollamaModels.length} model(s) available`;
                    notInstalled.style.display = 'none';
                    installed.style.display = 'block';

                    renderOllamaModels();
                } else {
                    throw new Error('Ollama not responding');
                }
            } catch (e) {
                // Check if it's a CORS error (Ollama might be running but browser blocks)
                if (e.name === 'TypeError' && e.message.includes('Failed to fetch')) {
                    // Try through our backend proxy
                    try {
                        const proxyResponse = await fetchWithAuth('/api/llm/ollama/status');
                        if (proxyResponse.ok) {
                            const data = await proxyResponse.json();
                            if (data.running) {
                                ollamaModels = data.models || [];
                                statusDot.style.background = 'var(--accent-green)';
                                statusText.textContent = `Ollama running - ${ollamaModels.length} model(s) available`;
                                notInstalled.style.display = 'none';
                                installed.style.display = 'block';
                                renderOllamaModels();
                                return;
                            }
                        }
                    } catch (proxyErr) {
                        console.log('Backend proxy check failed:', proxyErr);
                    }
                }

                statusDot.style.background = 'var(--accent-yellow)';
                statusText.textContent = 'Ollama not detected';
                notInstalled.style.display = 'block';
                installed.style.display = 'none';
            }
        }

        function renderOllamaModels() {
            const container = document.getElementById('ollama-models-list');
            const useBtn = document.getElementById('use-ollama-btn');

            if (ollamaModels.length === 0) {
                container.innerHTML = '<span style="color:var(--text-secondary);font-size:12px;">No models installed. Pull a model to get started.</span>';
                useBtn.disabled = true;
                return;
            }

            container.innerHTML = ollamaModels.map(m => {
                const name = m.name || m;
                const size = m.size ? `(${formatBytes(m.size)})` : '';
                const isSelected = selectedOllamaModel === name;
                return `<button class="btn ${isSelected ? 'btn-primary' : 'btn-secondary'}"
                    onclick="selectOllamaModel('${name}')"
                    style="font-size:11px;padding:4px 10px;">
                    ${name} ${size}
                </button>`;
            }).join('');

            useBtn.disabled = !selectedOllamaModel;
        }

        function selectOllamaModel(modelName) {
            selectedOllamaModel = modelName;
            renderOllamaModels();
        }

        function useOllamaModel() {
            if (!selectedOllamaModel) return;

            // Set LLM settings to use Ollama
            document.getElementById('setting-llm-provider').value = 'ollama';
            document.getElementById('setting-llm-model').value = selectedOllamaModel;
            document.getElementById('setting-llm-endpoint').value = 'http://localhost:11434';
            document.getElementById('setting-llm-apikey').value = '';

            updateEndpointPlaceholder();
            showNotification(`Configured to use Ollama model: ${selectedOllamaModel}`, 'success');
        }

        function showOllamaInstallInstructions(os) {
            const container = document.getElementById('ollama-install-instructions');
            container.style.display = 'block';

            let instructions = '';
            switch (os) {
                case 'macos':
                    instructions = `
                        <div style="margin-bottom:8px;color:var(--accent-blue);">macOS Installation:</div>
                        <div style="margin-bottom:8px;">Option 1 - Homebrew:</div>
                        <code style="display:block;background:#000;padding:8px;border-radius:4px;margin-bottom:8px;">brew install ollama</code>
                        <div style="margin-bottom:8px;">Option 2 - Direct Download:</div>
                        <a href="https://ollama.ai/download" target="_blank" style="color:var(--accent-cyan);">Download from ollama.ai â†’</a>
                        <div style="margin-top:12px;color:var(--text-secondary);">After installation, start Ollama:</div>
                        <code style="display:block;background:#000;padding:8px;border-radius:4px;margin-top:4px;">ollama serve</code>
                    `;
                    break;
                case 'linux':
                    instructions = `
                        <div style="margin-bottom:8px;color:var(--accent-blue);">Linux Installation:</div>
                        <div style="margin-bottom:4px;">Run this command in terminal:</div>
                        <code style="display:block;background:#000;padding:8px;border-radius:4px;margin-bottom:8px;word-break:break-all;">curl -fsSL https://ollama.ai/install.sh | sh</code>
                        <div style="margin-top:12px;color:var(--text-secondary);">After installation, start Ollama:</div>
                        <code style="display:block;background:#000;padding:8px;border-radius:4px;margin-top:4px;">ollama serve</code>
                    `;
                    break;
                case 'windows':
                    instructions = `
                        <div style="margin-bottom:8px;color:var(--accent-blue);">Windows Installation:</div>
                        <div style="margin-bottom:8px;">Download the installer from:</div>
                        <a href="https://ollama.ai/download" target="_blank" style="color:var(--accent-cyan);">Download from ollama.ai â†’</a>
                        <div style="margin-top:12px;color:var(--text-secondary);">After installation, Ollama will start automatically.</div>
                    `;
                    break;
            }

            container.innerHTML = instructions;
        }

        function showOllamaPullDialog() {
            const dialog = document.getElementById('ollama-pull-dialog');
            dialog.style.display = dialog.style.display === 'none' ? 'block' : 'none';
        }

        async function pullOllamaModel(modelName) {
            if (!modelName) {
                modelName = document.getElementById('ollama-custom-model').value.trim();
            }
            if (!modelName) {
                showNotification('Please enter a model name', 'error');
                return;
            }

            const statusDiv = document.getElementById('ollama-pull-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `<span style="color:var(--accent-yellow);">â³ Pulling ${modelName}... This may take several minutes.</span>`;

            try {
                // Use our backend proxy for pulling
                const response = await fetchWithAuth('/api/llm/ollama/pull', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: modelName })
                });

                const result = await response.json();

                if (result.error) {
                    statusDiv.innerHTML = `<span style="color:var(--accent-red);">âŒ Error: ${result.error}</span>`;
                } else {
                    statusDiv.innerHTML = `<span style="color:var(--accent-green);">âœ… Model ${modelName} pulled successfully!</span>`;
                    // Refresh model list
                    setTimeout(checkOllamaStatus, 1000);
                }
            } catch (e) {
                // If backend doesn't support, show manual instructions
                statusDiv.innerHTML = `
                    <span style="color:var(--accent-yellow);">Run this command in your terminal:</span>
                    <code style="display:block;background:#000;padding:8px;border-radius:4px;margin-top:4px;">ollama pull ${modelName}</code>
                    <button class="btn btn-secondary" onclick="checkOllamaStatus()" style="margin-top:8px;font-size:11px;">Refresh Status</button>
                `;
            }
        }

        function formatBytes(bytes) {
            if (!bytes) return '';
            const gb = bytes / (1024 * 1024 * 1024);
            if (gb >= 1) return gb.toFixed(1) + 'GB';
            const mb = bytes / (1024 * 1024);
            return mb.toFixed(0) + 'MB';
        }

        // K8s Safety Guardrails settings UI
        function toggleGuardrailsSetting() {
            const toggle = document.getElementById('guardrails-toggle');
            guardrailsConfig.enabled = !guardrailsConfig.enabled;
            toggle.classList.toggle('active', guardrailsConfig.enabled);
            saveGuardrailsConfig();
            updateGuardrailsUI();
        }

        function toggleStrictMode() {
            const toggle = document.getElementById('guardrails-strict-toggle');
            guardrailsConfig.strictMode = !guardrailsConfig.strictMode;
            toggle.classList.toggle('active', guardrailsConfig.strictMode);
            saveGuardrailsConfig();
            showNotification(guardrailsConfig.strictMode ?
                'Strict mode enabled - dangerous operations will be blocked' :
                'Strict mode disabled - dangerous operations will require confirmation',
                guardrailsConfig.strictMode ? 'warning' : 'info');
        }

        function toggleAutoAnalyze() {
            const toggle = document.getElementById('guardrails-auto-analyze');
            guardrailsConfig.autoAnalyze = !guardrailsConfig.autoAnalyze;
            toggle.classList.toggle('active', guardrailsConfig.autoAnalyze);
            saveGuardrailsConfig();
        }

        function clearGuardrailsHistory() {
            guardrailsConfig.analysisHistory = [];
            guardrailsConfig.recentAnalysis = null;
            saveGuardrailsConfig();
            updateGuardrailsHistoryUI();
            updateGuardrailsUI();
            showNotification('Safety check history cleared', 'success');
        }

        function updateGuardrailsHistoryUI() {
            const historyDiv = document.getElementById('guardrails-history');
            if (!historyDiv) return;

            if (!guardrailsConfig.analysisHistory || guardrailsConfig.analysisHistory.length === 0) {
                historyDiv.innerHTML = '<div style="color:var(--text-secondary); font-size:13px;">No recent checks</div>';
                return;
            }

            const html = guardrailsConfig.analysisHistory.slice(0, 10).map(item => {
                const style = RISK_STYLES[item.analysis.risk_level] || RISK_STYLES.safe;
                const time = new Date(item.timestamp).toLocaleTimeString();
                const cmd = item.command.length > 50 ? item.command.substring(0, 47) + '...' : item.command;
                return `
                    <div style="display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid var(--border-color);">
                        <span style="color:${style.color}; font-size:14px;">${style.icon}</span>
                        <span style="flex:1; font-size:12px; font-family:monospace; color:var(--text-secondary);" title="${item.command}">${cmd}</span>
                        <span style="font-size:11px; color:var(--text-secondary);">${time}</span>
                    </div>
                `;
            }).join('');

            historyDiv.innerHTML = html;
        }

        function loadGuardrailsSettingsUI() {
            document.getElementById('guardrails-toggle').classList.toggle('active', guardrailsConfig.enabled);
            document.getElementById('guardrails-strict-toggle').classList.toggle('active', guardrailsConfig.strictMode || false);
            document.getElementById('guardrails-auto-analyze').classList.toggle('active', guardrailsConfig.autoAnalyze !== false);
            updateGuardrailsHistoryUI();
        }

        // Check Ollama on settings open
        const originalShowSettings = typeof showSettings === 'function' ? showSettings : null;

        // Initialize Ollama check when LLM tab is opened
        function onLLMTabOpened() {
            checkOllamaStatus();
            loadGuardrailsSettingsUI();
        }

        // Shortcuts modal
        function showShortcuts() {
            document.getElementById('shortcuts-modal').classList.add('active');
        }

        function closeShortcuts() {
            document.getElementById('shortcuts-modal').classList.remove('active');
        }

        // Resource detail modal
        let selectedResource = null;

        // Generate resource-specific overview HTML
        function generateResourceOverview(resource, item) {
            switch (resource) {
                case 'pods':
                    return generatePodOverview(item);
                case 'deployments':
                    return generateDeploymentOverview(item);
                case 'services':
                    return generateServiceOverview(item);
                case 'statefulsets':
                    return generateStatefulSetOverview(item);
                case 'daemonsets':
                    return generateDaemonSetOverview(item);
                case 'nodes':
                    return generateNodeOverview(item);
                case 'configmaps':
                    return generateConfigMapOverview(item);
                case 'secrets':
                    return generateSecretOverview(item);
                case 'ingresses':
                    return generateIngressOverview(item);
                case 'jobs':
                    return generateJobOverview(item);
                case 'cronjobs':
                    return generateCronJobOverview(item);
                case 'pvcs':
                    return generatePVCOverview(item);
                case 'pvs':
                    return generatePVOverview(item);
                default:
                    return generateDefaultOverview(item);
            }
        }

        // Default overview (key-value pairs)
        function generateDefaultOverview(item) {
            const html = Object.entries(item).map(([key, value]) =>
                `<div class="property-label">${key}</div><div class="property-value">${escapeHtml(String(value || '-'))}</div>`
            ).join('');
            return `<div class="property-grid">${html}</div>`;
        }

        // Pod Overview
        function generatePodOverview(item) {
            const statusColor = item.status === 'Running' ? 'var(--accent-green)' :
                               item.status === 'Pending' ? 'var(--accent-yellow)' :
                               item.status === 'Failed' || item.status === 'Error' ? 'var(--accent-red)' : 'var(--text-secondary)';
            const restarts = parseInt(item.restarts) || 0;
            const restartColor = restarts > 5 ? 'var(--accent-red)' : restarts > 0 ? 'var(--accent-yellow)' : 'var(--accent-green)';

            return `
                <div class="resource-overview-header">
                    <div class="overview-status-badge" style="background: ${statusColor}20; color: ${statusColor}; border: 1px solid ${statusColor}40;">
                        <span class="status-dot" style="background: ${statusColor};"></span>
                        ${escapeHtml(item.status)}
                    </div>
                </div>
                <div class="overview-cards">
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“¦ Container Status</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Ready</span>
                                <span class="stat-value" style="color: var(--accent-green);">${escapeHtml(item.ready || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Restarts</span>
                                <span class="stat-value" style="color: ${restartColor};">${restarts}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ–¥ï¸ Node & Network</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Node</span>
                                <span class="stat-value">${escapeHtml(item.node || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Pod IP</span>
                                <span class="stat-value" style="font-family: monospace;">${escapeHtml(item.ip || '-')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“‹ Metadata</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Namespace</span>
                                <span class="stat-value">${escapeHtml(item.namespace || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Age</span>
                                <span class="stat-value">${escapeHtml(item.age || '-')}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="overview-actions">
                    <button class="btn btn-secondary" onclick="openLogViewerDirect('${escapeHtml(item.name)}', '${escapeHtml(item.namespace || '')}')">ðŸ“‹ View Logs</button>
                </div>
            `;
        }

        // Deployment Overview
        function generateDeploymentOverview(item) {
            const ready = item.ready || '0/0';
            const [readyCount, totalCount] = ready.split('/').map(n => parseInt(n) || 0);
            const healthPercent = totalCount > 0 ? Math.round((readyCount / totalCount) * 100) : 0;
            const healthColor = healthPercent === 100 ? 'var(--accent-green)' : healthPercent >= 50 ? 'var(--accent-yellow)' : 'var(--accent-red)';

            return `
                <div class="resource-overview-header">
                    <div class="overview-status-badge" style="background: ${healthColor}20; color: ${healthColor}; border: 1px solid ${healthColor}40;">
                        <span class="status-dot" style="background: ${healthColor};"></span>
                        ${healthPercent === 100 ? 'Healthy' : healthPercent > 0 ? 'Degraded' : 'Unavailable'}
                    </div>
                </div>
                <div class="overview-cards">
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“Š Replicas</div>
                        <div class="overview-card-content">
                            <div class="overview-progress">
                                <div class="progress-bar" style="width: ${healthPercent}%; background: ${healthColor};"></div>
                            </div>
                            <div class="overview-stat" style="margin-top: 8px;">
                                <span class="stat-label">Ready</span>
                                <span class="stat-value" style="color: ${healthColor};">${ready}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Up-to-date</span>
                                <span class="stat-value">${escapeHtml(item.upToDate || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Available</span>
                                <span class="stat-value">${escapeHtml(item.available || '-')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ³ Container Image</div>
                        <div class="overview-card-content">
                            <div class="image-tag" title="${escapeHtml(item.image || '-')}">${escapeHtml(item.image || '-')}</div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“‹ Metadata</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Namespace</span>
                                <span class="stat-value">${escapeHtml(item.namespace || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Age</span>
                                <span class="stat-value">${escapeHtml(item.age || '-')}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Service Overview
        function generateServiceOverview(item) {
            const typeColors = {
                'ClusterIP': 'var(--accent-blue)',
                'NodePort': 'var(--accent-purple)',
                'LoadBalancer': 'var(--accent-green)',
                'ExternalName': 'var(--accent-yellow)'
            };
            const typeColor = typeColors[item.type] || 'var(--text-secondary)';

            return `
                <div class="resource-overview-header">
                    <div class="overview-status-badge" style="background: ${typeColor}20; color: ${typeColor}; border: 1px solid ${typeColor}40;">
                        ${escapeHtml(item.type || 'Unknown')}
                    </div>
                </div>
                <div class="overview-cards">
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸŒ Network</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Cluster IP</span>
                                <span class="stat-value" style="font-family: monospace;">${escapeHtml(item.clusterIP || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">External IP</span>
                                <span class="stat-value" style="font-family: monospace;">${escapeHtml(item.externalIP || '-')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ”Œ Ports</div>
                        <div class="overview-card-content">
                            <div class="ports-list">${escapeHtml(item.ports || '-')}</div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“‹ Metadata</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Namespace</span>
                                <span class="stat-value">${escapeHtml(item.namespace || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Age</span>
                                <span class="stat-value">${escapeHtml(item.age || '-')}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // StatefulSet Overview
        function generateStatefulSetOverview(item) {
            const ready = item.ready || '0/0';
            const [readyCount, totalCount] = ready.split('/').map(n => parseInt(n) || 0);
            const healthPercent = totalCount > 0 ? Math.round((readyCount / totalCount) * 100) : 0;
            const healthColor = healthPercent === 100 ? 'var(--accent-green)' : healthPercent >= 50 ? 'var(--accent-yellow)' : 'var(--accent-red)';

            return `
                <div class="resource-overview-header">
                    <div class="overview-status-badge" style="background: ${healthColor}20; color: ${healthColor}; border: 1px solid ${healthColor}40;">
                        <span class="status-dot" style="background: ${healthColor};"></span>
                        ${healthPercent === 100 ? 'Healthy' : healthPercent > 0 ? 'Degraded' : 'Unavailable'}
                    </div>
                </div>
                <div class="overview-cards">
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“Š Replicas</div>
                        <div class="overview-card-content">
                            <div class="overview-progress">
                                <div class="progress-bar" style="width: ${healthPercent}%; background: ${healthColor};"></div>
                            </div>
                            <div class="overview-stat" style="margin-top: 8px;">
                                <span class="stat-label">Ready</span>
                                <span class="stat-value" style="color: ${healthColor};">${ready}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ³ Container Image</div>
                        <div class="overview-card-content">
                            <div class="image-tag" title="${escapeHtml(item.image || '-')}">${escapeHtml(item.image || '-')}</div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“‹ Metadata</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Namespace</span>
                                <span class="stat-value">${escapeHtml(item.namespace || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Age</span>
                                <span class="stat-value">${escapeHtml(item.age || '-')}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // DaemonSet Overview
        function generateDaemonSetOverview(item) {
            const ready = parseInt(item.ready) || 0;
            const desired = parseInt(item.desired) || 0;
            const healthPercent = desired > 0 ? Math.round((ready / desired) * 100) : 0;
            const healthColor = healthPercent === 100 ? 'var(--accent-green)' : healthPercent >= 50 ? 'var(--accent-yellow)' : 'var(--accent-red)';

            return `
                <div class="resource-overview-header">
                    <div class="overview-status-badge" style="background: ${healthColor}20; color: ${healthColor}; border: 1px solid ${healthColor}40;">
                        <span class="status-dot" style="background: ${healthColor};"></span>
                        ${healthPercent === 100 ? 'Healthy' : healthPercent > 0 ? 'Degraded' : 'Unavailable'}
                    </div>
                </div>
                <div class="overview-cards">
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“Š Node Coverage</div>
                        <div class="overview-card-content">
                            <div class="overview-progress">
                                <div class="progress-bar" style="width: ${healthPercent}%; background: ${healthColor};"></div>
                            </div>
                            <div class="overview-stat" style="margin-top: 8px;">
                                <span class="stat-label">Desired</span>
                                <span class="stat-value">${desired}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Current</span>
                                <span class="stat-value">${escapeHtml(item.current || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Ready</span>
                                <span class="stat-value" style="color: ${healthColor};">${ready}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Available</span>
                                <span class="stat-value">${escapeHtml(item.available || '-')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ³ Container Image</div>
                        <div class="overview-card-content">
                            <div class="image-tag" title="${escapeHtml(item.image || '-')}">${escapeHtml(item.image || '-')}</div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“‹ Metadata</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Namespace</span>
                                <span class="stat-value">${escapeHtml(item.namespace || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Age</span>
                                <span class="stat-value">${escapeHtml(item.age || '-')}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Node Overview
        function generateNodeOverview(item) {
            const statusColor = item.status === 'Ready' ? 'var(--accent-green)' : 'var(--accent-red)';
            const roles = item.roles || '-';

            return `
                <div class="resource-overview-header">
                    <div class="overview-status-badge" style="background: ${statusColor}20; color: ${statusColor}; border: 1px solid ${statusColor}40;">
                        <span class="status-dot" style="background: ${statusColor};"></span>
                        ${escapeHtml(item.status)}
                    </div>
                    <div class="overview-roles">
                        ${roles.split(',').map(r => `<span class="role-badge">${escapeHtml(r.trim())}</span>`).join('')}
                    </div>
                </div>
                <div class="overview-cards">
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ’» System Info</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Version</span>
                                <span class="stat-value">${escapeHtml(item.version || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">OS</span>
                                <span class="stat-value">${escapeHtml(item.os || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Arch</span>
                                <span class="stat-value">${escapeHtml(item.arch || '-')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“¦ Capacity</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">CPU</span>
                                <span class="stat-value">${escapeHtml(item.cpu || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Memory</span>
                                <span class="stat-value">${escapeHtml(item.memory || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Pods</span>
                                <span class="stat-value">${escapeHtml(item.pods || '-')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸŒ Network</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Internal IP</span>
                                <span class="stat-value" style="font-family: monospace;">${escapeHtml(item.internalIP || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Age</span>
                                <span class="stat-value">${escapeHtml(item.age || '-')}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ConfigMap Overview
        function generateConfigMapOverview(item) {
            return `
                <div class="overview-cards">
                    <div class="overview-card" style="grid-column: span 2;">
                        <div class="overview-card-title">ðŸ“ Data</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Keys</span>
                                <span class="stat-value">${escapeHtml(item.data || '0')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“‹ Metadata</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Namespace</span>
                                <span class="stat-value">${escapeHtml(item.namespace || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Age</span>
                                <span class="stat-value">${escapeHtml(item.age || '-')}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Secret Overview
        function generateSecretOverview(item) {
            const typeColors = {
                'Opaque': 'var(--accent-blue)',
                'kubernetes.io/service-account-token': 'var(--accent-purple)',
                'kubernetes.io/dockerconfigjson': 'var(--accent-green)',
                'kubernetes.io/tls': 'var(--accent-yellow)'
            };
            const typeColor = typeColors[item.type] || 'var(--text-secondary)';

            return `
                <div class="resource-overview-header">
                    <div class="overview-status-badge" style="background: ${typeColor}20; color: ${typeColor}; border: 1px solid ${typeColor}40;">
                        ðŸ”’ ${escapeHtml(item.type || 'Unknown')}
                    </div>
                </div>
                <div class="overview-cards">
                    <div class="overview-card" style="grid-column: span 2;">
                        <div class="overview-card-title">ðŸ” Data</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Keys</span>
                                <span class="stat-value">${escapeHtml(item.data || '0')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“‹ Metadata</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Namespace</span>
                                <span class="stat-value">${escapeHtml(item.namespace || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Age</span>
                                <span class="stat-value">${escapeHtml(item.age || '-')}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Ingress Overview
        function generateIngressOverview(item) {
            return `
                <div class="overview-cards">
                    <div class="overview-card" style="grid-column: span 2;">
                        <div class="overview-card-title">ðŸŒ Routing</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Class</span>
                                <span class="stat-value">${escapeHtml(item.class || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Hosts</span>
                                <span class="stat-value" style="font-family: monospace;">${escapeHtml(item.hosts || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Address</span>
                                <span class="stat-value" style="font-family: monospace;">${escapeHtml(item.address || '-')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“‹ Metadata</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Namespace</span>
                                <span class="stat-value">${escapeHtml(item.namespace || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Age</span>
                                <span class="stat-value">${escapeHtml(item.age || '-')}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Job Overview
        function generateJobOverview(item) {
            const statusColor = item.status === 'Complete' ? 'var(--accent-green)' :
                               item.status === 'Running' ? 'var(--accent-blue)' :
                               item.status === 'Failed' ? 'var(--accent-red)' : 'var(--text-secondary)';

            return `
                <div class="resource-overview-header">
                    <div class="overview-status-badge" style="background: ${statusColor}20; color: ${statusColor}; border: 1px solid ${statusColor}40;">
                        <span class="status-dot" style="background: ${statusColor};"></span>
                        ${escapeHtml(item.status || 'Unknown')}
                    </div>
                </div>
                <div class="overview-cards">
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“Š Completion</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Completions</span>
                                <span class="stat-value">${escapeHtml(item.completions || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Duration</span>
                                <span class="stat-value">${escapeHtml(item.duration || '-')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ³ Container Image</div>
                        <div class="overview-card-content">
                            <div class="image-tag" title="${escapeHtml(item.image || '-')}">${escapeHtml(item.image || '-')}</div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“‹ Metadata</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Namespace</span>
                                <span class="stat-value">${escapeHtml(item.namespace || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Age</span>
                                <span class="stat-value">${escapeHtml(item.age || '-')}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // CronJob Overview
        function generateCronJobOverview(item) {
            const suspendColor = item.suspend === 'True' ? 'var(--accent-yellow)' : 'var(--accent-green)';

            return `
                <div class="resource-overview-header">
                    <div class="overview-status-badge" style="background: ${suspendColor}20; color: ${suspendColor}; border: 1px solid ${suspendColor}40;">
                        ${item.suspend === 'True' ? 'â¸ï¸ Suspended' : 'â–¶ï¸ Active'}
                    </div>
                </div>
                <div class="overview-cards">
                    <div class="overview-card">
                        <div class="overview-card-title">â° Schedule</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Schedule</span>
                                <span class="stat-value" style="font-family: monospace;">${escapeHtml(item.schedule || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Last Schedule</span>
                                <span class="stat-value">${escapeHtml(item.lastSchedule || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Active Jobs</span>
                                <span class="stat-value">${escapeHtml(item.active || '0')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ³ Container Image</div>
                        <div class="overview-card-content">
                            <div class="image-tag" title="${escapeHtml(item.image || '-')}">${escapeHtml(item.image || '-')}</div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“‹ Metadata</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Namespace</span>
                                <span class="stat-value">${escapeHtml(item.namespace || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Age</span>
                                <span class="stat-value">${escapeHtml(item.age || '-')}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // PVC Overview
        function generatePVCOverview(item) {
            const statusColor = item.status === 'Bound' ? 'var(--accent-green)' :
                               item.status === 'Pending' ? 'var(--accent-yellow)' : 'var(--accent-red)';

            return `
                <div class="resource-overview-header">
                    <div class="overview-status-badge" style="background: ${statusColor}20; color: ${statusColor}; border: 1px solid ${statusColor}40;">
                        <span class="status-dot" style="background: ${statusColor};"></span>
                        ${escapeHtml(item.status)}
                    </div>
                </div>
                <div class="overview-cards">
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ’¾ Storage</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Capacity</span>
                                <span class="stat-value">${escapeHtml(item.capacity || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Access Modes</span>
                                <span class="stat-value">${escapeHtml(item.accessModes || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Storage Class</span>
                                <span class="stat-value">${escapeHtml(item.storageClass || '-')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ”— Volume</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Volume</span>
                                <span class="stat-value" style="font-family: monospace; font-size: 11px;">${escapeHtml(item.volume || '-')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“‹ Metadata</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Namespace</span>
                                <span class="stat-value">${escapeHtml(item.namespace || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Age</span>
                                <span class="stat-value">${escapeHtml(item.age || '-')}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // PV Overview
        function generatePVOverview(item) {
            const statusColor = item.status === 'Available' ? 'var(--accent-green)' :
                               item.status === 'Bound' ? 'var(--accent-blue)' :
                               item.status === 'Released' ? 'var(--accent-yellow)' : 'var(--accent-red)';

            return `
                <div class="resource-overview-header">
                    <div class="overview-status-badge" style="background: ${statusColor}20; color: ${statusColor}; border: 1px solid ${statusColor}40;">
                        <span class="status-dot" style="background: ${statusColor};"></span>
                        ${escapeHtml(item.status)}
                    </div>
                </div>
                <div class="overview-cards">
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ’¾ Storage</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Capacity</span>
                                <span class="stat-value">${escapeHtml(item.capacity || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Access Modes</span>
                                <span class="stat-value">${escapeHtml(item.accessModes || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Reclaim Policy</span>
                                <span class="stat-value">${escapeHtml(item.reclaimPolicy || '-')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ”— Claim</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Claim</span>
                                <span class="stat-value" style="font-family: monospace; font-size: 11px;">${escapeHtml(item.claim || '-')}</span>
                            </div>
                            <div class="overview-stat">
                                <span class="stat-label">Storage Class</span>
                                <span class="stat-value">${escapeHtml(item.storageClass || '-')}</span>
                            </div>
                        </div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-title">ðŸ“‹ Metadata</div>
                        <div class="overview-card-content">
                            <div class="overview-stat">
                                <span class="stat-label">Age</span>
                                <span class="stat-value">${escapeHtml(item.age || '-')}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showResourceDetail(item) {
            selectedResource = item;
            document.getElementById('detail-title').textContent = `${currentResource.slice(0, -1)}: ${item.name}`;

            // Overview tab - use resource-specific generator
            const overviewHtml = generateResourceOverview(currentResource, item);
            document.getElementById('detail-overview').innerHTML = overviewHtml;

            // YAML tab - will be loaded on demand
            document.getElementById('detail-yaml').innerHTML = `<div class="yaml-viewer" style="color: var(--text-secondary);">Click the YAML tab to load...</div>`;
            document.getElementById('detail-yaml').dataset.loaded = 'false';

            // Events tab - will be loaded on demand
            document.getElementById('detail-events').innerHTML = '<p style="color: var(--text-secondary);">Click the Events tab to load...</p>';
            document.getElementById('detail-events').dataset.loaded = 'false';

            // Related Pods tab - only for Services, Deployments, StatefulSets, DaemonSets, ReplicaSets
            const podsTab = document.getElementById('detail-pods-tab');
            const podsContent = document.getElementById('detail-pods');
            const workloadResources = ['services', 'deployments', 'statefulsets', 'daemonsets', 'replicasets'];
            if (workloadResources.includes(currentResource)) {
                podsTab.style.display = 'inline-block';
                podsContent.innerHTML = '<p style="color: var(--text-secondary);">Click the Related Pods tab to load...</p>';
                podsContent.dataset.loaded = 'false';
            } else {
                podsTab.style.display = 'none';
            }

            document.getElementById('detail-modal').classList.add('active');
            switchDetailTab('overview');
        }

        async function switchDetailTab(tab) {
            document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.detail-tab[onclick*="${tab}"]`).classList.add('active');

            document.getElementById('detail-overview').style.display = tab === 'overview' ? 'block' : 'none';
            document.getElementById('detail-yaml').style.display = tab === 'yaml' ? 'block' : 'none';
            document.getElementById('detail-events').style.display = tab === 'events' ? 'block' : 'none';
            document.getElementById('detail-pods').style.display = tab === 'pods' ? 'block' : 'none';

            // Load YAML on demand
            if (tab === 'yaml' && selectedResource) {
                const yamlEl = document.getElementById('detail-yaml');
                if (yamlEl.dataset.loaded !== 'true') {
                    yamlEl.innerHTML = `<div class="yaml-viewer" style="color: var(--text-secondary);">Loading YAML...</div>`;
                    try {
                        const ns = selectedResource.namespace || '';
                        const url = `/api/k8s/${currentResource}?name=${encodeURIComponent(selectedResource.name)}&namespace=${encodeURIComponent(ns)}&format=yaml`;
                        const response = await fetch(url, { credentials: 'include' });
                        if (!response.ok) {
                            throw new Error(await response.text());
                        }
                        const yaml = await response.text();
                        yamlEl.innerHTML = `<pre class="yaml-viewer">${escapeHtml(yaml)}</pre>`;
                        yamlEl.dataset.loaded = 'true';
                    } catch (error) {
                        yamlEl.innerHTML = `<div class="yaml-viewer" style="color: var(--accent-red);">Error loading YAML: ${escapeHtml(error.message)}</div>`;
                    }
                }
            }

            // Load Events on demand
            if (tab === 'events' && selectedResource) {
                const eventsEl = document.getElementById('detail-events');
                if (eventsEl.dataset.loaded !== 'true') {
                    eventsEl.innerHTML = '<p style="color: var(--text-secondary);">Loading events...</p>';
                    try {
                        const ns = selectedResource.namespace || '';
                        const url = `/api/k8s/events?namespace=${encodeURIComponent(ns)}`;
                        const response = await fetch(url, { credentials: 'include' });
                        if (!response.ok) {
                            throw new Error(await response.text());
                        }
                        const data = await response.json();
                        // Filter events related to this resource
                        const resourceName = selectedResource.name;
                        const relatedEvents = (data.items || []).filter(e =>
                            (e.involvedObject && e.involvedObject.name === resourceName) ||
                            (e.message && e.message.includes(resourceName))
                        );

                        if (relatedEvents.length === 0) {
                            eventsEl.innerHTML = '<p style="color: var(--text-secondary);">No events found for this resource.</p>';
                        } else {
                            const eventsHtml = relatedEvents.map(e => `
                                <div class="event-item" style="padding: 8px; margin-bottom: 8px; border-left: 3px solid ${e.type === 'Warning' ? 'var(--accent-yellow)' : 'var(--accent-green)'}; background: var(--bg-secondary);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span style="font-weight: 500; color: ${e.type === 'Warning' ? 'var(--accent-yellow)' : 'var(--accent-green)'}">${escapeHtml(e.reason || 'Unknown')}</span>
                                        <span style="color: var(--text-secondary); font-size: 12px;">${escapeHtml(e.lastSeen || '')}</span>
                                    </div>
                                    <div style="color: var(--text-primary); font-size: 13px;">${escapeHtml(e.message || '')}</div>
                                    ${e.count > 1 ? `<div style="color: var(--text-secondary); font-size: 11px; margin-top: 4px;">Count: ${e.count}</div>` : ''}
                                </div>
                            `).join('');
                            eventsEl.innerHTML = eventsHtml;
                        }
                        eventsEl.dataset.loaded = 'true';
                    } catch (error) {
                        eventsEl.innerHTML = `<p style="color: var(--accent-red);">Error loading events: ${escapeHtml(error.message)}</p>`;
                    }
                }
            }

            // Load Related Pods on demand (for Services, Deployments, etc.)
            if (tab === 'pods' && selectedResource) {
                const podsEl = document.getElementById('detail-pods');
                if (podsEl.dataset.loaded !== 'true') {
                    podsEl.innerHTML = '<p style="color: var(--text-secondary);">Loading related pods...</p>';
                    try {
                        const ns = selectedResource.namespace || '';
                        // First, get the resource's YAML to extract the selector
                        const yamlUrl = `/api/k8s/${currentResource}?name=${encodeURIComponent(selectedResource.name)}&namespace=${encodeURIComponent(ns)}&format=yaml`;
                        const yamlResp = await fetch(yamlUrl, { credentials: 'include' });
                        if (!yamlResp.ok) {
                            throw new Error('Failed to fetch resource details');
                        }
                        const yamlText = await yamlResp.text();

                        // Parse selector from YAML (simple parsing for common patterns)
                        let labelSelector = '';
                        if (currentResource === 'services') {
                            // Services use spec.selector
                            const selectorMatch = yamlText.match(/spec:\s*[\s\S]*?selector:\s*\n((?:\s+\w+:\s*\S+\n?)+)/);
                            if (selectorMatch) {
                                const selectorLines = selectorMatch[1].trim().split('\n');
                                const selectors = [];
                                for (const line of selectorLines) {
                                    const match = line.trim().match(/^(\S+):\s*(.+)$/);
                                    if (match && !match[1].startsWith('match')) {
                                        selectors.push(`${match[1]}=${match[2].trim()}`);
                                    }
                                }
                                labelSelector = selectors.join(',');
                            }
                        } else {
                            // Deployments, StatefulSets, etc. use spec.selector.matchLabels
                            const matchLabelsMatch = yamlText.match(/matchLabels:\s*\n((?:\s+\w[\w.-]*:\s*\S+\n?)+)/);
                            if (matchLabelsMatch) {
                                const labelLines = matchLabelsMatch[1].trim().split('\n');
                                const selectors = [];
                                for (const line of labelLines) {
                                    const match = line.trim().match(/^([\w.-]+):\s*(.+)$/);
                                    if (match) {
                                        selectors.push(`${match[1]}=${match[2].trim()}`);
                                    }
                                }
                                labelSelector = selectors.join(',');
                            }
                        }

                        if (!labelSelector) {
                            podsEl.innerHTML = '<p style="color: var(--text-secondary);">No selector found for this resource.</p>';
                            podsEl.dataset.loaded = 'true';
                            return;
                        }

                        // Fetch pods with the label selector
                        const podsUrl = `/api/k8s/pods?namespace=${encodeURIComponent(ns)}&labelSelector=${encodeURIComponent(labelSelector)}`;
                        const podsResp = await fetchWithAuth(podsUrl);
                        const podsData = await podsResp.json();

                        if (!podsData.items || podsData.items.length === 0) {
                            podsEl.innerHTML = `
                                <p style="color: var(--text-secondary);">No pods found matching selector:</p>
                                <code style="display: block; padding: 8px; background: var(--bg-secondary); border-radius: 4px; font-size: 12px; margin-top: 8px;">${escapeHtml(labelSelector)}</code>
                            `;
                            podsEl.dataset.loaded = 'true';
                            return;
                        }

                        // Render pods table
                        let podsHtml = `
                            <div style="margin-bottom: 12px;">
                                <span style="color: var(--text-secondary); font-size: 12px;">Selector: </span>
                                <code style="padding: 2px 6px; background: var(--bg-secondary); border-radius: 3px; font-size: 11px;">${escapeHtml(labelSelector)}</code>
                                <span style="color: var(--text-secondary); font-size: 12px; margin-left: 12px;">${podsData.items.length} pod(s)</span>
                            </div>
                            <table class="data-table" style="font-size: 12px;">
                                <thead>
                                    <tr>
                                        <th>NAME</th>
                                        <th>STATUS</th>
                                        <th>READY</th>
                                        <th>RESTARTS</th>
                                        <th>NODE</th>
                                        <th>AGE</th>
                                        <th>ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        for (const pod of podsData.items) {
                            const statusColor = pod.status === 'Running' ? 'var(--accent-green)' :
                                               pod.status === 'Pending' ? 'var(--accent-yellow)' :
                                               pod.status === 'Failed' ? 'var(--accent-red)' : 'var(--text-secondary)';

                            podsHtml += `
                                <tr style="cursor: pointer;" onclick="viewPodFromDetail('${escapeHtml(pod.name)}', '${escapeHtml(pod.namespace || '')}')">
                                    <td style="color: var(--accent-blue);">${escapeHtml(pod.name)}</td>
                                    <td><span style="color: ${statusColor};">${escapeHtml(pod.status)}</span></td>
                                    <td>${escapeHtml(pod.ready || '-')}</td>
                                    <td>${escapeHtml(pod.restarts || '0')}</td>
                                    <td style="color: var(--text-secondary);">${escapeHtml(pod.node || '-')}</td>
                                    <td style="color: var(--text-secondary);">${escapeHtml(pod.age || '-')}</td>
                                    <td class="resource-actions" onclick="event.stopPropagation();">
                                        <button class="resource-action-btn" onclick="openLogViewerDirect('${escapeHtml(pod.name)}', '${escapeHtml(pod.namespace || '')}')" title="View Logs">ðŸ“‹</button>
                                    </td>
                                </tr>
                            `;
                        }

                        podsHtml += '</tbody></table>';
                        podsEl.innerHTML = podsHtml;
                        podsEl.dataset.loaded = 'true';
                    } catch (error) {
                        podsEl.innerHTML = `<p style="color: var(--accent-red);">Error loading related pods: ${escapeHtml(error.message)}</p>`;
                    }
                }
            }
        }

        // Helper function to view pod details from the related pods tab
        function viewPodFromDetail(podName, namespace) {
            closeDetail();
            // Switch to pods view and find the pod
            switchResource('pods');
            setTimeout(() => {
                // Try to find and highlight the pod in the table
                const rows = document.querySelectorAll('#table-body tr');
                for (const row of rows) {
                    const nameCell = row.querySelector('td:first-child');
                    if (nameCell && nameCell.textContent.trim() === podName) {
                        row.click();
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        break;
                    }
                }
            }, 500);
        }

        // Helper function to open log viewer directly (without row context)
        function openLogViewerDirect(podName, namespace) {
            openLogViewer(podName, namespace, ['default']);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function closeDetail() {
            document.getElementById('detail-modal').classList.remove('active');
            selectedResource = null;
        }

        function analyzeWithAI() {
            if (selectedResource) {
                const msg = `Analyze this ${currentResource.slice(0, -1)}: ${selectedResource.name} in namespace ${selectedResource.namespace || 'N/A'}. Current status: ${selectedResource.status || 'unknown'}`;
                document.getElementById('ai-input').value = msg;
                closeDetail();
                document.getElementById('ai-input').focus();
            }
        }

        // Override renderTable to include click handlers and cache data
        const originalRenderTable = renderTable;
        renderTable = function(resource, items) {
            cachedData = items || [];
            originalRenderTable(resource, items);
            addRowClickHandlers();
        };

        // ==========================================
        // Sidebar Toggle
        // ==========================================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const hamburger = document.getElementById('hamburger-btn');
            sidebarCollapsed = !sidebarCollapsed;

            sidebar.classList.toggle('collapsed', sidebarCollapsed);
            hamburger.classList.toggle('active', sidebarCollapsed);
            localStorage.setItem('k13d_sidebar_collapsed', sidebarCollapsed);
        }

        // ==========================================
        // Debug Mode (MCP Tool Calling)
        // ==========================================
        let debugLogs = [];

        function toggleDebugMode() {
            debugMode = !debugMode;
            const panel = document.getElementById('debug-panel');
            const toggle = document.getElementById('debug-toggle');

            panel.classList.toggle('active', debugMode);
            toggle.style.background = debugMode ? 'var(--accent-purple)' : 'transparent';
            localStorage.setItem('k13d_debug_mode', debugMode);
        }

        function addDebugLog(type, title, content) {
            if (!debugMode) return;

            const timestamp = new Date().toLocaleTimeString();
            debugLogs.push({ type, title, content, timestamp });

            const container = document.getElementById('debug-content');
            const entry = document.createElement('div');
            entry.className = `debug-entry ${type}`;
            entry.innerHTML = `
                <div class="debug-entry-header">
                    <span>${title}</span>
                    <span>${timestamp}</span>
                </div>
                <div class="debug-entry-body">${typeof content === 'object' ? JSON.stringify(content, null, 2) : content}</div>
            `;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function clearDebugLogs() {
            debugLogs = [];
            document.getElementById('debug-content').innerHTML = `
                <div style="color: var(--text-secondary); text-align: center; padding: 20px;">
                    Debug logs cleared. Tool calls will appear here.
                </div>
            `;
        }

        // ==========================================
        // AI Context Management
        // ==========================================
        function addToAIContext(item) {
            // Check if already exists
            const exists = aiContextItems.find(i => i.name === item.name && i.namespace === item.namespace);
            if (exists) return;

            aiContextItems.push({
                type: currentResource,
                name: item.name,
                namespace: item.namespace || '',
                data: item
            });

            renderContextChips();
        }

        function removeFromAIContext(index) {
            aiContextItems.splice(index, 1);
            renderContextChips();
        }

        function clearAIContext() {
            aiContextItems = [];
            renderContextChips();
        }

        function renderContextChips() {
            const container = document.getElementById('context-chips');
            if (aiContextItems.length === 0) {
                container.innerHTML = '<span style="font-size: 11px; color: var(--text-secondary);">Context: Click resources to add</span>';
                return;
            }

            container.innerHTML = aiContextItems.map((item, index) => `
                <span class="context-chip">
                    ${item.type.slice(0, -1)}: ${item.name}
                    <span class="remove" onclick="event.stopPropagation(); removeFromAIContext(${index})">Ã—</span>
                </span>
            `).join('') + `<span class="context-chip" style="background: var(--bg-tertiary); cursor: pointer;" onclick="clearAIContext()">Clear all</span>`;
        }

        function getContextForAI() {
            if (aiContextItems.length === 0) return '';

            return '\n\nContext from selected resources:\n' + aiContextItems.map(item => {
                return `[${item.type}] ${item.name}${item.namespace ? ` (ns: ${item.namespace})` : ''}: ${JSON.stringify(item.data)}`;
            }).join('\n');
        }

        // Update addRowClickHandlers - explicit button for AI context only
        function addRowClickHandlers() {
            document.querySelectorAll('#table-body tr').forEach((row, index) => {
                // Left click - show detail modal (but not if clicking on action buttons)
                row.onclick = (e) => {
                    // Ignore clicks on action buttons or their container
                    if (e.target.closest('.resource-actions') || e.target.closest('.resource-action-btn')) {
                        return;
                    }
                    const item = cachedData[index];
                    if (item) {
                        showResourceDetail(item);
                    }
                };

                // Add explicit + button for adding to context
                const firstCell = row.querySelector('td:first-child');
                if (firstCell && !firstCell.querySelector('.add-context-btn')) {
                    const btn = document.createElement('button');
                    btn.className = 'add-context-btn';
                    btn.textContent = '+';
                    btn.title = 'Add to AI context';
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        const item = cachedData[index];
                        if (item) {
                            addToAIContext(item);
                            // Visual feedback
                            btn.textContent = 'âœ“';
                            btn.style.background = 'var(--accent-green)';
                            setTimeout(() => {
                                btn.textContent = '+';
                                btn.style.background = '';
                            }, 1000);
                        }
                    };
                    firstCell.prepend(btn);
                    firstCell.prepend(document.createTextNode(' '));
                }
            });
        }

        // Override sendMessage to include context (uses agentic mode)
        const originalSendMessage = sendMessage;
        sendMessage = async function() {
            const input = document.getElementById('ai-input');
            let message = input.value.trim();
            if (!message || isLoading) return;

            // Add context if available
            const contextStr = getContextForAI();
            if (contextStr) {
                message += contextStr;
            }

            // Log request in debug mode
            addDebugLog('request', 'AI Request', { message, context: aiContextItems });

            isLoading = true;
            document.getElementById('send-btn').disabled = true;
            input.value = '';

            addMessage(message.split('\n\nContext from selected resources:')[0], true);

            // Use agentic mode
            await sendMessageAgentic(message);

            isLoading = false;
            document.getElementById('send-btn').disabled = false;
        };

        // ==========================================
        // Terminal Functions (xterm.js + WebSocket)
        // ==========================================
        let currentTerminal = null;
        let currentTerminalWs = null;
        let terminalFitAddon = null;

        function openTerminal(podName, namespace, container = '') {
            const modal = document.getElementById('terminal-modal');
            document.getElementById('terminal-pod-name').textContent = podName;
            document.getElementById('terminal-container-name').textContent = container || 'default';

            modal.classList.add('active');

            // Initialize xterm.js
            const terminalContainer = document.getElementById('terminal-container');
            terminalContainer.innerHTML = '';

            currentTerminal = new Terminal({
                cursorBlink: true,
                fontSize: 14,
                fontFamily: "'SF Mono', 'Monaco', 'Menlo', monospace",
                theme: {
                    background: '#1a1b26',
                    foreground: '#c0caf5',
                    cursor: '#c0caf5',
                    selection: '#33467c',
                    black: '#15161e',
                    red: '#f7768e',
                    green: '#9ece6a',
                    yellow: '#e0af68',
                    blue: '#7aa2f7',
                    magenta: '#bb9af7',
                    cyan: '#7dcfff',
                    white: '#a9b1d6'
                }
            });

            terminalFitAddon = new FitAddon.FitAddon();
            currentTerminal.loadAddon(terminalFitAddon);

            if (typeof WebLinksAddon !== 'undefined') {
                const webLinksAddon = new WebLinksAddon.WebLinksAddon();
                currentTerminal.loadAddon(webLinksAddon);
            }

            currentTerminal.open(terminalContainer);
            terminalFitAddon.fit();

            // Connect WebSocket
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/api/terminal/${namespace}/${podName}${container ? '?container=' + container : ''}`;

            currentTerminalWs = new WebSocket(wsUrl);

            currentTerminalWs.onopen = () => {
                currentTerminal.writeln('\x1b[32mConnected to pod: ' + podName + '\x1b[0m');
                currentTerminal.writeln('');

                const dims = terminalFitAddon.proposeDimensions();
                if (dims) {
                    currentTerminalWs.send(JSON.stringify({ type: 'resize', cols: dims.cols, rows: dims.rows }));
                }
            };

            currentTerminalWs.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'output') currentTerminal.write(msg.data);
                    else if (msg.type === 'error') currentTerminal.writeln('\x1b[31mError: ' + msg.data + '\x1b[0m');
                } catch (e) {
                    currentTerminal.write(event.data);
                }
            };

            currentTerminalWs.onclose = () => currentTerminal.writeln('\x1b[33m\r\nConnection closed.\x1b[0m');
            currentTerminalWs.onerror = (err) => {
                const isRemoteAccess = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
                currentTerminal.writeln('\x1b[31m');
                currentTerminal.writeln('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                currentTerminal.writeln('  WebSocket Connection Failed');
                currentTerminal.writeln('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                currentTerminal.writeln('\x1b[0m');
                if (isRemoteAccess) {
                    currentTerminal.writeln('\x1b[33mYou are accessing from a remote IP address.\x1b[0m');
                    currentTerminal.writeln('\x1b[33mWebSocket connections require additional configuration.\x1b[0m');
                    currentTerminal.writeln('');
                    currentTerminal.writeln('\x1b[36mSolution 1: Enable development mode\x1b[0m');
                    currentTerminal.writeln('  export K13D_DEV=true');
                    currentTerminal.writeln('');
                    currentTerminal.writeln('\x1b[36mSolution 2: Allow your origin explicitly\x1b[0m');
                    currentTerminal.writeln('  export K13D_WS_ALLOWED_ORIGINS="' + window.location.origin + '"');
                    currentTerminal.writeln('');
                    currentTerminal.writeln('\x1b[90mThen restart k13d server.\x1b[0m');
                } else {
                    currentTerminal.writeln('\x1b[33mFailed to connect to terminal WebSocket.\x1b[0m');
                    currentTerminal.writeln('\x1b[33mPlease check if the pod is running and accessible.\x1b[0m');
                }
            };

            currentTerminal.onData((data) => {
                if (currentTerminalWs && currentTerminalWs.readyState === WebSocket.OPEN) {
                    currentTerminalWs.send(JSON.stringify({ type: 'input', data: data }));
                }
            });

            window.addEventListener('resize', handleTerminalResize);
            currentTerminal.onResize(({ cols, rows }) => {
                if (currentTerminalWs && currentTerminalWs.readyState === WebSocket.OPEN) {
                    currentTerminalWs.send(JSON.stringify({ type: 'resize', cols, rows }));
                }
            });

            setTimeout(() => terminalFitAddon.fit(), 100);
        }

        function handleTerminalResize() { if (terminalFitAddon) terminalFitAddon.fit(); }

        function closeTerminal() {
            document.getElementById('terminal-modal').classList.remove('active');
            if (currentTerminalWs) { currentTerminalWs.close(); currentTerminalWs = null; }
            if (currentTerminal) { currentTerminal.dispose(); currentTerminal = null; }
            window.removeEventListener('resize', handleTerminalResize);
        }

        // ==========================================
        // Log Viewer Functions
        // ==========================================
        let currentLogPod = null, currentLogNamespace = null, currentLogContainer = null;
        let currentLogPods = []; // For multi-pod logging
        let logEventSource = null, logFollowMode = true, allLogs = [], ansiUp = null;
        let isMultiPodMode = false;
        let podColorMap = {};
        let hiddenPods = new Set();

        const POD_COLORS = [
            { name: 'blue', class: 'log-pod-0' },
            { name: 'green', class: 'log-pod-1' },
            { name: 'yellow', class: 'log-pod-2' },
            { name: 'purple', class: 'log-pod-3' },
            { name: 'cyan', class: 'log-pod-4' },
            { name: 'red', class: 'log-pod-5' },
            { name: 'teal', class: 'log-pod-6' },
            { name: 'orange', class: 'log-pod-7' }
        ];

        // Helper function to open log viewer from row button click
        function openLogViewerFromRow(btn, podName, namespace) {
            const row = btn.closest('tr');
            let containers = ['default'];
            if (row && row.dataset.containers) {
                try {
                    containers = JSON.parse(row.dataset.containers);
                } catch (e) {
                    console.warn('Failed to parse containers:', e);
                }
            }
            openLogViewer(podName, namespace, containers);
        }

        // Open multi-pod log viewer for a workload (deployment, replicaset, etc.)
        async function openMultiPodLogViewer(workloadName, namespace, labelSelector) {
            isMultiPodMode = true;
            currentLogNamespace = namespace;
            currentLogPods = [];
            podColorMap = {};
            hiddenPods.clear();

            document.getElementById('log-pod-name').textContent = workloadName;
            document.getElementById('log-container-name').textContent = '(multiple pods)';

            // Hide container select for multi-pod mode
            document.getElementById('log-container-select').style.display = 'none';

            document.getElementById('log-viewer-modal').classList.add('active');
            if (typeof AnsiUp !== 'undefined') { ansiUp = new AnsiUp(); ansiUp.use_classes = true; }
            // Ensure Follow button shows correct state
            document.getElementById('log-follow-btn').classList.toggle('active', logFollowMode);

            // Fetch pods for this workload
            try {
                const resp = await fetchWithAuth(`/api/k8s/pods?namespace=${namespace}&labelSelector=${encodeURIComponent(labelSelector)}`);
                const data = await resp.json();
                currentLogPods = (data.items || []).map(p => p.name);

                // Assign colors to pods
                currentLogPods.forEach((pod, idx) => {
                    podColorMap[pod] = POD_COLORS[idx % POD_COLORS.length];
                });

                // Show pod legend
                renderPodLegend();
                await loadMultiPodLogs();
            } catch (e) {
                document.getElementById('log-content').innerHTML = `<p style="color: var(--accent-red);">Error: ${e.message}</p>`;
            }
        }

        function renderPodLegend() {
            const legend = document.getElementById('log-pod-legend');
            if (currentLogPods.length <= 1) {
                legend.style.display = 'none';
                return;
            }

            legend.style.display = 'flex';
            legend.innerHTML = currentLogPods.map((pod, idx) => {
                const color = podColorMap[pod];
                const shortName = pod.length > 30 ? pod.substring(0, 27) + '...' : pod;
                const hidden = hiddenPods.has(pod) ? 'hidden' : '';
                return `<div class="log-pod-legend-item ${hidden}" onclick="togglePodVisibility('${pod}')" title="${pod}">
                    <span class="log-pod-legend-dot legend-${color.class.replace('log-', '')}"></span>
                    <span>${shortName}</span>
                </div>`;
            }).join('');
        }

        function togglePodVisibility(podName) {
            if (hiddenPods.has(podName)) {
                hiddenPods.delete(podName);
            } else {
                hiddenPods.add(podName);
            }
            renderPodLegend();
            // Re-render logs with filter
            filterLogs();
        }

        async function openLogViewer(podName, namespace, containers = []) {
            isMultiPodMode = false;
            currentLogPod = podName;
            currentLogNamespace = namespace;
            currentLogPods = [podName];
            podColorMap = { [podName]: POD_COLORS[0] };

            document.getElementById('log-pod-name').textContent = podName;
            document.getElementById('log-pod-legend').style.display = 'none';
            document.getElementById('log-container-select').style.display = '';

            // Filter out 'default' placeholder - use actual container names only
            const validContainers = containers.filter(c => c && c !== 'default');

            const containerSelect = document.getElementById('log-container-select');
            if (validContainers.length > 0) {
                containerSelect.innerHTML = validContainers.map((c, i) => `<option value="${c}" ${i === 0 ? 'selected' : ''}>${c}</option>`).join('');
                currentLogContainer = validContainers[0];
                document.getElementById('log-container-name').textContent = currentLogContainer;
            } else {
                // No containers specified - let the backend use the default container
                containerSelect.innerHTML = '<option value="">default</option>';
                currentLogContainer = '';
                document.getElementById('log-container-name').textContent = 'default';
            }

            document.getElementById('log-viewer-modal').classList.add('active');
            if (typeof AnsiUp !== 'undefined') { ansiUp = new AnsiUp(); ansiUp.use_classes = true; }
            // Ensure Follow button shows correct state
            document.getElementById('log-follow-btn').classList.toggle('active', logFollowMode);
            await loadLogs();
        }

        function switchLogContainer() {
            currentLogContainer = document.getElementById('log-container-select').value;
            document.getElementById('log-container-name').textContent = currentLogContainer;
            loadLogs();
        }

        async function loadMultiPodLogs() {
            const tailLines = document.getElementById('log-lines-select').value;
            const logContent = document.getElementById('log-content');
            logContent.innerHTML = '<p style="color: var(--text-secondary);">Loading logs from multiple pods...</p>';
            allLogs = [];

            try {
                // Fetch logs from all pods in parallel
                const logPromises = currentLogPods.map(async (pod) => {
                    try {
                        const url = `/api/pods/${currentLogNamespace}/${pod}/logs?tailLines=${Math.floor(tailLines / currentLogPods.length)}`;
                        const resp = await fetchWithAuth(url);
                        const text = await resp.text();
                        return text.split('\n').filter(l => l.trim()).map(line => ({ pod, line }));
                    } catch (e) {
                        return [{ pod, line: `[Error fetching logs: ${e.message}]` }];
                    }
                });

                const results = await Promise.all(logPromises);
                const allPodLogs = results.flat();

                // Sort by timestamp if present, otherwise keep order
                // For now, interleave logs from different pods
                logContent.innerHTML = '';
                allPodLogs.forEach(({ pod, line }) => {
                    appendLogLine(line, pod);
                });
                // Auto-scroll to bottom after loading logs
                logContent.scrollTop = logContent.scrollHeight;

            } catch (e) {
                logContent.innerHTML = `<p style="color: var(--accent-red);">Error loading logs: ${e.message}</p>`;
            }
        }

        async function loadLogs() {
            if (isMultiPodMode) {
                return loadMultiPodLogs();
            }

            const tailLines = document.getElementById('log-lines-select').value;
            const logContent = document.getElementById('log-content');
            logContent.innerHTML = '<p style="color: var(--text-secondary);">Loading logs...</p>';
            allLogs = [];
            if (logEventSource) { logEventSource.close(); logEventSource = null; }

            try {
                // Always use follow=false to get plain text response
                // SSE streaming is not properly supported in this fetch pattern
                let url = `/api/pods/${currentLogNamespace}/${currentLogPod}/logs?tailLines=${tailLines}&follow=false`;
                if (currentLogContainer) {
                    url += `&container=${currentLogContainer}`;
                }
                const resp = await fetchWithAuth(url);
                if (!resp.ok) {
                    const errorText = await resp.text();
                    throw new Error(errorText || `HTTP ${resp.status}`);
                }
                const text = await resp.text();
                logContent.innerHTML = '';
                if (text.trim()) {
                    text.split('\n').forEach(line => { if (line.trim()) appendLogLine(line, currentLogPod); });
                } else {
                    logContent.innerHTML = '<p style="color: var(--text-secondary);">No logs available for this pod.</p>';
                }
                // Auto-scroll to bottom after loading logs
                logContent.scrollTop = logContent.scrollHeight;
            } catch (e) {
                logContent.innerHTML = `<p style="color: var(--accent-red);">Error loading logs: ${e.message}</p>`;
            }
        }

        function appendLogLine(line, podName = null) {
            const logContent = document.getElementById('log-content');
            const pod = podName || currentLogPod;
            allLogs.push({ line, pod });

            const div = document.createElement('div');
            div.className = 'log-line';
            div.dataset.pod = pod;

            // Add pod color class for multi-pod mode
            const podColor = podColorMap[pod];
            if (podColor && currentLogPods.length > 1) {
                div.classList.add(podColor.class);
            }

            // Detect log level
            const lineLower = line.toLowerCase();
            if (lineLower.includes('error') || lineLower.includes('fatal') || lineLower.includes('panic')) {
                div.classList.add('error');
            } else if (lineLower.includes('warn') || lineLower.includes('warning')) {
                div.classList.add('warn');
            }

            // Add pod tag for multi-pod mode
            if (currentLogPods.length > 1) {
                const podTag = document.createElement('span');
                podTag.className = 'log-pod-tag';
                // Show short pod name (last part after last dash or first 15 chars)
                const shortPod = pod.split('-').slice(-2).join('-').substring(0, 15);
                podTag.textContent = shortPod;
                podTag.title = pod;
                div.appendChild(podTag);
            }

            // Create content wrapper
            const content = document.createElement('span');
            content.className = 'log-line-content';
            content.innerHTML = ansiUp ? ansiUp.ansi_to_html(line) : escapeHtml(line);
            div.appendChild(content);

            logContent.appendChild(div);
            if (logFollowMode) logContent.scrollTop = logContent.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function reloadLogs() { loadLogs(); }
        function toggleLogFollow() {
            logFollowMode = !logFollowMode;
            document.getElementById('log-follow-btn').classList.toggle('active', logFollowMode);
            loadLogs();
        }

        function filterLogs() {
            const searchTerm = document.getElementById('log-search-input').value.toLowerCase();
            let matchCount = 0;
            document.querySelectorAll('#log-content .log-line').forEach(lineEl => {
                const pod = lineEl.dataset.pod;
                const isPodHidden = hiddenPods.has(pod);
                const matchesSearch = searchTerm === '' || lineEl.textContent.toLowerCase().includes(searchTerm);
                const visible = !isPodHidden && matchesSearch;
                lineEl.style.display = visible ? 'flex' : 'none';
                if (visible && searchTerm) matchCount++;
            });
            document.getElementById('log-match-count').textContent = searchTerm ? `${matchCount} matches` : '';
        }

        function downloadLogs() {
            const logsText = allLogs.map(l => {
                if (typeof l === 'object') {
                    return currentLogPods.length > 1 ? `[${l.pod}] ${l.line}` : l.line;
                }
                return l;
            }).join('\n');
            const blob = new Blob([logsText], { type: 'text/plain' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            const filename = currentLogPods.length > 1 ? `${currentLogPods[0]}-multi-logs.txt` : `${currentLogPod}-logs.txt`;
            a.download = filename; a.click();
        }

        function closeLogViewer() {
            document.getElementById('log-viewer-modal').classList.remove('active');
            if (logEventSource) { logEventSource.close(); logEventSource = null; }
            allLogs = []; logFollowMode = true; // Reset to default (follow mode on)
        }

        // ==========================================
        // Metrics Functions
        // ==========================================
        let cpuChart = null, memoryChart = null, llmUsageChart = null;
        let metricsHistory = { cpu: [], memory: [], timestamps: [] };
        let llmUsageHistory = { requests: [], tokens: [], timestamps: [] };
        let metricsInterval = null;
        let metricsHistoryLoaded = false;
        let metricsTimeRangeMinutes = 5; // Default time range in minutes

        function setMetricsTimeRangeMinutes(minutes) {
            metricsTimeRangeMinutes = minutes;
            // Update active button state
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.minutes) === minutes) {
                    btn.classList.add('active');
                }
            });
            // Reload historical data with new time range
            loadHistoricalMetrics();
            loadLLMUsageStats();
        }

        function setMetricsTimeRange(hours) {
            metricsTimeRangeMinutes = hours * 60;
            // Update active button state
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.hours) === hours) {
                    btn.classList.add('active');
                }
            });
            // Reload historical data with new time range
            loadHistoricalMetrics();
            loadLLMUsageStats();
        }

        async function showMetrics() {
            document.getElementById('metrics-modal').classList.add('active');
            const metricsNsSelect = document.getElementById('metrics-namespace-select');
            metricsNsSelect.innerHTML = document.getElementById('namespace-select').innerHTML;

            // Load historical metrics first, then real-time
            await loadHistoricalMetrics();
            await loadMetrics();
            await loadLLMUsageStats();
            metricsInterval = setInterval(loadMetrics, 30000);
        }

        async function loadHistoricalMetrics() {
            try {
                const resp = await fetchWithAuth(`/api/metrics/history/cluster?minutes=${metricsTimeRangeMinutes}&limit=100`);
                const data = await resp.json();

                if (!data.error && data.items && data.items.length > 0) {
                    // Sort by timestamp ascending
                    const sorted = data.items.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                    metricsHistory.timestamps = sorted.map(m => {
                        const d = new Date(m.timestamp);
                        return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    });
                    metricsHistory.cpu = sorted.map(m => m.used_cpu_millis || 0);
                    metricsHistory.memory = sorted.map(m => m.used_memory_mb || 0);

                    metricsHistoryLoaded = true;
                    updateMetricsCharts();

                    // Update summary from latest metrics
                    const latest = sorted[sorted.length - 1];
                    if (latest) {
                        document.getElementById('metrics-total-cpu').textContent = `${latest.used_cpu_millis || 0}m`;
                        document.getElementById('metrics-total-memory').textContent = formatBytes((latest.used_memory_mb || 0) * 1024 * 1024);
                        document.getElementById('metrics-total-pods').textContent = latest.running_pods || 0;
                    }
                }
            } catch (e) {
                console.error('Failed to load historical metrics:', e);
            }
        }

        async function loadMetrics() {
            const namespace = document.getElementById('metrics-namespace-select').value;
            try {
                const url = namespace ? `/api/metrics/pods?namespace=${namespace}` : '/api/metrics/pods';
                const resp = await fetchWithAuth(url);
                const data = await resp.json();

                if (data.error) {
                    document.getElementById('metrics-total-cpu').textContent = 'N/A';
                    document.getElementById('metrics-total-memory').textContent = 'N/A';
                    document.getElementById('metrics-total-pods').textContent = 'N/A';
                    return;
                }

                const totalCpu = data.items?.reduce((sum, p) => sum + (p.cpu || 0), 0) || 0;
                const totalMem = data.items?.reduce((sum, p) => sum + (p.memory || 0), 0) || 0;

                document.getElementById('metrics-total-cpu').textContent = `${totalCpu.toFixed(0)}m`;
                document.getElementById('metrics-total-memory').textContent = formatBytes(totalMem * 1024 * 1024);
                document.getElementById('metrics-total-pods').textContent = data.items?.length || 0;

                // Only append to history if we haven't loaded historical data, or for real-time updates
                metricsHistory.timestamps.push(new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
                metricsHistory.cpu.push(totalCpu);
                metricsHistory.memory.push(totalMem);
                if (metricsHistory.timestamps.length > 100) {
                    metricsHistory.timestamps.shift(); metricsHistory.cpu.shift(); metricsHistory.memory.shift();
                }
                updateMetricsCharts();
                updateTopConsumers(data.items || []);
            } catch (e) { console.error('Failed to load metrics:', e); }
        }

        function updateMetricsCharts() {
            const opts = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#a9b1d6', maxTicksLimit: 10 },
                        grid: { color: '#414868' }
                    },
                    y: {
                        ticks: { color: '#a9b1d6' },
                        grid: { color: '#414868' },
                        beginAtZero: true
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            };

            const cpuCtx = document.getElementById('cpu-chart')?.getContext('2d');
            if (cpuCtx) {
                if (cpuChart) {
                    cpuChart.data.labels = metricsHistory.timestamps;
                    cpuChart.data.datasets[0].data = metricsHistory.cpu;
                    cpuChart.update();
                }
                else {
                    cpuChart = new Chart(cpuCtx, {
                        type: 'line',
                        data: {
                            labels: metricsHistory.timestamps,
                            datasets: [{
                                label: 'CPU (millicores)',
                                data: metricsHistory.cpu,
                                borderColor: '#7dcfff',
                                backgroundColor: 'rgba(125,207,255,0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                pointHoverRadius: 4
                            }]
                        },
                        options: opts
                    });
                }
            }
            const memCtx = document.getElementById('memory-chart')?.getContext('2d');
            if (memCtx) {
                if (memoryChart) {
                    memoryChart.data.labels = metricsHistory.timestamps;
                    memoryChart.data.datasets[0].data = metricsHistory.memory;
                    memoryChart.update();
                }
                else {
                    memoryChart = new Chart(memCtx, {
                        type: 'line',
                        data: {
                            labels: metricsHistory.timestamps,
                            datasets: [{
                                label: 'Memory (MB)',
                                data: metricsHistory.memory,
                                borderColor: '#bb9af7',
                                backgroundColor: 'rgba(187,154,247,0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                pointHoverRadius: 4
                            }]
                        },
                        options: opts
                    });
                }
            }
        }

        function updateTopConsumers(pods) {
            const topCpu = [...pods].sort((a, b) => (b.cpu || 0) - (a.cpu || 0)).slice(0, 5);
            document.getElementById('top-cpu-list').innerHTML = topCpu.map(p => `<div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid var(--border-color);"><span style="font-size:12px;">${escapeHtml(p.name)}</span><span style="font-size:12px;color:var(--accent-cyan);">${p.cpu||0}m</span></div>`).join('');
            const topMem = [...pods].sort((a, b) => (b.memory || 0) - (a.memory || 0)).slice(0, 5);
            document.getElementById('top-memory-list').innerHTML = topMem.map(p => `<div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid var(--border-color);"><span style="font-size:12px;">${escapeHtml(p.name)}</span><span style="font-size:12px;color:var(--accent-purple);">${formatBytes((p.memory||0)*1024*1024)}</span></div>`).join('');
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024, sizes = ['B', 'Ki', 'Mi', 'Gi'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // ==========================================
        // LLM Usage Functions
        // ==========================================
        async function loadLLMUsageStats() {
            try {
                const resp = await fetchWithAuth(`/api/llm/usage/stats?minutes=${metricsTimeRangeMinutes}`);
                const data = await resp.json();

                if (data.error) {
                    document.getElementById('llm-total-requests').textContent = 'N/A';
                    document.getElementById('llm-total-tokens').textContent = 'N/A';
                    document.getElementById('llm-prompt-tokens').textContent = 'N/A';
                    document.getElementById('llm-completion-tokens').textContent = 'N/A';
                    return;
                }

                // Update summary stats
                document.getElementById('llm-total-requests').textContent = formatNumber(data.total_requests || 0);
                document.getElementById('llm-total-tokens').textContent = formatNumber(data.total_tokens || 0);
                document.getElementById('llm-prompt-tokens').textContent = formatNumber(data.prompt_tokens || 0);
                document.getElementById('llm-completion-tokens').textContent = formatNumber(data.completion_tokens || 0);

                // Update time series chart
                if (data.hourly && data.hourly.length > 0) {
                    llmUsageHistory.timestamps = data.hourly.map(h => {
                        const d = new Date(h.hour);
                        return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    });
                    llmUsageHistory.requests = data.hourly.map(h => h.requests || 0);
                    llmUsageHistory.tokens = data.hourly.map(h => h.total_tokens || 0);
                    updateLLMUsageChart();
                }

                // Update model breakdown list
                if (data.by_model && data.by_model.length > 0) {
                    document.getElementById('llm-model-list').innerHTML = data.by_model.map(m =>
                        `<div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid var(--border-color);">
                            <span style="font-size:12px;">${escapeHtml(m.model || 'unknown')}</span>
                            <span style="font-size:12px;color:var(--accent-yellow);">${formatNumber(m.total_tokens || 0)} tokens</span>
                        </div>`
                    ).join('');
                } else {
                    document.getElementById('llm-model-list').innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No LLM usage data</p>';
                }
            } catch (e) {
                console.error('Failed to load LLM usage stats:', e);
                document.getElementById('llm-model-list').innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Failed to load data</p>';
            }
        }

        function updateLLMUsageChart() {
            const opts = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top', labels: { color: '#a9b1d6', font: { size: 10 } } },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: {
                        ticks: { color: '#a9b1d6', maxTicksLimit: 8 },
                        grid: { color: '#414868' }
                    },
                    y: {
                        type: 'linear',
                        position: 'left',
                        ticks: { color: '#e0af68' },
                        grid: { color: '#414868' },
                        beginAtZero: true,
                        title: { display: true, text: 'Requests', color: '#e0af68' }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        ticks: { color: '#9ece6a' },
                        grid: { drawOnChartArea: false },
                        beginAtZero: true,
                        title: { display: true, text: 'Tokens', color: '#9ece6a' }
                    }
                },
                interaction: { mode: 'nearest', axis: 'x', intersect: false }
            };

            const ctx = document.getElementById('llm-usage-chart')?.getContext('2d');
            if (ctx) {
                if (llmUsageChart) {
                    llmUsageChart.data.labels = llmUsageHistory.timestamps;
                    llmUsageChart.data.datasets[0].data = llmUsageHistory.requests;
                    llmUsageChart.data.datasets[1].data = llmUsageHistory.tokens;
                    llmUsageChart.update();
                } else {
                    llmUsageChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: llmUsageHistory.timestamps,
                            datasets: [
                                {
                                    label: 'Requests',
                                    data: llmUsageHistory.requests,
                                    borderColor: '#e0af68',
                                    backgroundColor: 'rgba(224,175,104,0.1)',
                                    fill: false,
                                    tension: 0.4,
                                    pointRadius: 2,
                                    pointHoverRadius: 4,
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'Tokens',
                                    data: llmUsageHistory.tokens,
                                    borderColor: '#9ece6a',
                                    backgroundColor: 'rgba(158,206,106,0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 0,
                                    pointHoverRadius: 4,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: opts
                    });
                }
            }
        }

        function closeMetrics() {
            document.getElementById('metrics-modal').classList.remove('active');
            if (metricsInterval) { clearInterval(metricsInterval); metricsInterval = null; }
            metricsHistoryLoaded = false;
            if (llmUsageChart) { llmUsageChart.destroy(); llmUsageChart = null; }
        }

        // ==========================================
        // Port Forward Functions
        // ==========================================
        let currentPfPod = null, currentPfNamespace = null, activePortForwards = [];

        function openPortForward(podName, namespace) {
            currentPfPod = podName; currentPfNamespace = namespace;
            document.getElementById('pf-target').value = `${namespace}/${podName}`;
            document.getElementById('portforward-modal').classList.add('active');
            loadActivePortForwards();
        }

        async function startPortForward() {
            const localPort = document.getElementById('pf-local-port').value;
            const remotePort = document.getElementById('pf-remote-port').value;
            if (!localPort || !remotePort) { alert('Please enter both ports'); return; }
            try {
                const resp = await fetchWithAuth('/api/portforward/start', { method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ namespace: currentPfNamespace, pod: currentPfPod, localPort: parseInt(localPort), remotePort: parseInt(remotePort) }) });
                const data = await resp.json();
                if (data.error) alert('Error: ' + data.error);
                else { showToast(`Port forward started: localhost:${localPort}`); loadActivePortForwards(); }
            } catch (e) { alert('Failed: ' + e.message); }
        }

        async function loadActivePortForwards() {
            try {
                const resp = await fetchWithAuth('/api/portforward/list');
                activePortForwards = (await resp.json()).items || [];
                renderPortForwardList();
            } catch (e) { console.error(e); }
        }

        function renderPortForwardList() {
            const list = document.getElementById('portforward-list');
            if (activePortForwards.length === 0) { list.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:20px;">No active port forwards</p>'; return; }
            list.innerHTML = activePortForwards.map(pf => `<div class="portforward-item"><div class="info"><div class="ports">localhost:${parseInt(pf.localPort)||0} â†’ :${parseInt(pf.remotePort)||0}</div><div class="target">${escapeHtml(pf.namespace)}/${escapeHtml(pf.pod)}</div></div><div class="status"><span class="status-dot ${pf.active?'active':'stopped'}"></span><button onclick="stopPortForward('${escapeHtml(pf.id)}')">Stop</button></div></div>`).join('');
        }

        async function stopPortForward(id) { try { await fetchWithAuth(`/api/portforward/${id}`, { method: 'DELETE' }); loadActivePortForwards(); } catch (e) { console.error(e); } }
        function closePortForward() { document.getElementById('portforward-modal').classList.remove('active'); }

        // ==========================================
        // AI-Dashboard Interactive Actions
        // ==========================================
        function executeAIAction(action) {
            switch(action.type) {
                case 'navigate': navigateToResource(action.target, action.params); break;
                case 'highlight': highlightResource(action.target, action.params); break;
                case 'open_terminal': openTerminal(action.params.pod, action.params.namespace, action.params.container); break;
                case 'show_logs': fetchPodContainers(action.params.pod, action.params.namespace).then(c => openLogViewer(action.params.pod, action.params.namespace, c)); break;
                case 'show_metrics': showMetrics(); break;
                case 'port_forward': openPortForward(action.params.pod, action.params.namespace); break;
            }
            showToast(`AI Action: ${action.type}`);
        }

        function navigateToResource(resource, params) {
            switchResource(resource);
            if (params.namespace) { document.getElementById('namespace-select').value = params.namespace; currentNamespace = params.namespace; }
            if (params.filter) { document.getElementById('filter-input').value = params.filter; }
            loadData();
        }

        function highlightResource(resourceType, params) {
            setTimeout(() => {
                document.querySelectorAll('#table-body tr').forEach(row => {
                    const nameCell = row.querySelector('td:first-child');
                    if (nameCell && nameCell.textContent.includes(params.name)) {
                        row.classList.add('ai-highlight');
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }, 500);
        }

        async function fetchPodContainers(podName, namespace) {
            try { const resp = await fetchWithAuth(`/api/k8s/pods/${namespace}/${podName}`); return (await resp.json()).containers || ['default']; }
            catch (e) { return ['default']; }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'ai-action-toast'; toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ==========================================
        // Enhanced renderTable with action buttons
        // ==========================================
        // Add ACTIONS column to workload types
        ['pods', 'deployments', 'daemonsets', 'statefulsets', 'replicasets'].forEach(resource => {
            if (!tableHeaders[resource].includes('ACTIONS')) {
                tableHeaders[resource].push('ACTIONS');
            }
        });

        // Override renderTableBody to add action buttons for pods
        const baseRenderTableBody = renderTableBody;
        renderTableBody = function(resource, items) {
            const headers = tableHeaders[resource];
            if (!items || items.length === 0) {
                document.getElementById('table-body').innerHTML =
                    `<tr><td colspan="${headers ? headers.length : 1}" style="text-align:center;padding:40px;">No ${resource} found</td></tr>`;
                return;
            }

            document.getElementById('table-body').innerHTML = items.map((item, index) => {
                switch (resource) {
                    case 'pods':
                        const podContainers = item.containers || ['default'];
                        const podContainersJson = JSON.stringify(podContainers).replace(/'/g, "\\'");
                        return `<tr data-index="${index}" data-containers='${podContainersJson}'><td>${item.name}</td><td>${item.namespace}</td><td>${item.ready}</td><td class="status-${item.status.toLowerCase()}">${item.status}</td><td>${item.restarts}</td><td>${item.age}</td><td>${item.ip || '-'}</td><td class="resource-actions"><button class="resource-action-btn terminal" onclick="event.stopPropagation(); openTerminal('${item.name}', '${item.namespace}')">Terminal</button><button class="resource-action-btn logs" onclick="event.stopPropagation(); openLogViewerFromRow(this, '${item.name}', '${item.namespace}')">Logs</button><button class="resource-action-btn portforward" onclick="event.stopPropagation(); openPortForward('${item.name}', '${item.namespace}')">Forward</button></td></tr>`;
                    case 'deployments':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.ready}</td><td>${item.upToDate || item.up_to_date || '-'}</td><td>${item.available || '-'}</td><td>${item.age}</td><td class="resource-actions"><button class="resource-action-btn logs" onclick="event.stopPropagation(); openMultiPodLogViewer('${item.name}', '${item.namespace}', '${item.selector || 'app=' + item.name}')">Logs</button></td></tr>`;
                    case 'daemonsets':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.desired || '-'}</td><td>${item.current || '-'}</td><td>${item.ready || '-'}</td><td>${item.age}</td><td class="resource-actions"><button class="resource-action-btn logs" onclick="event.stopPropagation(); openMultiPodLogViewer('${item.name}', '${item.namespace}', '${item.selector || 'app=' + item.name}')">Logs</button></td></tr>`;
                    case 'statefulsets':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.ready || '-'}</td><td>${item.age}</td><td class="resource-actions"><button class="resource-action-btn logs" onclick="event.stopPropagation(); openMultiPodLogViewer('${item.name}', '${item.namespace}', '${item.selector || 'app=' + item.name}')">Logs</button></td></tr>`;
                    case 'replicasets':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.desired || '-'}</td><td>${item.current || '-'}</td><td>${item.ready || '-'}</td><td>${item.age}</td><td class="resource-actions"><button class="resource-action-btn logs" onclick="event.stopPropagation(); openMultiPodLogViewer('${item.name}', '${item.namespace}', '${item.selector || 'app=' + item.name}')">Logs</button></td></tr>`;
                    case 'jobs':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.completions || '-'}</td><td>${item.duration || '-'}</td><td>${item.age}</td></tr>`;
                    case 'cronjobs':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.schedule || '-'}</td><td>${item.suspend ? 'Yes' : 'No'}</td><td>${item.active || 0}</td><td>${item.lastSchedule || '-'}</td></tr>`;
                    case 'services':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.type}</td><td>${item.clusterIP}</td><td>${item.ports}</td><td>${item.age}</td></tr>`;
                    case 'ingresses':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.class || item.ingressClass || '-'}</td><td>${item.hosts || '-'}</td><td>${item.address || '-'}</td><td>${item.age}</td></tr>`;
                    case 'networkpolicies':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.podSelector || '-'}</td><td>${item.age}</td></tr>`;
                    case 'configmaps':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.data || item.dataCount || 0}</td><td>${item.age}</td></tr>`;
                    case 'secrets':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.type || '-'}</td><td>${item.data || item.dataCount || 0}</td><td>${item.age}</td></tr>`;
                    case 'serviceaccounts':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.secrets || 0}</td><td>${item.age}</td></tr>`;
                    case 'persistentvolumes':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.capacity || '-'}</td><td>${item.accessModes || '-'}</td><td>${item.reclaimPolicy || '-'}</td><td class="status-${(item.status || '').toLowerCase()}">${item.status || '-'}</td><td>${item.claim || '-'}</td></tr>`;
                    case 'persistentvolumeclaims':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td class="status-${(item.status || '').toLowerCase()}">${item.status || '-'}</td><td>${item.volume || '-'}</td><td>${item.capacity || '-'}</td><td>${item.accessModes || '-'}</td></tr>`;
                    case 'nodes':
                        return `<tr data-index="${index}"><td>${item.name}</td><td class="status-${(item.status || '').toLowerCase()}">${item.status}</td><td>${item.roles || '-'}</td><td>${item.version || '-'}</td><td>${item.age}</td></tr>`;
                    case 'namespaces':
                        return `<tr data-index="${index}"><td>${item.name}</td><td class="status-active">${item.status}</td><td>${item.age}</td></tr>`;
                    case 'events':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.type}</td><td>${item.reason}</td><td>${item.message?.substring(0, 50) || '-'}...</td><td>${item.count}</td><td>${item.lastSeen}</td></tr>`;
                    case 'roles':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.age}</td></tr>`;
                    case 'rolebindings':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.role || '-'}</td><td>${item.age}</td></tr>`;
                    case 'clusterroles':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.age}</td></tr>`;
                    case 'clusterrolebindings':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.role || '-'}</td><td>${item.age}</td></tr>`;
                    case 'hpa':
                        return `<tr data-index="${index}"><td>${item.name}</td><td>${item.namespace}</td><td>${item.reference || '-'}</td><td>${item.minReplicas || '-'}</td><td>${item.maxReplicas || '-'}</td><td>${item.replicas || '-'}</td><td>${item.age}</td></tr>`;
                    default:
                        // Handle CRDs and unknown types with fallback
                        if (resource.startsWith('crd:')) {
                            return baseRenderTableBody.call(this, resource, [item]).replace(/<tbody[^>]*>|<\/tbody>/g, '');
                        }
                        // Generic fallback for any unhandled resource
                        const values = (headers || ['NAME']).map(h => {
                            const key = h.toLowerCase().replace(/[- ]/g, '');
                            return item[key] || item[h] || item.name || '-';
                        });
                        return `<tr data-index="${index}">${values.map(v => `<td>${v}</td>`).join('')}</tr>`;
                }
            }).join('');
            addRowClickHandlers();
        };

        // Add Metrics nav item
        setTimeout(() => {
            // Find Monitoring section by its title text
            const navSections = document.querySelectorAll('.nav-section');
            let monitoringSection = null;
            for (const section of navSections) {
                const title = section.querySelector('.nav-title');
                if (title && title.textContent.trim() === 'Monitoring') {
                    monitoringSection = section;
                    break;
                }
            }
            if (monitoringSection && !document.querySelector('[onclick="showMetrics()"]')) {
                const metricsItem = document.createElement('div');
                metricsItem.className = 'nav-item';
                metricsItem.onclick = showMetrics;
                metricsItem.innerHTML = '<span>Metrics</span>';
                const firstChild = monitoringSection.querySelector('.nav-item');
                if (firstChild) monitoringSection.insertBefore(metricsItem, firstChild);
            }
        }, 100);

        // Init
        init();
    </script>
</body>
</html>
