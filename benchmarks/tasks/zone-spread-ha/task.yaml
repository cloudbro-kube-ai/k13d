# Zone Spread HA Task
# Tests understanding of topology spread constraints for zone-aware scheduling

name: Zone-Spread High Availability
description: Configure topology spread constraints to distribute pods across availability zones
category: high-availability
difficulty: hard
tags:
  - ha
  - topology-spread
  - zones
  - scheduling

timeout: 15m

script:
  - prompt: |
      Configure topology spread constraints to ensure our applications are
      distributed across availability zones for disaster resilience.

      Setup in namespace 'zone-spread':
      - 'web-app' deployment (6 replicas) - should be evenly spread across zones
      - 'database' StatefulSet (3 replicas) - must have one replica per zone
      - 'background' deployment (4 replicas) - best effort zone spread

      Requirements:
      1. Update 'web-app' deployment with topologySpreadConstraints:
         - maxSkew: 1
         - topologyKey: topology.kubernetes.io/zone
         - whenUnsatisfiable: DoNotSchedule
         - labelSelector matching app=web-app

      2. Update 'database' StatefulSet with topologySpreadConstraints:
         - maxSkew: 1
         - topologyKey: topology.kubernetes.io/zone
         - whenUnsatisfiable: DoNotSchedule
         - labelSelector matching app=database

      3. Update 'background' deployment with topologySpreadConstraints:
         - maxSkew: 2
         - topologyKey: topology.kubernetes.io/zone
         - whenUnsatisfiable: ScheduleAnyway (soft constraint)
         - labelSelector matching app=background

      4. Also add a hostname spread constraint to 'web-app':
         - maxSkew: 1
         - topologyKey: kubernetes.io/hostname
         - whenUnsatisfiable: ScheduleAnyway

      Note: Actual zone distribution depends on cluster topology.
      Verification checks the spec configuration.

setup: setup.sh
verifier: verify.sh
cleanup: cleanup.sh

expect:
  - contains: "topologyspread|zone|maxskew|scheduling"
