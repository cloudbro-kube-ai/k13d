# Dockerfile for pre-built binary
# Use this when you have already built the binary locally
#
# Usage:
#   1. Build binary locally: go build -o k13d ./cmd/kube-ai-dashboard-cli/main.go
#   2. Build Docker image: docker build -f Dockerfile.prebuilt -t k13d:latest .

FROM alpine:3.21

# Install runtime dependencies, create non-root user, and set up directories
# - ca-certificates: For HTTPS connections
# - tzdata: For timezone support
# - curl: For health checks
# - bash: Required for AI agent shell commands
# - kubectl: Required for AI agent Kubernetes operations
RUN apk add --no-cache ca-certificates tzdata curl bash kubectl && \
    adduser -D -g '' k13d && \
    mkdir -p /home/k13d/.config/k13d /home/k13d/.kube /home/k13d/data && \
    chown -R k13d:k13d /home/k13d

# Copy pre-built binary (build locally first)
COPY --chmod=755 k13d /usr/local/bin/k13d

# Switch to non-root user
USER k13d
WORKDIR /home/k13d

# Environment variables for configuration
ENV K13D_PORT=8080 \
    K13D_AUTH_MODE=token \
    K13D_LLM_PROVIDER="" \
    K13D_LLM_MODEL="" \
    K13D_LLM_ENDPOINT="" \
    K13D_JWT_SECRET="" \
    K13D_DEFAULT_ROLE=admin

# Expose web UI port
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -sf http://localhost:${K13D_PORT}/api/health || exit 1

# Default command: run in web mode
ENTRYPOINT ["/usr/local/bin/k13d"]
CMD ["-web", "-port", "8080"]
